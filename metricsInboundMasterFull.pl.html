<!DOCTYPE html>
<html>
</body>
<pre>
#!/usr/bin/perl
use strict;
use warnings;
use DBI;
use MIME::Lite;
use Spreadsheet::WriteExcel;
use Spreadsheet::WriteExcel::Utility;
use Math::Round qw{:all};
use Config::IniFiles;

# Load configuration from the INI file
my $cfg = Config::IniFiles->new( -file => 'config.ini' )
    or die "Could not read config.ini: $!";

# Database credentials (MySQL)
my $mysql_user = $cfg->val( 'database_mysql', 'user' );
my $mysql_pass = $cfg->val( 'database_mysql', 'password' );
my $mysql_host = $cfg->val( 'database_mysql', 'host' );
my $mysql_db   = $cfg->val( 'database_mysql', 'database' );

# Database credentials (MS Sql)
my $sybase_user = $cfg->val( 'database_sybase', 'user' );
my $sybase_pass = $cfg->val( 'database_sybase', 'password' );
my $sybase_host = $cfg->val( 'database_sybase', 'host' );
my $sybase_port = $cfg->val( 'database_sybase', 'port' );
my $sybase_db   = $cfg->val( 'database_sybase', 'database' );

# Email server details
my $smtp_user   = $cfg->val( 'email', 'smtp_user' );
my $smtp_pass   = $cfg->val( 'email', 'smtp_password' );
my $smtp_domain = $cfg->val( 'email', 'smtp_domain' );
my $smtp_port   = $cfg->val( 'email', 'smtp_port' );

#Constants
use constant IVR_STATUS_GROUP   => 49;
use constant IVR_STATUS_CODE    => 1;
use constant IVR_STATUS_DETAIL  => 1;
use constant ABANDON_STATUS_GROUP => 49;
use constant ABANDON_STATUS_CODE  => 1;
use constant ABANDON_STATUS_DETAIL => 2;
use constant AGENT_NULL_STATUS_GROUP => 48;
use constant AGENT_NULL_STATUS_CODE  => 1;
use constant AGENT_NULL_STATUS_DETAIL => 1;
use constant ABANDON_WAIT_THRESHOLD => 15;

#Send up email
MIME::Lite->send('smtp', $smtp_domain, AuthUser => $smtp_user, AuthPass => $smtp_pass, Port => $smtp_port);
#MIME::Lite->send('smtp',"mail.frii.com",AuthUser=>$user, AuthPass=>$pass, Port=>587); # Old line
#MIME::Lite->send('smtp',"10.10.60.25", Port => 25); # Old line
BEGIN { $Class::Date::WARNINGS=0; }
use Class::Date qw(:errors date localdate gmdate now -DateParse -EnvC);
####USE metrics_inbound_Alex.pl 2011-11-28 1700 1 2
####Now include any remote subroutines we need###
require "/usr/local/bin/includes/excelCellFormatsInbound.pl";
require "/usr/local/bin/includes/dateFunctions.pl";
require "/usr/local/bin/includes/timeFunctions.pl";
require "/usr/local/bin/includes/sqlFunctions.pl";
require "/usr/local/bin/includes/employeeSearchFunctions.pl";
require "/usr/local/bin/includes/mySQLFunctions.pl";
require "/usr/local/bin/includes/emailFunctions.pl";

my $dbMySQL = DBI->connect("DBI:mysql:$mysql_db:$mysql_host", $mysql_user, $mysql_pass);
if (! $dbMySQL){
	print "Cannot connect to MySQL database!\n\n";
	die();
}
my $dbSQLV = DBI->connect("dbi:Sybase:server=$sybase_host:$sybase_port", $sybase_user, $sybase_pass, {PrintError => 0});
#my $dbSQLV = DBI->connect("dbi:Sybase:server=192.168.200.131:1433",'hastur','G4nd01f',{PrintError => 0}); # Old line
if (! $dbSQLV){
        	print "Connection to VocalCom failed!!\n\n";
        	die();
}
$dbSQLV->do("use $sybase_db");

while(my($reportID, $reportName, $reportTitle, $saveAsPath, $saveAsFileName, $endOfDayEmailID, $emailSubjectLineEOD, $includeDIDs, $timeZoneID, $startTime, $endTime) = $sth->fetchrow() ){
    my $pid = fork();
    if ($pid) {
        # parent
        if($i>=10){
            print "i = $i Sleeping for $maxSleep\n";
            sleep $maxSleep;
            $i = 0;
        }else{
            print "i = $i Sleeping for $regSleep\n";
            sleep $regSleep;
        }
        push(@childs, $pid);
    } elsif ($pid == 0) {
        # child
        print "Child Started $date\n";
        startReport(
            $reportID, $reportName, $reportTitle, $saveAsPath, $saveAsFileName,
            $endOfDayEmailID, $emailSubjectLineEOD, $includeDIDs, $timeZoneID,
            $startTime, $endTime, undef, $date, $skipData, undef, # Passing undef for logID initially
            $dbMySQL, $dbSQLV # Pass database handles
        );
        exit 0;
    } else {
        die "couldnt fork: $!\n";
    }
    $i++;
}
$sth->finish();


print "End of main program\n";
$dbSQLV->disconnect();
$dbMySQL->disconnect();
###End Program####
sub endofDay{
     my $date = $_[0];
     my $tmpDate = $date->ymd . " 22:00";
     if(($date->wday() == 1)||($date->wday() == 7)){
          $tmpDate  = $date->ymd . " 14:00";
     }

     #print "Endofday = $tmpDate";
     my $now = date now;
     $date = date $tmpDate;
     if($now>=$date){
          return 1;
     }else{
          return 0;
     }

}
sub checkReport{
     my $repid = $_[0];
     my $lockfile = &lockName($repid);
     if(-e $lockfile){
          return 0;
     }else{
          return 1;
     }
}
sub lockName{
     my $repid = $_[0];
     return "/var/log/locks/lock" . $repid;
}

sub startReport{
    my $reportID = shift;
    my $reportName = shift;
    my $reportTitle = shift;
    my $saveAsPath = shift;
    my $saveAsFileName = shift;
    my $emailID = shift;
    my $emailSubjectLine = shift;
    my $includeDIDs = shift;
    my $timeZoneID = shift;
    my $startTime = shift;
    my $endTime = shift;
    my $logID = shift;
    my $date = shift;
    my $skip = shift;
    my $chkBackup = shift;
    my $dbMySQL1 = shift; # Get the MySQL database handle
    my $dbSQLV1 = shift; # Get the Sybase database handle

    #   startReport($reportID, $reportName, $reportTitle, $saveAsPath, $saveAsFileName, $endOfDayEmailID, $emailSubjectLineEOD, $includeDIDs, $timeZoneID, $startTime, $endTime, $logID, $date, $skipData);
    #print "Start Report $date\n";
    # print "My Log id is $logID\n";
    # No need to reconnect here, using the passed handles

    my $logStartTime = date now;
    my $timestamp = $logStartTime->epoch;
    my $query = qq~Insert into inboundReportLog (reportID, Description, completed, currentDateTime) values($reportID, '$timestamp',0,curdate())~;
    my $st2 = $dbMySQL1->prepare($query);
    $st2->execute();
    $query = qq~Select ID from inboundReportLog where reportID = $reportID and Description = '$timestamp'~;
    $st2 = $dbMySQL1->prepare($query);
    $st2->execute();
    $logID =$st2->fetchrow();
    $query = qq~Update inboundReportLog set Description = 'Starting Fork', currentDateTime = curdate() where ID = $logID~;
#   print "$query\n";
    $st2 = $dbMySQL1->prepare($query);
    $st2->execute();
    #create lock file
    my $lockFile = lockName($reportID);
    open FILE,">$lockFile";
    #select FILE;
    #print "making fork\n";
    #putQoutes around DIDs
    $includeDIDs =~ s/\,/\'\,\'/g;
    $includeDIDs = "'$includeDIDs'";


    #gather Daily Dispo Data
    my $pullOut = checkArchive($reportID,$date);
    if($pullOut == 1){
        #pull data back out of the archive
        my $Monday = getPrevMonday($date);
        my $Sunday = getNextSunday($date);
        my $qdate1 = isodate($Monday);
        my $qdate2 = isodate($Sunday);
        my $query = qq~Insert into `TPS`.`inboundDisposition` (reportID, callDate, statusGroup, statusCode, statusDetail, count, talkTime, wrapTime, waitTime, emails, declinedEmail, emailOnFile)
                            Select reportID, callDate, statusGroup, statusCode, statusDetail, count, talkTime, wrapTime, waitTime, emails, declinedEmail, emailOnFile from `TPS`.`inboundDispositionArchive`
                            where callDate >= '$qdate1' and callDate <= '$qdate2' and reportID = $reportID~;
        $st2 = $dbMySQL1->prepare($query);
        $st2->execute(); #may be causing a duplicatoin error?
    }
    #gather distribution metrics data
    if($skip !=1){
        writeToLogTable($logID,"Starting Distribution Data colleciton",0);
        #print "Date is $date\n";
        gatherDistributionData($reportID, $includeDIDs, $startTime, $endTime, $dbSQLV1, $date);
        #print "Date is $date\n";
        gatherDispositionData($reportID, $includeDIDs, $date, $dbSQLV1,$startTime, $endTime);
        #print "Date is $date\n";
        #Gather Agent Dispo Data
        gatherAgentData($reportID, $includeDIDs, $date, $dbSQLV1,$startTime, $endTime);
      
    }



    writeToLogTable($logID,"Writing EXCEL file",0);
    my $fullFileName = "$saveAsPath/$saveAsFileName" . filedate($date) . ".xls";
    my $archivename = "$saveAsPath/used/";
    if($EOD == 1){
        $archivename = "$saveAsPath/endofday/";
    }
    my $emailFileName ="$saveAsFileName" . filedate($date) . ".xls";
    #print "Date is $date\n";
    #open excel file
    print "CReateExcelFile $reportName\n";
     my $workbook = Spreadsheet::WriteExcel->new($fullFileName);#open new workbook
    #print "Date is $date\n";
    createExcelFile($fullFileName, $reportTitle, $reportID, $timeZoneID, $date, $workbook);
    #print "Date is $date\n";
    #find the answer %
    my $qdate = &isodate($date);
    #print "Date is $date\n";
    my $query = qq~Select sum(agentCalls) as calls, sum(abandons) from    TPS.inboundDistribution where reportID = $reportID and dateTimeStart >= '$qdate' and dateTimeStart < adddate('$qdate', INTERVAL 1 DAY)~;
    #print "$query\n************\n";
    my $st2 = $dbMySQL1->prepare($query);
    my $ansPer = 100;
    if($st2->execute()){
        my ($calls, $aban) = $st2->fetchrow();
        $ansPer = nearest(.01,(checkDenom($calls,($calls+$aban)) * 100));
    #   print "******Make Answer Percentage\n$calls / ($calls+$aban) = $ansPer\n";
    }
    #print "Date is $date\n";
    moveDistribution2Archive($reportID, $date, $logID)
         if($EOD == 1);
    if($EOD == 1){
     #   print "Date is $date\n";
        moveDispData2Archive($reportID, $date, $logID);
    }else{
        #my $Monday = getPrevMonday($date);
        #my $Sunday = getNextSunday($date);
        #my $qdate1 = isodate($Monday);
        #my $qdate2 = isodate($Sunday);
        #moveDispData2Archive($reportID, $Sunday, $logID);
        #$query = "Delete from `TPS`.`inboundDisposition` where callDate >= '$qdate1' and callDate <= '$qdate2' and reportID = $reportID";
        #$st2 = $dbMySQL1->prepare($query);
        #$st2->execute(); #may be fixing a duplicatoin error?

    }
    if((isEndOfMonth($date) == 1) &&($EOD==1)){
        moveDispData2ArchiveEndOfMonth($reportID, $date, $logID);
    }
    moveAgentData2Archive($reportID, $date, $logID)
         if($EOD ==1);
    createEndOfWeekXLS($fullFileName, $reportTitle, $reportID, $timeZoneID, $date, $workbook, $EOD);

    #sleep 30;
    $workbook->close();
    writeToLogTable($logID,"All Done!",1);
    #kill lock file

    #Mail the report

    my $subject = "$emailSubjectLine Answer Percentage: " . $ansPer . "%";
    my $query = qq~
                    SELECT emailAddr FROM TPS.EmailCollAssoc a inner join
                    TPS.Email e on (e.ID=a.emailID)
                    where emailCollID = $emailID
                    ~;


    #print "$query\n************\n";
    my $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    my $to = "";
    while (my($emailAddr)=$sth->fetchrow()) {
        if(length($to)>0){
            $to = $to . "," . $emailAddr;
        }else{
            $to = $emailAddr;
        }
    }
    #$to = $to . ',abaker@press-one.com';
    my $sub = "Hourly Answer % Report";
    #die("subject=$subj; to=$to\n");
    my $body = "This is an automated Email\nIf you have any questions about this email or would like to stop receiving this email\nPlease contact your account manager\n";

    #abort the email if there is no sendto list
    if($noEmail==1)
    {
        $to = '';
    }
    if(length($to)>0){
        my $cc = '';
        #####TODO Uncomment the next two lines for when this report goes live!!
        &mailxls2secDelay($subject, $to, $cc, $body, 'reports@press-one.com', 'reports@press-one.com', $emailFileName, $fullFileName, 'application/vnd.ms-excel');
        sleep 8;
    }
    else{
        print "Skipping email \r\n";
    }
    $sth->finish();
    if($st2){
        $st2->finish();
    }
    close FILE;
    select STDOUT;
    unlink $lockFile;
    #move to used

    $dbSQLV1->disconnect(); # Disconnect the Sybase handle
    # No need to disconnect $dbMySQL1 here, as it's the same as $dbMySQL which is disconnected later

    `mv $fullFileName $archivename`;
    return 1;
}
sub moveDispData2ArchiveEndOfMonth {
    my $repID = shift;
    my $date = shift;
    my $logID = shift;

    my $qdate = isodate($date);

    # Move all disposition data for the report ID up to the given date
    my $insert_query = qq~
        INSERT INTO `TPS`.`inboundDispositionArchive` (
            reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
            talkTime, wrapTime, waitTime, emails, declinedEmail, emailOnFile
        )
        SELECT
            reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
            talkTime, wrapTime, waitTime, emails, declinedEmail, emailOnFile
        FROM `TPS`.`inboundDisposition`
        WHERE reportID = ? AND callDate <= ?
    ~;
    my $insert_sth = $dbMySQL1->prepare($insert_query);
    $insert_sth->execute($repID, $qdate);
    my $rows_inserted = $insert_sth->rows;
    $insert_sth->finish();

    writeToLogTable($logID, "Archived $rows_inserted Dispo Data up to $qdate", 0);
}
sub checkArchive{
     my $repID = $_[0];
     my $date = $_[1];
     my $now = date now;
     my $sunday = getPrevSunday($now);
     #check to see if this is older than the last sunday
     if($sunday > $date){
          return 1;
     }else{
          return 0;
     }
}
sub moveAgentData2Archive {
    my $repID = shift;
    my $date = shift;
    my $logID = shift;

    my $today = isodate($date);

    my $delete_archive_query = qq~
        DELETE FROM TPS.inboundAgentDispositionArchive
        WHERE reportID = ? AND callDate = ?
    ~;
    my $delete_archive_sth = $dbMySQL1->prepare($delete_archive_query);
    $delete_archive_sth->execute($repID, $today);
    $delete_archive_sth->finish();

    my $insert_archive_query = qq~
        INSERT INTO inboundAgentDispositionArchive
        SELECT * FROM `TPS`.`inboundAgentDisposition`
        WHERE reportID = ? AND callDate = ?
    ~;
    my $insert_archive_sth = $dbMySQL1->prepare($insert_archive_query);
    $insert_archive_sth->execute($repID, $today);
    my $rows_inserted = $insert_archive_sth->rows;
    $insert_archive_sth->finish();

    my $delete_current_query = qq~
        DELETE FROM `inboundAgentDisposition`
        WHERE reportID = ?
    ~;
    my $delete_current_sth = $dbMySQL1->prepare($delete_current_query);
    $delete_current_sth->execute($repID);
    $delete_current_sth->finish();

    writeToLogTable($logID, "Archived $rows_inserted Agent Data for $today", 0);
}
sub gatherAgentData {
    my $repID = shift;
    my $dids = shift;
    my $date = shift;
    my $db = shift;
    my $tomorrow = $date->add(days => 1); # More explicit date addition
    my $today = isodate($date);
    my $endday = isodate($tomorrow);

    # Eliminate today's data
    my $delete_query = qq~
        DELETE FROM `TPS`.`inboundAgentDisposition`
        WHERE calldate = ? AND reportID = ?
    ~;
    my $st1 = $dbMySQL1->prepare($delete_query);
    $st1->execute($today, $repID);
    $st1->finish();

    my $main_query = qq~
        SELECT LastAgent, [CallStatusGroup], [CallStatusNum], [CallStatusDetail],
               count(*),
               sum([ConvDuration] + ([TotalWaitDuration] - [WaitDuration])),
               sum([WrapupDuration]),
               sum([WaitDuration])
        FROM [HN_Ondata].[dbo].[ODCalls]
        WHERE lastcampaign IN ($dids)
          AND calllocaltime >= ?
          AND calllocaltime < ?
          AND lastagent > 0
        GROUP BY LastAgent, [CallStatusGroup], [CallStatusNum], [CallStatusDetail]
    ~;
    my $dbh = $db->prepare($main_query);
    $dbh->execute($today, $endday);

    # Gather data by call quality
    while (my ($agent, $statusgroup, $statusnum, $statusdetail, $count, $conv, $wrap, $wait) = $dbh->fetchrow()) {
        # Get email counts
        my $email_query = qq~
            SELECT sum(abs(isEmailEntered)) AS emails,
                   sum(CASE WHEN reasonNoEmailCollected = 'Already On File' THEN 1 ELSE 0 END) AS alreadyonfile,
                   sum(CASE WHEN reasonNoEmailCollected = 'Refused to Give it!' THEN 1 ELSE 0 END)
            FROM [TPS].[dbo].[agentActions] a
            INNER JOIN [HN_Ondata].[dbo].[ODCalls] b
                ON a.callindice = b.indice
            WHERE b.lastagent = ?
              AND b.CallStatusGroup = ?
              AND b.CallStatusNum = ?
              AND b.CallStatusDetail = ?
              AND b.LastCampaign IN ($dids)
              AND b.calllocaltime >= ?
              AND b.calllocaltime < ?
              AND isEmailEntered >= 0
        ~;
        my $db2 = $db->prepare($email_query);
        $db2->execute($agent, $statusgroup, $statusnum, $statusdetail, $today, $endday);
        my ($emails, $onfile, $refused) = $db2->fetchrow();

        # Initialize to 0 if undefined (no matching agentActions record)
        $emails = 0 if !defined($emails);
        $onfile = 0 if !defined($onfile);
        $refused = 0 if !defined($refused);

        # Insert into MySQL table
        my $insert_query = qq~
            INSERT INTO `TPS`.`inboundAgentDisposition` (
                reportID, agentID, callDate, statusGroup, statusCode,
                statusDetail, `count`, talkTime, wrapTime, waitTime,
                emails, declinedEmail, emailonFile
            )
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ~;
        my $sth = $dbMySQL1->prepare($insert_query);
        $sth->execute(
            $repID, $agent, $today, $statusgroup, $statusnum,
            $statusdetail, $count, $conv, $wrap, $wait,
            $emails, $refused, $onfile
        );
        $db2->finish();
        $sth->finish();
    }
    $dbh->finish();
}
sub moveDispData2Archive {
    my $repID = shift;
    my $date = shift;
    my $logID = shift;

    # Corrected day of week check for Sunday (Class::Date: Sunday is 0)
    if ($date->wday() == 0) {
        my $qdate = isodate($date);

        # Move all disposition data for the report ID up to the given date
        my $insert_query = qq~
            INSERT INTO `TPS`.`inboundDispositionArchive` (
                reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
                talkTime, wrapTime, waitTime, emails, declinedEmail, emailOnFile
            )
            SELECT
                reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
                talkTime, wrapTime, waitTime, emails, declinedEmail, emailOnFile
            FROM `TPS`.`inboundDisposition`
            WHERE reportID = ? AND callDate <= ?
        ~;
        my $insert_sth = $dbMySQL1->prepare($insert_query);
        $insert_sth->execute($repID, $qdate);
        my $rows_inserted = $insert_sth->rows;
        $insert_sth->finish();

        # Delete the moved data from the current table
        my $delete_query = qq~
            DELETE FROM `TPS`.`inboundDisposition`
            WHERE reportID = ? AND callDate <= ?
        ~;
        my $delete_sth = $dbMySQL1->prepare($delete_query);
        $delete_sth->execute($repID, $qdate);
        my $rows_deleted = $delete_sth->rows;
        $delete_sth->finish();

        writeToLogTable($logID, "Archived $rows_inserted Dispo Data up to $qdate and deleted $rows_deleted records", 0);
    } else {
        # Log if it's not Sunday and the archive process is skipped
        writeToLogTable($logID, "Skipping Dispo Data archive (not Sunday)", 0);
    }
}
sub gatherDispositionData {
    my $repID = shift;
    my $dids = shift;
    my $date = shift;
    my $db = shift;
    my $startTime = shift;
    my $endTime = shift;
    my $tmpdate = $date+'1D';
    my $nextday = isodate($tmpdate);
    my $today = isodate($date);
    my $beginTime = buildDateTimewithHour($date, $startTime);
    my $lastTime =  buildDateTimewithHour($date, $endTime + 1);

    # Clear out today's data
    my $delete_dispo_query = "Delete from `TPS`.`inboundDisposition` where reportID = ? and callDate = ?";
    my $sth_dispo_delete = $dbMySQL1->prepare($delete_dispo_query);
    unless ($sth_dispo_delete) {
        warn "Error preparing delete inboundDisposition: $dbMySQL1->errstr\n";
    } else {
        my $rows_deleted = $sth_dispo_delete->execute($repID, $today);
        warn "Error deleting from inboundDisposition: $sth_dispo_delete->errstr\n" if $sth_dispo_delete->errstr;
        $sth_dispo_delete->finish();
    }

    my $delete_sl_query = "Delete from `TPS`.inboundMetricsServiceLevel where reportID = ? and callDate = ?";
    my $sth_sl_delete = $dbMySQL1->prepare($delete_sl_query);
    unless ($sth_sl_delete) {
        warn "Error preparing delete inboundMetricsServiceLevel: $dbMySQL1->errstr\n";
    } else {
        my $rows_deleted = $sth_sl_delete->execute($repID, $today);
        warn "Error deleting from inboundMetricsServiceLevel: $sth_sl_delete->errstr\n" if $sth_sl_delete->errstr;
        $sth_sl_delete->finish();
    }

    my $delete_callback_query = "Delete from TPS.inbCallbacks where reportID=? and reportDate = ?";
    my $sth_callback_delete = $dbMySQL1->prepare($delete_callback_query);
    unless ($sth_callback_delete) {
        warn "Error preparing delete inbCallbacks: $dbMySQL1->errstr\n";
    } else {
        my $rows_deleted = $sth_callback_delete->execute($repID, $today);
        warn "Error deleting from inbCallbacks: $sth_callback_delete->errstr\n" if $sth_callback_delete->errstr;
        $sth_callback_delete->finish();
    }

    # Take care of IVR first
    my $ivr_query = qq~
        SELECT count(*)
        FROM ODCalls
        WHERE LastCampaign IN ($dids)
          AND (LastIVR IS NOT NULL AND LastIVR != '')
          AND LastAgent = 0
          AND CallType = 1
          AND Abandon = 0
          AND ivrduration > 0
          AND CallLocalTime < CAST(? AS DATETIME)
          AND CallLocalTime >= CAST(? AS DATETIME)
    ~;
    my $dbh_ivr = $db->prepare($ivr_query);
    my $ivr_count = 0;
    unless ($dbh_ivr) {
        warn "Error preparing IVR query: $db->errstr\n";
    } else {
        my $result = $dbh_ivr->execute($lastTime, $beginTime);
        warn "Error executing IVR query: $dbh_ivr->errstr\n" if !$result;
        $ivr_count = $dbh_ivr->fetchrow() if $result;
        $dbh_ivr->finish();
    }

    my $insert_ivr_query = qq~
        INSERT INTO `TPS`.`inboundDisposition` (
            reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
            talkTime, wrapTime, waitTime, emails, declinedEmail, emailonFile
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ~;
    my $sth_ivr_insert = $dbMySQL1->prepare($insert_ivr_query);
    unless ($sth_ivr_insert) {
        warn "Error preparing insert inboundDisposition (IVR): $dbMySQL1->errstr\n";
    } else {
        my $rows_inserted = $sth_ivr_insert->execute(
            $repID, $today, IVR_STATUS_GROUP, IVR_STATUS_CODE, IVR_STATUS_DETAIL,
            $ivr_count, 0, 0, 0, 0, 0, 0
        );
        warn "Error inserting inboundDisposition (IVR): $sth_ivr_insert->errstr\n" if !$rows_inserted;
        $sth_ivr_insert->finish();
    }

    # Abandons
    my $abandon_query = qq~
        SELECT count(*)
        FROM ODCalls
        WHERE abandon != 0
          AND waitduration > ?
          AND LastCampaign IN ($dids)
          AND CallLocalTime < CAST(? AS DATETIME)
          AND CallLocalTime >= CAST(? AS DATETIME)
          AND lastagent = 0
    ~;
    my $dbh_abandon = $db->prepare($abandon_query);
    my $abandon_count = 0;
    unless ($dbh_abandon) {
        warn "Error preparing abandon query: $db->errstr\n";
    } else {
        my $result = $dbh_abandon->execute(ABANDON_WAIT_THRESHOLD, $lastTime, $beginTime);
        warn "Error executing abandon query: $dbh_abandon->errstr\n" if !$result;
        $abandon_count = $dbh_abandon->fetchrow() if $result;
        $dbh_abandon->finish();
    }

    my $insert_abandon_query = qq~
        INSERT INTO `TPS`.`inboundDisposition` (
            reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
            talkTime, wrapTime, waitTime, emails, declinedEmail, emailonFile
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ~;
    my $sth_abandon_insert = $dbMySQL1->prepare($insert_abandon_query);
    unless ($sth_abandon_insert) {
        warn "Error preparing insert inboundDisposition (abandon): $dbMySQL1->errstr\n";
    } else {
        my $rows_inserted = $sth_abandon_insert->execute(
            $repID, $today, ABANDON_STATUS_GROUP, ABANDON_STATUS_CODE, ABANDON_STATUS_DETAIL,
            $abandon_count, 0, 0, 0, 0, 0, 0
        );
        warn "Error inserting inboundDisposition (abandon): $sth_abandon_insert->errstr\n" if !$rows_inserted;
        $sth_abandon_insert->finish();
    }

    my $update_sybase_query = qq~
        UPDATE ODCalls
        SET CallStatusGroup = ?, CallStatusNum = ?, CallStatusDetail = ?
        WHERE (CallStatusGroup IS NULL OR CallStatusGroup = 0)
          AND lastagent > 0
          AND lastcampaign IN ($dids)
    ~;
    my $sth_sybase_update = $dbSQLV->prepare($update_sybase_query);
    unless ($sth_sybase_update) {
        warn "Error preparing update ODCalls: $dbSQLV->errstr\n";
    } else {
        my $rows_updated = $sth_sybase_update->execute(AGENT_NULL_STATUS_GROUP, AGENT_NULL_STATUS_CODE, AGENT_NULL_STATUS_DETAIL);
        warn "Error updating ODCalls: $sth_sybase_update->errstr\n" if $sth_sybase_update->errstr;
        $sth_sybase_update->finish();
    }

    my $agent_dispo_query = qq~
        SELECT callstatusgroup, callstatusnum, callstatusdetail, count(*),
               sum(ConvDuration + ([TotalWaitDuration] - [WaitDuration])),
               sum(WrapupDuration), sum(WaitDuration)
        FROM ODCalls odc
        WHERE LastAgent > 0
          AND LastCampaign IN ($dids)
          AND CallLocalTime >= ?
          AND CallLocalTime < ?
        GROUP BY callstatusgroup, callstatusnum, callstatusdetail
    ~;
    my $dbh_agent_dispo = $db->prepare($agent_dispo_query);
    unless ($dbh_agent_dispo) {
        warn "Error preparing agent disposition query: $db->errstr\n";
    } else {
        my $result = $dbh_agent_dispo->execute($today, $nextday);
        warn "Error executing agent disposition query: $dbh_agent_dispo->errstr\n" if !$result;

        my ($totalCalls, $totalTalk, $totalWrap) = (0, 0, 0);
        while (my ($statusgroup, $statusnum, $statusdetail, $count, $conv, $wrap, $wait) = $dbh_agent_dispo->fetchrow()) {
            # Get email stats
            my $email_query = qq~
                SELECT sum(abs(isEmailEntered)) AS emails,
                       sum(CASE WHEN reasonNoEmailCollected = 'Already On File' THEN 1 ELSE 0 END) AS alreadyonfile,
                       sum(CASE WHEN reasonNoEmailCollected = 'Refused to Give it!' THEN 1 ELSE 0 END)
                FROM [TPS].[dbo].[agentActions] a
                INNER JOIN [HN_Ondata].[dbo].[ODCalls] b
                    ON a.callindice = b.indice
                WHERE b.CallStatusGroup = ?
                  AND b.CallStatusNum = ?
                  AND b.CallStatusDetail = ?
                  AND b.LastCampaign IN ($dids)
                  AND b.calllocaltime >= ?
                  AND b.calllocaltime < ?
                  AND isEmailEntered >= 0
            ~;
            my $db2 = $db->prepare($email_query);
            unless ($db2) {
                warn "Error preparing email query: $db->errstr\n";
            } else {
                my $email_result = $db2->execute($statusgroup, $statusnum, $statusdetail, $today, $nextday);
                warn "Error executing email query: $db2->errstr\n" if !$email_result;
                my ($emails, $onfile, $refused) = $db2->fetchrow() if $email_result;
                $emails = 0 if !defined($emails);
                $onfile = 0 if !defined($onfile);
                $refused = 0 if !defined($refused);
                $db2->finish();
            }

            $totalCalls += $count;
            $totalTalk += $conv;
            $totalWrap += $wrap;

            my $insert_agent_dispo_query = qq~
                INSERT INTO `TPS`.`inboundDisposition` (
                    reportID, callDate, statusGroup, statusCode, statusDetail, `count`,
                    talkTime, wrapTime, waitTime, emails, declinedEmail, emailonFile
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ~;
            my $sth_agent_dispo_insert = $dbMySQL1->prepare($insert_agent_dispo_query);
            unless ($sth_agent_dispo_insert) {
                warn "Error preparing insert inboundDisposition (agent): $dbMySQL1->errstr\n";
            } else {
                my $rows_inserted = $sth_agent_dispo_insert->execute(
                    $repID, $today, $statusgroup, $statusnum, $statusdetail, $count,
                    $conv, $wrap, $wait, $emails, $refused, $onfile
                );
                warn "Error inserting inboundDisposition (agent): $sth_agent_dispo_insert->errstr\n" if !$rows_inserted;
                $sth_agent_dispo_insert->finish();
            }
        }
        $dbh_agent_dispo->finish();
    }

    # GetHours for CPH
    my $cph_hours_query = qq~
        SELECT sum([Duration]) / 100 AS time
        FROM [HN_Ondata].[dbo].[ODActions]
        WHERE CallCampaign IN ($dids)
          AND state IN (0, 1, 2, 3, 7, 8, 9, 11, 96, 97, 98, 99, 100, 104, 110, 300, 302, 303, 304, 306, 308, 309, 310, 307, 100099, 100100, 100101)
          AND [ActionLocalTime] >= ?
          AND [ActionLocalTime] < ?
          AND [OriginatorID] > 0
    ~;
    my $dbh_cph_hours = $db->prepare($cph_hours_query);
    my $hours = 0;
    unless ($dbh_cph_hours) {
        warn "Error preparing CPH hours query: $db->errstr\n";
    } else {
        my $result = $dbh_cph_hours->execute($today, $nextday);
        warn "Error executing CPH hours query: $dbh_cph_hours->errstr\n" if !$result;
        $hours = $dbh_cph_hours->fetchrow() / 3600 if $result;
        $dbh_cph_hours->finish();
    }

    my $check_cph_exists_query = "SELECT count(*) FROM inboundCPHreport WHERE reportID = ? AND repDate = ?";
    my $sth_cph_check = $dbMySQL1->prepare($check_cph_exists_query);
    my $cph_exists = 0;
    unless ($sth_cph_check) {
        warn "Error preparing check CPH exists query: $dbMySQL1->errstr\n";
    } else {
        $sth_cph_check->execute($repID, $today);
        warn "Error executing check CPH exists query: $sth_cph_check->errstr\n" if $sth_cph_check->errstr;
        $cph_exists = $sth_cph_check->fetchrow() if $sth_cph_check;
        $sth_cph_check->finish();
    }

    my $cph_query;
    if ($cph_exists > 0) {
        $cph_query = "UPDATE inboundCPHreport SET calls = ?, hours = ?, talkTime = ?, wrapTime = ? WHERE reportID = ? AND repDate = ?";
    } else {
        $cph_query = "INSERT INTO inboundCPHreport (repDate, reportID, calls, hours, talkTime, wrapTime) VALUES (?, ?, ?, ?, ?, ?)";
    }
    my $sth_cph = $dbMySQL1->prepare($cph_query);
    unless ($sth_cph) {
        warn "Error preparing CPH insert/update query: $dbMySQL1->errstr\n";
    } else {
        my $rows_affected;
        if ($cph_exists > 0) {
            $rows_affected = $sth_cph->execute($totalCalls, $hours, $totalTalk, $totalWrap, $repID, $today);
            warn "Error updating inboundCPHreport: $sth_cph->errstr\n" if !$rows_affected;
        } else {
            $rows_affected = $sth_cph->execute($today, $repID, $totalCalls, $hours, $totalTalk, $totalWrap);
            warn "Error inserting inboundCPHreport: $sth_cph->errstr\n" if !$rows_affected;
        }
        $sth_cph->finish();
    }

    # Fill Service Levels
    my $sl_query = qq~
        SELECT sum(CASE WHEN waitduration <= 25 THEN 1 ELSE 0 END) AS a25,
               sum(CASE WHEN waitduration <= 30 THEN 1 ELSE 0 END) AS a30,
               sum(CASE WHEN waitduration <= 45 THEN 1 ELSE 0 END) AS a45,
               sum(CASE WHEN waitduration <= 60 THEN 1 ELSE 0 END) AS a60,
               count(*) AS total
        FROM [HN_Ondata].[dbo].[ODCalls] odc
        WHERE lastagent > 0
          AND odc.LastCampaign IN ($dids)
          AND calllocaltime >= ?
          AND calllocaltime < ?
    ~;
    my $dbh_sl = $db->prepare($sl_query);
    unless ($dbh_sl) {
        warn "Error preparing service level query: $db->errstr\n";
        # Consider returning or throwing an exception here if this is critical
        return; # Added return
    } else {
        my $sl_result = $dbh_sl->execute($today, $nextday);
        warn "Error executing service level query: $dbh_sl->errstr\n" if !$sl_result;
        my ($a25, $a30, $a45, $a60, $atot) = $dbh_sl->fetchrow() if $sl_result;
        $dbh_sl->finish();

        my ($n25, $n30, $n45, $n60, $denom);
        if ($atot > 0) {
            ($n25, $n30, $n45, $n60, $denom) = ($a25, $a30, $a45, $a60, $atot);
            $a25 = $a25 / $atot if $a25 > 0;
            $a30 = $a30 / $atot if $a30 > 0;
            $a45 = $a45 / $atot if $a45 > 0;
            $a60 = $a60 / $atot;
        } else {
            $a25 = 0;
            $a30 = 0;
            $a45 = 0;
            $a60 = 0;
        }

        my $delete_sl_insert_query = "Delete from inboundMetricsServiceLevel where reportID = ? and callDate = ?";
        my $sth_delete_sl_insert = $dbMySQL1->prepare($delete_sl_insert_query);
         unless ($sth_delete_sl_insert) {
            warn "Error preparing delete service level insert query: $dbMySQL1->errstr\n";
            return; # Added return
        } else {
            $sth_delete_sl_insert->execute($repID, $today);
            warn "Error deleting from inboundMetricsServiceLevel: $sth_delete_sl_insert->errstr\n" if $sth_delete_sl_insert->errstr;
            $sth_delete_sl_insert->finish();
        }

        $a25 = testNumber($a25);
        $a30 = testNumber($a30);
        $a45 = testNumber($a45);
        $a60 = testNumber($a60);
        $denom = testNumber($denom);
        $n25 = testNumber($n25);
        $n30 = testNumber($n30);
        $n45 = testNumber($n45);
        $n60 = testNumber($n60);

        my $insert_sl_query = "Insert into inboundMetricsServiceLevel (reportID, callDate, answerPercent25, answerPercent30, answerPercent45, answerPercent60, denominator, 25n, 30n, 45n, 60n) Values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        my $sth_insert_sl = $dbMySQL1->prepare($insert_sl_query);
        unless ($sth_insert_sl) {
            warn "Error preparing insert service level query: $dbMySQL1->errstr\n";
            return; # Added return
        } else {
            my $rows_inserted = $sth_insert_sl->execute($repID, $today, $a25, $a30, $a45, $a60, $denom, $n25, $n30, $n45, $n60);
            warn "Error inserting into inboundMetricsServiceLevel: $sth_insert_sl->errstr\n" if !$rows_inserted;
            $sth_insert_sl->finish();
        }
    }

    # Gather uncontacted callbacks
    my $callback_query = qq~
        SELECT convert(char(20), a.CallLocalTime, 120), a.OutTel, b.StatusText
        FROM [HN_Ondata].[dbo].[ODCalls] a
        INNER JOIN HN_ADMIN.dbo.CallStatus b
            ON a.CallStatusGroup = b.StatusGroup
            AND a.CallStatusNum = b.StatusCode
            AND a.CallStatusDetail = b.StatusDetail
        WHERE CallType != 1
          AND a.LastCampaign IN ($dids)
          AND a.calllocaltime >= ?
          AND a.calllocaltime < ?
          AND ((a.CallStatusNum = 70) OR (a.CallStatusNum = 69 AND a.CallStatusDetail = 3))
    ~;
    my $dbh_callback = $db->prepare($callback_query);
    unless ($dbh_callback) {
        warn "Error preparing callback query: $db->errstr\n";
        return; # Added return
    } else {
        $dbh_callback->execute($today, $nextday);
        warn "Error executing callback query: $dbh_callback->errstr\n" if $dbh_callback->errstr;

        while (my ($callTime, $outTel, $statusText) = $dbh_callback->fetchrow()) {
            my $mysql_callTime = isodatetime($callTime);
            my $insert_callback_query = qq~
                INSERT INTO TPS.inbCallbacks (tel, reportID, callLocalTime, reportDate, statusText)
                VALUES (?, ?, ?, ?, ?)
            ~;
            my $sth_insert_callback = $dbMySQL1->prepare($insert_callback_query);
            unless ($sth_insert_callback) {
                warn "Error preparing insert callback query: $dbMySQL1->errstr\n";
                 #  Don't return here, try to process other callbacks
            } else {
                my $callback_insert_result = $sth_insert_callback->execute($outTel, $repID, $mysql_callTime, $today, $statusText);
                warn "Error inserting callback: $sth_insert_callback->errstr\n" if !$callback_insert_result;
                $sth_insert_callback->finish();
            }
        }
        $dbh_callback->finish();
    }
}
sub gatherDispositionDataBackUp
{
    my $repID = $_[0];
    my $dids = $_[1];
    my $date = $_[2];
    my $db = $_[3];
    my $startTime = $_[4];
    my $endTime = $_[5];
    my $tmpdate = $date+'1D';
    my $nextday = isodate($tmpdate);
    my $today = isodate($date);
    my $beginTime = buildDateTimewithHour($date, $startTime);
    my $lastTime =  buildDateTimewithHour($date, $endTime + 1);
    #clear out todays data
    my $delete_dispo_query = "Delete from `TPS`.`inboundDisposition` where reportID = ? and callDate = ?";
    my $sth_dispo_delete = $dbMySQL1->prepare($delete_dispo_query);
    unless ($sth_dispo_delete) {
        warn "Error preparing delete inboundDisposition (backup): $dbMySQL1->errstr\n";
    } else {
        my $rows_deleted = $sth_dispo_delete->execute($repID, $today);
        warn "Error deleting from inboundDisposition (backup): $sth_dispo_delete->errstr\n" if $sth_dispo_delete->errstr;
        $sth_dispo_delete->finish();
    }
    #$query = "Delete from `TPS`.inboundMetricsServiceLevel where reportID = $repID and callDate = '$today'";
    #$sth = $dbMySQL1->prepare($query);
    #$sth->execute();
    #take care of IVR first
    my $ivr_query = qq~
        Select count(*)
        from ODCalls
        where LastCampaign in (?)
          and (LastIVR is not null and LastIVR != '')
          and LastAgent = 0
          and CallType = 1
          and Abandon = 0
          and ivrduration > 0
          and CallLocalTime < cast(? as datetime)
          and CallLocalTime >= cast(? as datetime)
    ~;
    my $dbh_ivr = $db->prepare($ivr_query);
    my $IVR = 0;
    unless ($dbh_ivr) {
        warn "Error preparing IVR query (backup): $db->errstr\n";
    } else {
        my $ivr_result = $dbh_ivr->execute($prjid, $lastTime, $beginTime);
        warn "Error executing IVR query (backup): $dbh_ivr->errstr\n" if !$ivr_result;
        $IVR = $dbh_ivr->fetchrow() if $ivr_result;
        $dbh_ivr->finish();
    }
    #$query = qq~insert ignore into `TPS`.`inboundDisposition` (reportID, callDate, statusGroup, statusCode, statusDetail, `count`, talkTime, wrapTime, waitTime, emails, declinedEmail, emailonFile)
    #           values($repID, '$today', 49 ,  1, 1, $IVR, 0, 0, 0, 0,0,0)~;
    my $update_ivr_query = qq~
        update `TPS`.`inboundDisposition`
        set `count` = ?
        where reportID = ?
          and callDate = ?
          and statusGroup = 49
          and statusDetail = 1
          and statusCode = 1
    ~;
    my $sth_update_ivr = $dbMySQL1->prepare($update_ivr_query);
    unless ($sth_update_ivr) {
        warn "Error preparing update inboundDisposition (IVR backup): $dbMySQL1->errstr\n";
    } else {
        my $rows_updated = $sth_update_ivr->execute($IVR, $repID, $today);
        warn "Error updating inboundDisposition (IVR backup): $sth_update_ivr->errstr\n" if !$rows_updated;
        $sth_update_ivr->finish();
    }
    #abandons
    my $abandon_query = qq~
        Select count(*)
        from ODCalls
        where abandon != 0
          and waitduration > 15
          and LastCampaign in ($dids)
          and CallLocalTime < cast(? as datetime)
          and CallLocalTime >= cast(? as datetime)
          and lastagent = 0
    ~;
    my $dbh_abandon = $db->prepare($abandon_query);
    my $abandons = 0;
    unless ($dbh_abandon) {
        warn "Error preparing abandon query (backup): $db->errstr\n";
    } else {
        my $abandon_result = $dbh_abandon->execute($lastTime, $beginTime);
        warn "Error executing abandon query (backup): $dbh_abandon->errstr\n" if !$abandon_result;
        $abandons = $dbh_abandon->fetchrow() if $abandon_result;
        $dbh_abandon->finish();
    }
    #$query = qq~insert ignore into `TPS`.`inboundDisposition` (reportID, callDate, statusGroup, statusCode, statusDetail, `count`, talkTime, wrapTime, waitTime, emails, declinedEmail, emailonFile)
    # #           values($repID, '$today', 49 ,  1, 2, $abandons, 0, 0, 0, 0,0,0)~;
    my $update_abandon_query = qq~
        update `TPS`.`inboundDisposition`
        set `count` = ?
        where reportID = ?
          and callDate = ?
          and statusGroup = 49
          and statusDetail = 1
          and statusCode = 2
    ~;
    my $sth_update_abandon = $dbMySQL1->prepare($update_abandon_query);
    unless ($sth_update_abandon) {
        warn "Error preparing update inboundDisposition (abandon backup): $dbMySQL1->errstr\n";
    } else {
        my $rows_updated = $sth_update_abandon->execute($abandons, $repID, $today);
        warn "Error updating inboundDisposition (abandon backup): $sth_update_abandon->errstr\n" if !$rows_updated;
        $sth_update_abandon->finish();
    }
    my $update_odcalls_query = "Update ODCalls set CallStatusGroup = 48, CallStatusNum = 1, CallStatusDetail = 1 where  (CallStatusGroup is null or CallStatusGroup = 0) and lastagent > 0 and lastcampaign in ($dids)";
    my $sth_update_odcalls = $dbSQLV->prepare($update_odcalls_query);
    unless ($sth_update_odcalls) {
        warn "Error preparing update ODCalls (backup): $dbSQLV->errstr\n";
    } else {
        my $rows_updated = $sth_update_odcalls->execute();
        warn "Error updating ODCalls (backup): $sth_update_odcalls->errstr\n" if $sth_update_odcalls->errstr;
        $sth_update_odcalls->finish();
    }
    my $agent_dispo_query = qq~
        Select callstatusgroup, callstatusnum, callstatusdetail, count(*),
               sum(ConvDuration + ([TotalWaitDuration] - [WaitDuration])),
               sum(WrapupDuration), sum(WaitDuration)
        from ODCalls odc
        where LastAgent > 0
          and LastCampaign in ($dids)
          and CallLocalTime >= ?
          and CallLocalTime < ?
        group by callstatusgroup, callstatusnum, callstatusdetail
    ~;
    my $dbh_agent_dispo = $db->prepare($agent_dispo_query);
    unless ($dbh_agent_dispo) {
        warn "Error preparing agent disposition query (backup): $db->errstr\n";
    } else {
        my $agent_dispo_result = $dbh_agent_dispo->execute($today, $nextday);
        warn "Error executing agent disposition query (backup): $dbh_agent_dispo->errstr\n" if !$agent_dispo_result;
        while (my ($statusgroup, $statusnum, $statusdetail, $count, $conv, $wrap, $wait) = $dbh_agent_dispo->fetchrow()) {
            #get email stats
            my $email_query = qq~
                SELECT sum(abs(isEmailEntered)) as emails,
                       sum(case when reasonNoEmailCollected = 'Already On File' then 1 else 0 end) as alreadyonfile,
                       sum(case when reasonNoEmailCollected = 'Refused to Give it!' then 1 else 0 end)
                FROM [TPS].[dbo].[agentActions] a
                inner join [HN_Ondata].[dbo].[ODCalls] b
                    on a.callindice = b.indice
                where b.CallStatusGroup = ?
                  and b.CallStatusNum = ?
                  and b.CallStatusDetail = ?
                  and b.LastCampaign in ($dids)
                  and calllocaltime >= ?
                  and calllocaltime < ?
                  and isEmailEntered >= 0
            ~;
            my $dbh_email = $db->prepare($email_query);
            unless ($dbh_email) {
                warn "Error preparing email query (backup): $db->errstr\n";
            } else {
                my $email_result = $dbh_email->execute($statusgroup, $statusnum, $statusdetail, $today, $nextday);
                warn "Error executing email query (backup): $dbh_email->errstr\n" if !$email_result;
                my ($emails, $onfile, $refused) = $dbh_email->fetchrow();
                $emails = 0 if !defined($emails));
                $onfile = 0 if !defined($onfile));
                $refused = 0 if !defined($refused));
                $dbh_email->finish();
            }
            my $check_dispo_exists_query = qq~
                select count(*)
                from `TPS`.`inboundDisposition`
                where reportID = ?
                  and callDate = ?
                  and statusGroup = ?
                  and statusDetail = ?
                  and statusCode = ?
            ~;
            my $sth_check_dispo = $dbMySQL1->prepare($check_dispo_exists_query);
            unless ($sth_check_dispo) {
                warn "Error preparing check inboundDisposition exists (backup): $dbMySQL1->errstr\n";
            } else {
                $sth_check_dispo->execute($repID, $today, $statusgroup, $statusdetail, $statusnum);
                warn "Error executing check inboundDisposition exists (backup): $sth_check_dispo->errstr\n" if $sth_check_dispo->errstr;
                my $dispo_exists = $sth_check_dispo->fetchrow();
                $sth_check_dispo->finish();

                if ($dispo_exists > 0) {
                    my $update_agent_dispo_query = qq~
                        update `TPS`.`inboundDisposition`
                        set `count` = `count` + ?,
                            talkTime = talkTime + ?,
                            wrapTime = wrapTime + ?,
                            waitTime = waitTime + ?,
                            emails = emails + ?,
                            declinedEmail = declinedEmail + ?,
                            emailonFile = emailonFile + ?
                        where reportID = ?
                          and callDate = ?
                          and statusGroup = ?
                          and statusDetail = ?
                          and statusCode = ?
                    ~;
                    my $sth_update_agent_dispo = $dbMySQL1->prepare($update_agent_dispo_query);
                    unless ($sth_update_agent_dispo) {
                        warn "Error preparing update inboundDisposition (agent backup): $dbMySQL1->errstr\n";
                    } else {
                        my $rows_updated = $sth_update_agent_dispo->execute(
                            $count, $conv, $wrap, $wait, $emails, $refused, $onfile,
                            $repID, $today, $statusgroup, $statusdetail, $statusnum
                        );
                        warn "Error updating inboundDisposition (agent backup): $sth_update_agent_dispo->errstr\n" if !$rows_updated;
                        $sth_update_agent_dispo->finish();
                    }
                } else {
                    my $insert_agent_dispo_query = qq~
                        insert into `TPS`.`inboundDisposition` (
                            reportID, callDate, statusGroup, statusCode, statusDetail,
                            `count`, talkTime, wrapTime, waitTime, emails, declinedEmail, emailonFile
                        )
                        values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ~;
                    my $sth_insert_agent_dispo = $dbMySQL1->prepare($insert_agent_dispo_query);
                    unless ($sth_insert_agent_dispo) {
                        warn "Error preparing insert inboundDisposition (agent backup): $dbMySQL1->errstr\n";
                    } else {
                        my $rows_inserted = $sth_insert_agent_dispo->execute(
                            $repID, $today, $statusgroup, $statusnum, $statusdetail,
                            $count, $conv, $wrap, $wait, $emails, $refused, $onfile
                        );
                        warn "Error inserting inboundDisposition (agent backup): $sth_insert_agent_dispo->errstr\n" if !$rows_inserted;
                        $sth_insert_agent_dispo->finish();
                    }
                }
            }
        }
        $dbh_agent_dispo->finish();
    }
    #Fill Service Levels
    my $sl_query = qq~
        SELECT sum(case when waitduration <= 25 then 1 else 0 end) as a25,
               sum(case when waitduration <= 30 then 1 else 0 end) as a30,
               sum(case when waitduration <= 45 then 1 else 0 end) as a45,
               sum(case when waitduration <= 60 then 1 else 0 end) as a60,
               count(*) as total
        FROM [HN_Ondata].[dbo].[ODCalls] odc
        where calltype = 1
          and lastagent > 0
          and odc.LastCampaign in ($dids)
          and calllocaltime >= ?
          and calllocaltime < ?
    ~;
    my $dbh_sl = $db->prepare($sl_query);
    unless ($dbh_sl) {
        warn "Error preparing service level query (backup): $db->errstr\n";
    } else {
        my $sl_result = $dbh_sl->execute($today, $nextday);
        warn "Error executing service level query (backup): $dbh_sl->errstr\n" if !$sl_result;
        my ($a25, $a30, $a45, $a60, $atot) = $dbh_sl->fetchrow() if $sl_result;
        $dbh_sl->finish();

        my ($n25, $n30, $n45, $n60, $denom);
        if ($atot > 0) {
            ($n25, $n30, $n45, $n60, $denom) = ($a25, $a30, $a45, $a60, $atot);
            $a25 = $a25 / $atot if $a25 > 0;
            $a30 = $a30 / $atot if $a30 > 0;
            $a45 = $a45 / $atot if $a45 > 0;
            $a60 = $a60 / $atot;
        } else {
            $a25 = 0;
            $a30 = 0;
            $a45 = 0;
            $a60 = 0;
            $denom = 0;
            $n25 = 0;
            $n30 = 0;
            $n45 = 0;
            $n60 = 0;
        }

        $a25 = testNumber($a25);
        $a30 = testNumber($a30);
        $a45 = testNumber($a45);
        $a60 = testNumber($a60);
        $denom = testNumber($denom);
        $n25 = testNumber($n25);
        $n30 = testNumber($n30);
        $n45 = testNumber($n45);
        $n60 = testNumber($n60);

        my $update_sl_query = qq~
            Update inboundMetricsServiceLevel
            set answerPercent25 = answerPercent25 + ?,
                answerPercent30 = answerPercent30 + ?,
                answerPercent45 = answerPercent45 + ?,
                answerPercent60 = answerPercent60 + ?,
                denominator = ?,
                25n = 25n + ?,
                30n = 30n + ?,
                45n = 45n + ?,
                60n = 60n + ?
            where reportID = ?
              and callDate = ?
        ~;
        my $sth_update_sl = $dbMySQL1->prepare($update_sl_query);
        unless ($sth_update_sl) {
            warn "Error preparing update inboundMetricsServiceLevel (backup): $dbMySQL1->errstr\n";
        } else {
            my $rows_updated = $sth_update_sl->execute(
                $a25, $a30, $a45, $a60, $denom, $n25, $n30, $n45, $n60, $repID, $today
            );
            warn "Error updating inboundMetricsServiceLevel (backup): $sth_update_sl->errstr\n" if !$rows_updated;
            $sth_update_sl->finish();
        }
    }
}
sub testNumber{
     my $i = $_[0];
     if(($i>0) || ($i<0)){
          return $i;
     }else{
          return 0;
     }
}
sub moveDistribution2Archive{
    my $repID = $_[0];
    my $date = $_[1];
    my $logID = $_[2];
    my $tmpDate = $date + "1D";
    my $nextday = isodate($tmpDate);
    my $today = isodate($date);

    # Delete existing archive data for the report and date range
    my $delete_archive_query = "Delete from inboundDistributionArchive where reportID = ? and dateTimeStart >= ? and dateTimeStart < ?";
    my $sth_delete_archive = $dbMySQL1->prepare($delete_archive_query);
    unless ($sth_delete_archive) {
        warn "Error preparing delete from inboundDistributionArchive: $dbMySQL1->errstr\n";
    } else {
        my $rows_deleted = $sth_delete_archive->execute($repID, $today, $nextday);
        warn "Error deleting from inboundDistributionArchive: $sth_delete_archive->errstr\n" if $sth_delete_archive->errstr;
        $sth_delete_archive->finish();
    }

    # Insert current distribution data into the archive
    my $insert_archive_query = "Insert into inboundDistributionArchive Select * from `TPS`.`inboundDistribution` where reportID = ? and dateTimeStart >= ? and dateTimeStart < ?";
    my $sth_insert_archive = $dbMySQL1->prepare($insert_archive_query);
    unless ($sth_insert_archive) {
        warn "Error preparing insert into inboundDistributionArchive: $dbMySQL1->errstr\n";
    } else {
        my $rows_inserted = $sth_insert_archive->execute($repID, $today, $nextday);
        warn "Error inserting into inboundDistributionArchive: $sth_insert_archive->errstr\n" if $sth_insert_archive->errstr;
        $sth_insert_archive->finish();
    }

    # Delete the current distribution data for the report
    my $delete_current_query = "Delete from inboundDistribution where reportID = ?";
    my $sth_delete_current = $dbMySQL1->prepare($delete_current_query);
    unless ($sth_delete_current) {
        warn "Error preparing delete from inboundDistribution: $dbMySQL1->errstr\n";
    } else {
        my $rows_deleted = $sth_delete_current->execute($repID);
        warn "Error deleting from inboundDistribution: $sth_delete_current->errstr\n" if $sth_delete_current->errstr;
        $sth_delete_current->finish();
    }
}
sub createExcelFile
{
    my $repname = $_[0];
    my $title = $_[1];
    my $repid = $_[2];
    my $tz = $_[3];
    my $date = $_[4];
    my $workbook = $_[5];

    # Call Distribution Worksheet
    my $worksheet_distribution = $workbook->add_worksheet("Call Distribution");
    unless (defined $worksheet_distribution) {
        warn "Error adding worksheet 'Call Distribution': $workbook->error()\n";
    } else {
        #Fill in the predefined cell formats
        &setCellFormats($workbook);
        &writeheader($worksheet_distribution, $title . ' Call Distribution Spreadsheet', $date);

        $worksheet_distribution->set_landscape();
        $worksheet_distribution->fit_to_pages(1, 1);
        $worksheet_distribution->freeze_panes(5, 1);
        #print "Starting Distribution Tab\n*****\n";
        &inbound_metrics_worksheet($repname, $worksheet_distribution, $repid, $tz, $date);
    }

    # Callback Metrics Worksheet
    print "starting callback metrics\n*************\n";
    my $worksheet_callback = $workbook->add_worksheet("Callback Metrics");
    unless (defined $worksheet_callback) {
        warn "Error adding worksheet 'Callback Metrics': $workbook->error()\n";
    } else {
        &writeheader($worksheet_callback, $title . ' Callback Metrics', $date);
        $worksheet_callback->set_landscape();
        $worksheet_callback->fit_to_pages(1, 1);
        $worksheet_callback->freeze_panes(4, 1);
        &callbackMetrics($repid, $worksheet_callback, $date, $tz);
    }

    # Disposition Metrics Worksheet
    #print "Starting Disposition Tab\n";
    my $worksheet_disposition = $workbook->add_worksheet("Disposition Metrics");
    unless (defined $worksheet_disposition) {
        warn "Error adding worksheet 'Disposition Metrics': $workbook->error()\n";
    } else {
        &writeheader($worksheet_disposition, $title . ' Disposition Metrics', $date);
        $worksheet_disposition->set_landscape();
        $worksheet_disposition->fit_to_pages(1, 1);
        $worksheet_disposition->freeze_panes(4, 1);
        &inbMetricsDisposition($repid, $worksheet_disposition, $date);
    }

    # Agent Details Worksheet
    my $worksheet_agent_details = $workbook->add_worksheet("Agent Details");
    unless (defined $worksheet_agent_details) {
        warn "Error adding worksheet 'Agent Details': $workbook->error()\n";
    } else {
        &writeheader($worksheet_agent_details, $title . ' Agent Details', $date);
        $worksheet_agent_details->set_landscape();
        $worksheet_agent_details->fit_to_pages(1, 1);
        $worksheet_agent_details->freeze_panes(4, 1);
        #print "Agent Details\n";
        &agent_details_worksheet($repid, $worksheet_agent_details, $date);
    }
}
sub createEndOfWeekXLS{
    #end of week stuff
    my $repname = $_[0];
    my $title = $_[1];
    my $repid = $_[2];
    my $tz = $_[3];
    my $date = $_[4];
    my $workbook = $_[5];
    my $eod = $_[6];

    if ($eod == 1) { #End of Day Reports
        my $worksheet_agent_week = $workbook->add_worksheet("Agent Week Details");
        unless (defined $worksheet_agent_week) {
            warn "Error adding worksheet 'Agent Week Details': $workbook->error()\n";
        } else {
            &writeheader($worksheet_agent_week, $title . ' Agent Week Details', $date);
            $worksheet_agent_week->set_landscape();
            $worksheet_agent_week->fit_to_pages(1, 1);
            $worksheet_agent_week->freeze_panes(4, 1);
            #print "Agent Week Details\n";
            &agent_details_worksheetWeek($repid, $worksheet_agent_week, $date);
        }
    }

    if (($eod == 1) && ($date->wday() == 1)) { #End of week reports
        #Historical Distribution By Week
        my $worksheet_dispo_week = $workbook->add_worksheet("Disposition Metrics by Week");
        unless (defined $worksheet_dispo_week) {
            warn "Error adding worksheet 'Disposition Metrics by Week': $workbook->error()\n";
        } else {
            &writeheader($worksheet_dispo_week, $title . ' Disposition Metrics by Week', $date);
            $worksheet_dispo_week->set_landscape();
            $worksheet_dispo_week->fit_to_pages(1, 1);
            $worksheet_dispo_week->freeze_panes(4, 1);
            &inbMetricsDispositionbyWeek($repid, $worksheet_dispo_week, $date);
        }

        #historical by month
        my $worksheet_dispo_month_week = $workbook->add_worksheet("Disposition Metrics by Month");
        unless (defined $worksheet_dispo_month_week) {
            warn "Error adding worksheet 'Disposition Metrics by Month' (from week): $workbook->error()\n";
        } else {
            &writeheader($worksheet_dispo_month_week, $title . ' Disposition Metrics by Month', $date);
            $worksheet_dispo_month_week->set_landscape();
            $worksheet_dispo_month_week->fit_to_pages(1, 1);
            $worksheet_dispo_month_week->freeze_panes(4, 1);
            inbMetricsDispositionbyMonth($repid, $worksheet_dispo_month_week, $date);
        }

        my $worksheet_agent_history = $workbook->add_worksheet("Agent History");
        unless (defined $worksheet_agent_history) {
            warn "Error adding worksheet 'Agent History': $workbook->error()\n";
        } else {
            &writeheader($worksheet_agent_history, $title . ' Agent History', $date);
            $worksheet_agent_history->set_landscape();
            $worksheet_agent_history->fit_to_pages(1, 1);
            $worksheet_agent_history->freeze_panes(4, 1);
            #print "Agent History\n";
            &agent_details_worksheetHist($repid, $worksheet_agent_history, $date);
        }
        createHistoricalDistribution($repid, $workbook, $date, $tz, $title);
    } elsif ((isEndOfMonth($date) == 1) && ($eod == 1)) {
        my $worksheet_dispo_month_eom = $workbook->add_worksheet("Disposition Metrics by Month");
        unless (defined $worksheet_dispo_month_eom) {
            warn "Error adding worksheet 'Disposition Metrics by Month' (from EOM): $workbook->error()\n";
        } else {
            &writeheader($worksheet_dispo_month_eom, $title . ' Disposition Metrics by Month', $date);
            $worksheet_dispo_month_eom->set_landscape();
            $worksheet_dispo_month_eom->fit_to_pages(1, 1);
            $worksheet_dispo_month_eom->freeze_panes(4, 1);
            inbMetricsDispositionbyMonth($repid, $worksheet_dispo_month_eom, $date);
        }
    }
}
sub createHistoricalDistribution{
    my $repID = $_[0];
    my $wb = $_[1];
    my $date = $_[2];
    my $tz = $_[3];
    my $title = $_[4];
    my @Days = ('Monday', 'Tuesday', 'Wednesday', 'Thursday','Friday','Saturday', 'Sunday');
    my $yearAgo = $date - '365D';
    my $startDate = getPrevMonday($yearAgo);
    my $endDate = getNextSunday($date);

    foreach my $day (@Days) {
        my $worksheet = $wb->add_worksheet("$day Distribution");
        unless (defined $worksheet) {
            warn "Error adding worksheet '$day Distribution': $wb->error()\n";
        } else {
            &writeheader($worksheet, $title . " $day Distribution", $date);
            $worksheet->set_landscape();
            $worksheet->fit_to_pages(1, 1);
            #print "$_ Distribution\n";
            my $passDate = getNextDay($startDate, getDayNum($day));
            fillHistoricalDistribution($passDate, $day, getDayNum($day), $endDate, $repID, $worksheet, $tz);
        }
    }
}
sub fillHistoricalDistribution{
    my $startDate = $_[0];
    my $day = $_[1];
    my $dayNum = $_[2];
    my $endDate = $_[3];
    my $repID = $_[4];
    my $ws = $_[5];
    my $tz = $_[6];
    #print "Working on $day, $dayNum\n";
    my $row = 3;
    my $col = 0;
    $ws->set_row($row,40);
    $ws->write($row++, $col, 'Time Period', $formatTitleRow);
    $ws->set_column($col,$col,13);
    #fill in time period
    my $mySQLDay = getWeekDayNumforMySQL($dayNum);
    my $mtOffSet = getMToffset($tz);
    my $time_period_query = "Select Time_Format(date_add(dateTimeStart,INTERVAL ? HOUR),'%H:%i'), Time_Format(date_add(dateTimeEnd,INTERVAL ? HOUR),'%H:%i') from TPS.inboundDistributionArchive where reportID = ? and WEEKDAY(dateTimeStart) = ? and dateTimeStart >= ? group by Time_Format(date_add(dateTimeStart,INTERVAL ? HOUR),'%H:%i'), Time_Format(date_add(dateTimeEnd,INTERVAL ? HOUR),'%H:%i') order by Time_Format(date_add(dateTimeStart,INTERVAL ? HOUR),'%H:%i')";
    my $sth_time_period = $dbMySQL1->prepare($time_period_query);
    unless ($sth_time_period) {
        warn "Error preparing time period query for $day: $dbMySQL1->errstr\n";
    } else {
        my $tp_result = $sth_time_period->execute($mtOffSet, $mtOffSet, $repID, $mySQLDay, $startDate, $mtOffSet);
        warn "Error executing time period query for $day: $sth_time_period->errstr\n" if !$tp_result;

        while (my ($dateTimeStart, $dateTimeEnd) = $sth_time_period->fetchrow()) {
            my $label = $dateTimeStart . " - " . $dateTimeEnd;
            $ws->write($row++, $col, $label, $formattextleft);
        }
        $sth_time_period->finish();
    }
    $col++;

    while ($startDate <= $endDate) {
        $row = 3;
        my $nextDay = $startDate +'1D';
        my $qdate1 = isodate($startDate);
        my $qdate2 = isodate($nextDay);
        my $day_schedule_query = "Select Time_Format(dateTimeStart,'%H:%i'), Time_Format(dateTimeEnd,'%H:%i') from TPS.inboundDistributionArchive where reportID = ? and WEEKDAY(dateTimeStart) = ? and dateTimeStart >= ? group by Time_Format(dateTimeStart,'%H:%i'), Time_Format(dateTimeEnd,'%H:%i') order by Time_Format(dateTimeStart,'%H:%i')";
        my $sth_day_schedule = $dbMySQL1->prepare($day_schedule_query);
        unless ($sth_day_schedule) {
            warn "Error preparing day schedule query for $qdate1: $dbMySQL1->errstr\n";
        } else {
            my $ds_result = $sth_day_schedule->execute($repID, $mySQLDay, $startDate);
            warn "Error executing day schedule query for $qdate1: $sth_day_schedule->errstr\n" if !$ds_result;

            $ws->set_column($col,$col,10);
            $ws->write($row++, $col, $startDate->mdy, $formatTitleRow);

            while (my ($dateTimeStart, $dateTimeEnd) = $sth_day_schedule->fetchrow()) {
                $qdate1 = isodate($startDate);
                $qdate2 = isodate($nextDay);
                my $full_start_time = $qdate1 . " $dateTimeStart";
                my $distribution_query = "Select (agentCalls + abandons) as calls from TPS.inboundDistributionArchive where reportID = ? and dateTimeStart = ?";
                my $sth_distribution = $dbMySQL1->prepare($distribution_query);
                unless ($sth_distribution) {
                    warn "Error preparing distribution query for $full_start_time: $dbMySQL1->errstr\n";
                } else {
                    my $dist_result = $sth_distribution->execute($repID, $full_start_time);
                    warn "Error executing distribution query for $full_start_time: $sth_distribution->errstr\n" if !$dist_result;
                    my $count = $sth_distribution->fetchrow();
                    $count = 0 if (!defined $count); # Initialize count if undefined
                    $ws->write($row++, $col, $count , $formattextright);
                    $sth_distribution->finish();
                }
            }
            $sth_day_schedule->finish();
        }
        $col++;
        $startDate = $startDate + '7D';
    }
}
sub agent_details_worksheetHist{
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $firstDay = firstmondayofyear($date);
    my $lastDay = getNextSunday($date);
    my $qdate1 = isodate($firstDay);
    my $qdate2 = isodate($lastDay);
    my $agent_query = "Select i.agentID, L_Name, F_Name from TPS.inboundAgentDispositionArchive i left outer join `TPS`.`Emp_Table` e on i.agentid = e.ID_Employee where reportID = ? and i.callDate >= ? and i.callDate <= ? group by agentid, L_Name, F_Name order by L_Name asc, F_Name asc";
    my $sth_agent = $dbMySQL1->prepare($agent_query);
    unless ($sth_agent) {
        warn "Error preparing agent list query (history): $dbMySQL1->errstr\n";
        return;
    }
    my $agent_result = $sth_agent->execute($repID, $qdate1, $qdate2);
    unless ($agent_result) {
        warn "Error executing agent list query (history): $sth_agent->errstr\n";
        $sth_agent->finish();
        return;
    }

    my $row = 3;
    my $col = 0;
    $ws->set_row($row,40);
    $ws->write($row, $col, 'Agent Name', $formatTitleRow);
    $ws->set_column($col,$col,25);
    $col++;

    my $beginWeek = $firstDay;
    my $endWeek = getNextSunday($beginWeek);
    while ($endWeek <= $lastDay) {
        $ws->set_column($col,$col,10);
        $ws->write($row, $col++, $beginWeek->mdy, $formatTitleRow);
        $beginWeek = $beginWeek + '7D';
        $endWeek = $endWeek + '7D';
    }
    $row++;

    while (my ($agent, $lname, $fname) = $sth_agent->fetchrow()) {
        $col = 0;
        my $displayname = "$lname, $fname - $agent";
        my $current_row = $row;
        my $beginWeekLoop = $firstDay;
        my $endWeekLoop = getNextSunday($beginWeekLoop);
        #print "$row, $col $displayname\n";
        $ws->write($row++,$col,$displayname,$formattextleft);
        #print "$row, $col total calls\n";
        my $startDataRow = $row; #Row value will jump back to this when it goes into the next loop
        $ws->write($row++,$col,'Total Calls',$formattextleft);
        $ws->write($row++,$col,'Avg Talk Time',$formattextleft);
        $ws->write($row++,$col,'Avg Wrap Time',$formattextleft);
        $ws->write($row++,$col,'Avg Handle Time',$formattextleft);
        $ws->write($row++,$col,'PIA%',$formattextleft);
        $ws->write($row++,$col,'EZ Pay %',$formattextleft);
        $ws->write($row++,$col,'Save %',$formattextleft);
        $ws->write($row,$col++,'Vac %',$formattextleft);

        while ($endWeekLoop <= $lastDay) {
            #print "Working $lname - $beginWeekLoop to $endWeekLoop going to $lastDay\n";
            $row = $startDataRow;
            $qdate1Loop = isodate($beginWeekLoop);
            $qdate2Loop = isodate($endWeekLoop);

            my $calls_query = qq~Select sum(`count`) from `TPS`.`inboundAgentDispositionArchive` where agentid = ? and calldate >= ? and calldate <= ? and reportID = ?~;
            my $sth_calls = $dbMySQL1->prepare($calls_query);
            unless ($sth_calls) {
                warn "Error preparing agent calls query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_calls->execute($agent, $qdate1Loop, $qdate2Loop, $repID);
                my $agentCalls = $sth_calls->fetchrow();
                $agentCalls = 0 if (!defined $agentCalls);
                $ws->write($row++,$col,$agentCalls,$formatnum);
                $sth_calls->finish();
            }

            my $talk_query = qq~Select sum(talkTime) from `TPS`.`inboundAgentDispositionArchive` where agentid = ? and calldate >= ? and calldate <= ? and reportID = ?~;
            my $sth_talk = $dbMySQL1->prepare($talk_query);
            unless ($sth_talk) {
                warn "Error preparing agent talk time query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_talk->execute($agent, $qdate1Loop, $qdate2Loop, $repID);
                my $talk = $sth_talk->fetchrow();
                $talk = 0 if (!defined $talk);
                my $tmp_talk = "=" . checkDenom($talk,$agentCalls) . "/86400";
                $ws->write($row++,$col,$tmp_talk,$formatTime);
                $sth_talk->finish();
            }

            my $wrap_query = qq~Select sum(wrapTime) from `TPS`.`inboundAgentDispositionArchive` where agentid = ? and calldate >= ? and calldate <= ? and reportID = ?~;
            my $sth_wrap = $dbMySQL1->prepare($wrap_query);
            unless ($sth_wrap) {
                warn "Error preparing agent wrap time query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_wrap->execute($agent, $qdate1Loop, $qdate2Loop, $repID);
                my $wrap = $sth_wrap->fetchrow();
                $wrap = 0 if (!defined $wrap);
                my $tmp_wrap = "=" . checkDenom($wrap,$agentCalls) . "/86400";
                $ws->write($row++,$col,$tmp_wrap,$formatTime);
                $sth_wrap->finish();
            }

            my $ht = (defined $wrap ? $wrap : 0) + (defined $talk ? $talk : 0);
            my $tmp_ht = "=" . checkDenom($ht,$agentCalls) . "/86400";
            $ws->write($row++,$col,$tmp_ht,$formatTime);

            my $basequery = qq~SELECT sum(`count`) FROM TPS.inboundAgentDispositionArchive a inner join Snowfly b on a.statusgroup = b.statusgroup and a.statuscode = b.statuscode and a.statusdetail = b.statusdetail
                                                where reportID = ? and callDate >= ? and callDate <= ? and agentid = ? ~;

            my $pia_num_query = $basequery . "and paidInAdvance = 1";
            my $sth_pia_num = $dbMySQL1->prepare($pia_num_query);
            unless ($sth_pia_num) {
                warn "Error preparing PIA num query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_pia_num->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $piaNum = $sth_pia_num->fetchrow();
                $piaNum = 0 if (!defined $piaNum);
                $sth_pia_num->finish();
            }

            my $pia_denom_query = $basequery . "and paidInAdvance in (1,2)";
            my $sth_pia_denom = $dbMySQL1->prepare($pia_denom_query);
            unless ($sth_pia_denom) {
                warn "Error preparing PIA denom query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_pia_denom->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $piaDeNom = $sth_pia_denom->fetchrow();
                $piaDeNom = 0 if (!defined $piaDeNom);
                my $tmp_pia = checkDenom($piaNum,$piaDeNom);
                $ws->write($row++,$col,$tmp_pia,$formatPercent);
                $sth_pia_denom->finish();
            }

            my $ezpay_num_query = $basequery . "and ezPay = 1";
            my $sth_ezpay_num = $dbMySQL1->prepare($ezpay_num_query);
            unless ($sth_ezpay_num) {
                warn "Error preparing EZ Pay num query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_ezpay_num->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $ezPayNum = $sth_ezpay_num->fetchrow();
                $ezPayNum = 0 if (!defined $ezPayNum);
                $sth_ezpay_num->finish();
            }

            my $ezpay_denom_query = $basequery . "and ezPay in (1,2)";
            my $sth_ezpay_denom = $dbMySQL1->prepare($ezpay_denom_query);
            unless ($sth_ezpay_denom) {
                warn "Error preparing EZ Pay denom query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_ezpay_denom->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $ezPayDeNom = $sth_ezpay_denom->fetchrow();
                $ezPayDeNom = 0 if (!defined $ezPayDeNom);
                my $tmp_ezpay = checkDenom($ezPayNum,$ezPayDeNom);
                $ws->write($row++,$col,$tmp_ezpay,$formatPercent);
                $sth_ezpay_denom->finish();
            }

            my $save_num_query = $basequery . "and stopSave = 1";
            my $sth_save_num = $dbMySQL1->prepare($save_num_query);
            unless ($sth_save_num) {
                warn "Error preparing Save num query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_save_num->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $stopSaveNum = $sth_save_num->fetchrow();
                $stopSaveNum = 0 if (!defined $stopSaveNum);
                $sth_save_num->finish();
            }

            my $save_denom_query = $basequery . "and stopSave in (1,2)";
            my $sth_save_denom = $dbMySQL1->prepare($save_denom_query);
            unless ($sth_save_denom) {
                warn "Error preparing Save denom query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_save_denom->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $stopSaveDeNom = $sth_save_denom->fetchrow();
                $stopSaveDeNom = 0 if (!defined $stopSaveDeNom);
                my $tmp_save = checkDenom($stopSaveNum,$stopSaveDeNom);
                $ws->write($row++,$col,$tmp_save,$formatPercent);
                $sth_save_denom->finish();
            }

            my $vac_num_query = $basequery . "and vacationSave = 1";
            my $sth_vac_num = $dbMySQL1->prepare($vac_num_query);
            unless ($sth_vac_num) {
                warn "Error preparing Vac num query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_vac_num->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $vacationSaveNum = $sth_vac_num->fetchrow();
                $vacationSaveNum = 0 if (!defined $vacationSaveNum);
                $sth_vac_num->finish();
            }

            my $vac_denom_query = $basequery . "and vacationSave in (1,2)";
            my $sth_vac_denom = $dbMySQL1->prepare($vac_denom_query);
            unless ($sth_vac_denom) {
                warn "Error preparing Vac denom query (history): $dbMySQL1->errstr\n";
            } else {
                $sth_vac_denom->execute($repID, $qdate1Loop, $qdate2Loop, $agent);
                my $vacationSaveDeNom = $sth_vac_denom->fetchrow();
                $vacationSaveDeNom = 0 if (!defined $vacationSaveDeNom);
                my $tmp_vac = checkDenom($vacationSaveNum,$vacationSaveDeNom);
                $ws->write($row,$col++,$tmp_vac,$formatPercent);
                $sth_vac_denom->finish();
            }

            $beginWeekLoop = $beginWeekLoop + '7D';
            $endWeekLoop = $endWeekLoop + '7D';
        }
        $row = $current_row + 9; # Move to the next agent's data
    }
    $sth_agent->finish();
}
sub inbMetricsDispositionbyWeek{
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $firstDay = firstmondayofyear($date);
    my $lastDay = getNextSunday($date);
    my $rowStart = 3;
    my $col = 0;
    my $row = $rowStart;
    my $beginworkingdate = $firstDay;
    my $endworkingdate = getNextSunday($firstDay);
    my $qdesc1 = isodate($firstDay);
    my $qdesc2 = isodate($lastDay);
    my $year = $date->year;
    my $queryTitle = qq~Select s.StatusText, s.statusGroup, s.statusCode, s.statusDetail
                         from `TPS`.`Snowfly` s
                         inner join `TPS`.`inboundDispositionArchive` i
                             on i.statusGroup = s.statusGroup
                             and i.statusCode = s.statusCode
                             and i.statusDetail = s.statusDetail
                         where year(i.calldate) = ?
                           and reportID = ?
                         group by s.StatusText, s.statusGroup, s.statusCode, s.statusDetail
                         order by s.statusGroup, s.statusCode, s.statusDetail~;
    #print "$queryTitle\n";
    my $tmpTable = CreateTempDispoTableWeekly($dbMySQL1, $repID);
    unless (defined $tmpTable) {
        warn "Error creating temporary disposition table for weekly metrics.\n";
        return;
    }
    #my $query = qq~insert into $tmpTable (reportID, description, statusGroup, statusCode, statusDetail) Select i.reportID, s.StatusText, s.statusGroup, s.statusCode, s.statusDetail from `TPS`.`Snowfly` s inner join `TPS`.`inboundDispositionArchive` i on i.statusGroup = s.statusGroup and i.statusCode = s.statusCode and i.statusDetail = s.statusDetail
    #           where year(i.calldate) = $year and reportID = $repID group by  s.StatusText, s.statusGroup, s.statusCode, s.statusDetail order by s.statusGroup, s.statusCode, s.statusDetail~;
    my $insert_temp_query = qq~insert into $tmpTable (reportID, statusGroup, statusCode, statusDetail)
                               Select i.reportID, i.statusGroup, i.statusCode, i.statusDetail
                               from `TPS`.`inboundDispositionArchive` i
                               where year(i.calldate) = ?
                                 and reportID = ?
                               group by i.statusGroup, i.statusCode, i.statusDetail
                               order by i.statusGroup, i.statusCode, i.statusDetail~;
    my $sth_insert_temp = $dbMySQL1->prepare($insert_temp_query);
    unless ($sth_insert_temp) {
        warn "Error preparing insert into temp table (weekly): $dbMySQL1->errstr\n";
    } else {
        $sth_insert_temp->execute($year, $repID);
        warn "Error executing insert into temp table (weekly): $sth_insert_temp->errstr\n" if $sth_insert_temp->errstr;
        $sth_insert_temp->finish();
    }
    #print "$query\nline 542\n";
    my $update_desc_query = "Update $tmpTable a inner join Snowfly b on a.statusGroup = b.statusGroup and a.statusCode = b.statusCode and a.statusDetail = b.statusDetail set a.Description = b.statusText";
    my $sth_update_desc = $dbMySQL1->prepare($update_desc_query);
    unless ($sth_update_desc) {
        warn "Error preparing update temp table description (weekly): $dbMySQL1->errstr\n";
    } else {
        $sth_update_desc->execute();
        warn "Error executing update temp table description (weekly): $sth_update_desc->errstr\n" if $sth_update_desc->errstr;
        $sth_update_desc->finish();
    }
    my $update_other_query = "Update $tmpTable set Description = 'Other', statusGroup = 50, statusCode = 1, statusDetail = 2 where Description = '' or Description is null";
    my $sth_update_other = $dbMySQL1->prepare($update_other_query);
    unless ($sth_update_other) {
        warn "Error preparing update temp table for 'Other' (weekly): $dbMySQL1->errstr\n";
    } else {
        $sth_update_other->execute();
        warn "Error executing update temp table for 'Other' (weekly): $sth_update_other->errstr\n" if $sth_update_other->errstr;
        $sth_update_other->finish();
    }
    #$query = "Update $tmpTable set statusGroup = 0 where statusGroup = 49";
    #$sth = $dbMySQL1->prepare($query);
    #$sth->execute();
    #die();
    my $i = 1;
    #Loop by week
    #print  "$beginworkingdate to $endworkingdate\n";
    #print "$endworkingdate to $lastDay\n";
    while ($endworkingdate <= $lastDay) {
        #get descriptions and groups
        #print  "$beginworkingdate to $endworkingdate\n";
        my $sth_title = $dbMySQL1->prepare($queryTitle);
        unless ($sth_title) {
            warn "Error preparing query title (weekly): $dbMySQL1->errstr\n";
        } else {
            $sth_title->execute($year, $repID);
            warn "Error executing query title (weekly): $sth_title->errstr\n" if $sth_title->errstr;
            $row = $rowStart;
            my $qdate1 = isodate($beginworkingdate);
            my $qdate2 = isodate($endworkingdate);
            #regular stuff
            while (my ($text, $group, $code, $detail) = $sth_title->fetchrow()) {
                my $count_query = qq~select sum(`count`)
                                    from `TPS`.`inboundDispositionArchive`
                                    where reportID = ?
                                      and calldate >= ?
                                      and calldate <= ?
                                      and statusGroup = ?
                                      and statusCode = ?
                                      and statusDetail = ?~;
                my $sth_count = $dbMySQL1->prepare($count_query);
                unless ($sth_count) {
                    warn "Error preparing count query (weekly): $dbMySQL1->errstr\n";
                } else {
                    my $result = $sth_count->execute($repID, $qdate1, $qdate2, $group, $code, $detail);
                    warn "Error executing count query (weekly): $sth_count->errstr\n" if !$result;
                    my $tmp = 0;
                    if ($result != 0) {
                        $tmp = $sth_count->fetchrow();
                        if ($tmp > 0) {
                            print "count of $text = $tmp\n";
                        } else {
                            $tmp = 0;
                        }
                    }
                    my $tmpField = "w$i";
                    my $update_count_query = qq~Update $tmpTable
                                            set `$tmpField` = ?
                                            where statusGroup = ?
                                              and statusCode = ?
                                              and statusDetail = ?~;
                    my $sth_update_count = $dbMySQL1->prepare($update_count_query);
                    unless ($sth_update_count) {
                        warn "Error preparing update temp table count (weekly): $dbMySQL1->errstr\n";
                    } else {
                        $sth_update_count->execute($tmp, $group, $code, $detail);
                        warn "Error executing update temp table count (weekly): $sth_update_count->errstr\n" if $sth_update_count->errstr;
                        $sth_update_count->finish();
                    }
                }
                $sth_count->finish();

                if ($i > 53) {
                    print "$i is too big $beginworkingdate to $endworkingdate Report id = $repID\n";
                    print "$query\n";
                    die();
                }
            }
            $sth_title->finish();
        }
        $i++;
        my $total_query = qq~select sum(`count`)
                             from `TPS`.`inboundDispositionArchive`
                             where reportID = ?
                               and calldate >= ?
                               and calldate <= ?~;

        $beginworkingdate = $beginworkingdate + '7D';
        $endworkingdate = $endworkingdate +'7D';
    }
    $row = $rowStart;
    $col = 0;
    $beginworkingdate = $firstDay;
    $endworkingdate = getNextSunday($firstDay);
    my $update_group_query = "Update $tmpTable set statusGroup = 50 where statusGroup = 49";
    my $sth_update_group = $dbMySQL1->prepare($update_group_query);
    unless ($sth_update_group) {
        warn "Error preparing update temp table group (weekly): $dbMySQL1->errstr\n";
    } else {
        $sth_update_group->execute();
        warn "Error executing update temp table group (weekly): $sth_update_group->errstr\n" if $sth_update_group->errstr;
        $sth_update_group->finish();
    }
    $i = 1;
    #write out the dispos
    my $select_dispo_query = "Select description, statusGroup, statusCode, statusDetail from $tmpTable order by statusGroup, statusCode, statusDetail";
    print "Dispo Titles Query:\n$select_dispo_query\n";
    my $sth_dispo_title = $dbMySQL1->prepare($select_dispo_query);
    unless ($sth_dispo_title) {
        warn "Error preparing dispo titles query (weekly): $dbMySQL1->errstr\n";
    } else {
        $sth_dispo_title->execute();
        warn "Error executing dispo titles query (weekly): $sth_dispo_title->errstr\n" if $sth_dispo_title->errstr;
        $ws->set_row($row,40);
        #print "Disposition $row $col\n";
        $ws->write($row++, $col, 'Disposition', $formatTitleRow);
        $ws->set_column($col,$col,25);
        while (my ($text, $group, $code, $detail) = $sth_dispo_title->fetchrow()) {
            $ws->write($row++,$col,$text,$formatTotRow);
            print "$text\n";
        }
        $sth_dispo_title->finish();
    }
    print "****\n";
    $ws->write($row++, $col, 'Total', $formatTotRow);
    $row++;
    $ws->write($row++, $col, 'PIA %', $formatTotRow);
    $ws->write($row++, $col, 'EZ Pay %', $formatTotRow);
    $ws->write($row++, $col, 'Save %', $formatTotRow);
    $ws->write($row++, $col, 'Vacation %', $formatTotRow);
    $ws->write($row++, $col, 'Answer %', $formatTotRow);
    $ws->write($row++, $col, 'Avg Handle Time', $formatTotRow);
    $ws->write($row++, $col, 'ASA', $formatTotRow);
    my $lastCol = $col;
    $col++;
    #loop through actual weeks
     #test
     my $update_group_again_query = "Update $tmpTable set statusGroup = 50 where statusGroup = 48";
     my $sth_update_group_again = $dbMySQL1->prepare($update_group_again_query);
     unless ($sth_update_group_again) {
         warn "Error preparing update temp table group again (weekly): $dbMySQL1->errstr\n";
     } else {
         $sth_update_group_again->execute();
         warn "Error executing update temp table group again (weekly): $sth_update_group_again->errstr\n" if $sth_update_group_again->errstr;
         $sth_update_group_again->finish();
     }
    while ($endworkingdate <= $lastDay) {
        #get descriptions and groups
        $row = $rowStart;
        #print "Start actual weeks loop $beginworkingdate to $endworkingdate row = $row, col = $col i= $i\n";
        #die();
        $ws->set_column($col,$col,10);
        $ws->write($row++,$col,$beginworkingdate->mdy,$formatTitleRow);
        my $qdate1 = isodate($beginworkingdate);
        my $qdate2 = isodate($endworkingdate);
        my $tmpField = "w$i";
        my $select_data_query = qq~Select $tmpField, statusGroup, statusCode, statusDetail, description
                                from $tmpTable
                                order by statusGroup, statusCode, statusDetail~;
        my $sth_data = $dbMySQL1->prepare($select_data_query);
        unless ($sth_data) {
            warn "Error preparing select data from temp table (weekly): $dbMySQL1->errstr\n";
        } else {
            $sth_data->execute();
            warn "Error executing select data from temp table (weekly): $sth_data->errstr\n" if $sth_data->errstr;
            print "$select_data_query\n";
            my $total = 0;
            while (my ($count, $x, $y, $z, $l) = $sth_data->fetchrow()) {
                #print "Fill DAta: $row, $col = $count\n";
                print "$count, $x, $y, $z,$l\n";
                $ws->write($row++,$col,$count,$formatnum);
                $total += $count;
            }
            $sth_data->finish();
            #Total
            $ws->write($row++,$col,$total,$formatnumTotals);
            $row++;
            #get agent handled
            my $baseQuery = qq~select sum($tmpField)
                              from $tmpTable i
                              inner join Snowfly s
                                  on i.statusGroup = s.statusGroup
                                  and i.statusCode = s.statusCode
                                  and i.statusDetail = s.statusDetail
                              where~;
            my $agentCallsQuery = $baseQuery . " agentOffered = 1";
            my $agentCalls = getcount($agentCallsQuery);
            #print "line 634\n";
            #get PIA
            my $piaNomQuery = $baseQuery . " paidInAdvance = 1";
            my $piaNom = getcount($piaNomQuery);
            #print "line 638\n";
            my $piaDenomQuery = $baseQuery . " paidInAdvance in (1,2)";
            my $piaDenom = getcount($piaDenomQuery);
            #print "line 641\n";
            my $piaPer = checkDenom($piaNom, $piaDenom);
            #get EZ
            my $ezNomQuery = $baseQuery . " ezPay = 1";
            my $ezNom = getcount($ezNomQuery);
            #print "line 646\n";
            my $ezDenomQuery = $baseQuery . " ezPay in (1,2)";
            my $ezDenom = getcount($ezDenomQuery);
            my $ezPer = checkDenom($ezNom, $ezDenom);
            #get Stop
            my $stopNomQuery = $baseQuery . " stopSave = 1";
            my $stopNom = getcount($stopNomQuery);
            my $stopDenomQuery = $baseQuery . " stopSave in (1,2)";
            my $stopDenom = getcount($stopDenomQuery);
            my $stopPer = checkDenom($stopNom, $stopDenom);
            #get VAc
            my $vacNomQuery = $baseQuery . " vacationSave = 1";
            my $vacNom = getcount($vacNomQuery);
            my $vacDenomQuery = $baseQuery . " vacationSave in (1,2)";
            my $vacDenom = getcount($vacDenomQuery);
            my $vacPer = checkDenom($vacNom, $vacDenom);
            #get abandons
            my $update_group_temp_query = "Update $tmpTable set statusGroup = 50 where statusGroup = 49";
            my $sth_update_group_temp = $dbMySQL1->prepare($update_group_temp_query);
            unless ($sth_update_group_temp) {
                warn "Error preparing update temp table group (abandons weekly): $dbMySQL1->errstr\n";
			} else {
            $sth_update_group_temp->execute();
            $sth_update_group_temp->finish();
			}
			my $agentOfferedQuery = $baseQuery . " agentOffered != 0";
			my $agentOffered = getcount($agentOfferedQuery);
			#print "line 665\n";
			#print "print $query $agentCalls,($aban+$agentCalls)\n";
			my $ansPer = checkDenom($agentCalls,$agentOffered);
			$ws->write($row++,$col,$piaPer,$formatPercentTotals);
			$ws->write($row++,$col,$ezPer,$formatPercentTotals);
			$ws->write($row++,$col,$stopPer,$formatPercentTotals);
			$ws->write($row++,$col,$vacPer,$formatPercentTotals);
			$ws->write($row++,$col,$ansPer,$formatPercentTotals);
			#get handle time for that week
			my $handleQuery = qq~Select (sum(talkTime) + sum(wrapTime)) as HT
                            from `TPS`.`inboundDispositionArchive`
                            where reportID = ?
                              and calldate >= ?
                              and calldate <= ?~;
			my $handle = getcount($handleQuery, $repID, $qdate1, $qdate2);
			#print "line 675\n";
			my $tmp_handle = checkDenom($handle, $agentCalls);
			my $formula_handle = "=$tmp_handle/86400";
			$ws->write($row++,$col,$formula_handle,$formatTimeTotals);
			my $waitQuery = qq~Select sum(waitTime)
							  from `TPS`.`Snowfly` s
							  inner join `TPS`.`inboundDispositionArchive` i
								  on i.statusGroup = s.statusGroup
								  and i.statusCode = s.statusCode
								  and i.statusDetail = s.statusDetail
							  where reportID = ?
								and calldate >= ?
								and calldate <= ?
								and s.agentoffered in (1)~;
			my $wait = getcount($waitQuery, $repID, $qdate1, $qdate2);
			#print "Line 681\n";
			my $tmp_wait = checkDenom($wait, $agentCalls);
			my $formula_wait = "=$tmp_wait/86400";
			$ws->write($row++,$col,$formula_wait,$formatTimeTotals);
			$beginworkingdate = $beginworkingdate + '7D';
			$endworkingdate = $endworkingdate +'7D';
			$i++;
			$col++;
		}
    $row = $rowStart;
    my $drop_temp_query = "Drop table if exists TPS.$tmpTable";
    my $sth_drop_temp = $dbMySQL1->prepare($drop_temp_query);
    unless ($sth_drop_temp) {
        warn "Error preparing drop temp table (weekly): $dbMySQL1->errstr\n";
    } else {
        $sth_drop_temp->execute();
        $sth_drop_temp->finish();
    }
}
sub agent_details_worksheetWeek{
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $Monday = getPrevMonday($date);
    my $Sunday = getNextSunday($date);
    my $qdate1 = isodate($Monday);
    my $qdate2 = isodate($Sunday);
    my $row = 3;
    my $col = 0;
    #First We make the Title Row
    $ws->set_row($row,40);
    $ws->write($row, $col, 'Agent Name', $formatTitleRow);
    $ws->set_column($col,$col,25);
    $col++;
    $ws->write($row, $col, 'Total Calls', $formatTitleRow);
    $ws->set_column($col,$col,11);
    $col++;
    $ws->write($row, $col, 'AVG Talk Time', $formatTitleRow);
    $ws->set_column($col,$col,14);
    $col++;
    $ws->write($row, $col, 'AVG ACW Time', $formatTitleRow);
    $ws->set_column($col,$col,14);
    $col++;
    $ws->write($row, $col, 'AVG Call Length', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Total Talk Time', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Total ACW Time', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Total Time', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    my $qryDesc = qq~select s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                        from TPS.Snowfly s
                        inner join inboundAgentDispositionArchive i
                            on i.statusGroup = s.statusGroup
                            and i.statusCode = s.statusCode
                            and i.statusDetail = s.statusDetail
                        where i.callDate >= ?
                          and i.callDate <= ?
                          and i.reportID = ?
                        group by s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                        order by i.statusGroup asc, i.statusCode asc, i.statusDetail asc~;

    #print "$qryDesc\n";
    my $head = $dbMySQL1->prepare($qryDesc);
    unless ($head) {
        warn "Error preparing status description query (weekly agent): $dbMySQL1->errstr\n";
    } else {
        my $head_result = $head->execute($qdate1, $qdate2, $repID);
        unless ($head_result) {
            warn "Error executing status description query (weekly agent): $head->errstr\n";
        } else {
            while (my ($desc,$group, $code, $detail) = $head->fetchrow()) {
                $ws->write($row, $col, $desc, $formatTitleRow);
                $ws->set_column($col,$col,10);
                $col++;
            }
        }
        $head->finish();
    }
    $ws->write($row, $col, 'PIA %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'EZ %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'SAVE %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'VAC %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Emails Collected', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Emails Declined', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Email on File', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $row++;
    #Set up agent loop
    my $agent_query = "Select i.agentID, L_Name, F_Name from TPS.inboundAgentDispositionArchive i left outer join `TPS`.`Emp_Table` e on i.agentid = e.ID_Employee where reportID = ? and i.callDate >= ? and i.callDate <= ? group by agentid, L_Name, F_Name order by L_Name asc, F_Name asc";
    #print "$query\n";
    my $sth_agent = $dbMySQL1->prepare($agent_query);
    unless ($sth_agent) {
        warn "Error preparing agent list query (weekly): $dbMySQL1->errstr\n";
    } else {
        my $agent_result = $sth_agent->execute($repID, $qdate1, $qdate2);
        unless ($agent_result) {
            warn "Error executing agent list query (weekly): $sth_agent->errstr\n";
        } else {
            while (my ($agent, $lname, $fname) = $sth_agent->fetchrow()) {
                $col = 0;
                my $fullname = "UNKNOWN - $agent";
                if (length($lname) > 0) {
                    $fullname = "$lname, $fname - $agent";
                }
                $ws->write($row,$col++,$fullname,$formattextleft);
                #get stats
                my $stats_query = qq~Select sum(`count`), sum(talkTime), sum(wrapTime), sum(waitTime), sum(emails), sum(declinedEmail), sum(emailonfile)
                                    from inboundAgentDispositionArchive
                                    where agentid = ?
                                      and reportID = ?
                                      and callDate >= ?
                                      and callDate <= ?~;
                my $sth_stats = $dbMySQL1->prepare($stats_query);
                my ($calls, $talk, $wrap, $wait, $email, $declined, $onfile) = (0) x 7;
                unless ($sth_stats) {
                    warn "Error preparing agent stats query (weekly): $dbMySQL1->errstr\n";
                } else {
                    my $stats_result = $sth_stats->execute($agent, $repID, $qdate1, $qdate2);
                    if ($stats_result) {
                        ($calls, $talk, $wrap, $wait, $email, $declined, $onfile) = $sth_stats->fetchrow();
                    } else {
                        warn "Error executing agent stats query (weekly) for agent $agent: $sth_stats->errstr\n";
                    }
                    $sth_stats->finish();
                }
                #total calls
                $ws->write($row,$col++,$calls,$formatnum);
                my $avg_talk = checkDenom($talk,$calls);
                my $formula_talk = "=$avg_talk/86400";
                $ws->write($row,$col++,$formula_talk,$formatTime);
                my $avg_wrap = checkDenom($wrap,$calls);
                my $formula_wrap = "=$avg_wrap/86400";
                $ws->write($row,$col++,$formula_wrap,$formatTime);
                my $avg_handle = checkDenom(($talk+$wrap),$calls);
                my $formula_handle = "=$avg_handle/86400";
                $ws->write($row,$col++,$formula_handle,$formatTime);
                my $total_talk = $talk;
                my $formula_total_talk = "=$total_talk/86400";
                $ws->write($row,$col++,$formula_total_talk,$formatTimeH);
                my $total_wrap = $wrap;
                my $formula_total_wrap = "=$total_wrap/86400";
                $ws->write($row,$col++,$formula_total_wrap,$formatTimeH);
                my $total_time = $wrap+$talk;
                my $formula_total_time = "=$total_time/86400";
                $ws->write($row,$col++,$formula_total_time,$formatTimeH);
                my $desc_query = qq~select s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                                    from TPS.Snowfly s
                                    inner join inboundAgentDispositionArchive i
                                        on i.statusGroup = s.statusGroup
                                        and i.statusCode = s.statusCode
                                        and i.statusDetail = s.statusDetail
                                    where i.callDate >= ?
                                      and i.callDate <= ?
                                      and i.reportID = ?
                                    group by s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                                    order by i.statusGroup asc, i.statusCode asc, i.statusDetail asc~;
                my $sth_desc = $dbMySQL1->prepare($desc_query);
                if ($sth_desc) {
                    $sth_desc->execute($qdate1, $qdate2, $repID);
                    while (my ($text, $group, $code, $detail) = $sth_desc->fetchrow()) {
                        my $count = 0;
                        my $dispo_count_query = "Select sum(`count`) from inboundAgentDispositionArchive where agentid = ? and reportID = ? and callDate >= ? and callDate <= ? and statusGroup = ? and statusDetail = ? and statusCode = ? ";
                        my $sth_count = $dbMySQL1->prepare($dispo_count_query);
                        if ($sth_count) {
                            $sth_count->execute($agent, $repID, $qdate1, $qdate2, $group, $detail, $code);
                            if ($sth_count->execute()) {
                                $count = $sth_count->fetchrow();
                                $count = 0 if (!defined $count);
                            } else {
                                warn "Error executing disposition count query (weekly agent) for agent $agent, status $text: $sth_count->errstr\n";
                            }
                            $sth_count->finish();
                        } else {
                            warn "Error preparing disposition count query (weekly agent) for agent $agent, status $text: $dbMySQL1->errstr\n";
                        }
                        $ws->write($row,$col++,$count,$formatnum);
                    }
                    $sth_desc->finish();
                } else {
                    warn "Error preparing status description query (inner loop weekly agent): $dbMySQL1->errstr\n";
                }
                #Percents on the end and emails
                #set up base query
                my $basequery = qq~SELECT sum(`count`)
                                    FROM TPS.inboundAgentDispositionArchive a
                                    inner join Snowfly b
                                        on a.statusgroup = b.statusgroup
                                        and a.statuscode = b.statuscode
                                        and a.statusdetail = b.statusdetail
                                    where reportID = ?
                                      and callDate >= ?
                                      and callDate <= ?
                                      and agentid = ? ~;
                #add qualifiers for percentage
                #PIA
                my ($pia_nom, $pia_denom) = (0, 0);
                my $pia_nom_query = $basequery . "and b.paidInAdvance = 1";
                my $sth_pia_nom = $dbMySQL1->prepare($pia_nom_query);
                if ($sth_pia_nom) {
                    $sth_pia_nom->execute($repID, $qdate1, $qdate2, $agent);
                    $pia_nom = $sth_pia_nom->fetchrow() || 0;
                    $sth_pia_nom->finish();
                } else {
                    warn "Error preparing PIA nom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $pia_denom_query = $basequery . "and b.paidInAdvance in (1,2)";
                my $sth_pia_denom = $dbMySQL1->prepare($pia_denom_query);
                if ($sth_pia_denom) {
                    $sth_pia_denom->execute($repID, $qdate1, $qdate2, $agent);
                    $pia_denom = $sth_pia_denom->fetchrow() || 0;
                    $sth_pia_denom->finish();
                } else {
                    warn "Error preparing PIA denom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $pia_percent = checkDenom($pia_nom,$pia_denom);
                $ws->write($row,$col++,$pia_percent,$formatPercentTotals);
                #EZ
                my ($ez_nom, $ez_denom) = (0, 0);
                my $ez_nom_query = $basequery . "and b.ezPay = 1";
                my $sth_ez_nom = $dbMySQL1->prepare($ez_nom_query);
                if ($sth_ez_nom) {
                    $sth_ez_nom->execute($repID, $qdate1, $qdate2, $agent);
                    $ez_nom = $sth_ez_nom->fetchrow() || 0;
                    $sth_ez_nom->finish();
                } else {
                    warn "Error preparing EZ nom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $ez_denom_query = $basequery . "and b.ezPay in (1,2)";
                my $sth_ez_denom = $dbMySQL1->prepare($ez_denom_query);
                if ($sth_ez_denom) {
                    $sth_ez_denom->execute($repID, $qdate1, $qdate2, $agent);
                    $ez_denom = $sth_ez_denom->fetchrow() || 0;
                    $sth_ez_denom->finish();
                } else {
                    warn "Error preparing EZ denom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $ez_percent = checkDenom($ez_nom,$ez_denom);
                $ws->write($row,$col++,$ez_percent,$formatPercentTotals);
                #Stops
                my ($stop_nom, $stop_denom) = (0, 0);
                my $stop_nom_query = $basequery . "and b.stopSave = 1";
                my $sth_stop_nom = $dbMySQL1->prepare($stop_nom_query);
                if ($sth_stop_nom) {
                    $sth_stop_nom->execute($repID, $qdate1, $qdate2, $agent);
                    $stop_nom = $sth_stop_nom->fetchrow() || 0;
                    $sth_stop_nom->finish();
                } else {
                    warn "Error preparing Stop nom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $stop_denom_query = $basequery . "and b.stopSave in (1,2)";
                my $sth_stop_denom = $dbMySQL1->prepare($stop_denom_query);
                if ($sth_stop_denom) {
                    $sth_stop_denom->execute($repID, $qdate1, $qdate2, $agent);
                    $stop_denom = $sth_stop_denom->fetchrow() || 0;
                    $sth_stop_denom->finish();
                } else {
                    warn "Error preparing Stop denom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $stop_percent = checkDenom($stop_nom,$stop_denom);
                $ws->write($row,$col++,$stop_percent,$formatPercentTotals);
                #Vacation
                my ($vac_nom, $vac_denom) = (0, 0);
                my $vac_nom_query = $basequery . "and b.vacationSave = 1";
                my $sth_vac_nom = $dbMySQL1->prepare($vac_nom_query);
                if ($sth_vac_nom) {
                    $sth_vac_nom->execute($repID, $qdate1, $qdate2, $agent);
                    $vac_nom = $sth_vac_nom->fetchrow() || 0;
                    $sth_vac_nom->finish();
                } else {
                    warn "Error preparing Vacation nom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $vac_denom_query = $basequery . "and b.vacationSave in (1,2)";
                my $sth_vac_denom= $dbMySQL1->prepare($vac_denom_query);
                if ($sth_vac_denom) {
                    $sth_vac_denom->execute($repID, $qdate1, $qdate2, $agent);
                    $vac_denom = $sth_vac_denom->fetchrow() || 0;
                    $sth_vac_denom->finish();
                } else {
                    warn "Error preparing Vacation denom query (weekly agent): $dbMySQL1->errstr\n";
                }
                my $vac_percent = checkDenom($vac_nom,$vac_denom);
                $ws->write($row,$col++,$vac_percent,$formatPercentTotals);
                #$email, $declined, $onfile
                $ws->write($row,$col++,$email,$formatnum);
                $ws->write($row,$col++,$declined,$formatnum);
                $ws->write($row,$col++,$onfile,$formatnum);
                $row++;

                #end emp loop
            }
        }
        $sth_agent->finish();
    }
}
sub agent_details_worksheet{
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $qdate = isodate($date);
    my $row = 3;
    my $col = 0;
    #First We make the Title Row
    $ws->set_row($row,40);
    $ws->write($row, $col, 'Agent Name', $formatTitleRow);
    $ws->set_column($col,$col,25);
    $col++;
    $ws->write($row, $col, 'Total Calls', $formatTitleRow);
    $ws->set_column($col,$col,11);
    $col++;
    $ws->write($row, $col, 'AVG Talk Time', $formatTitleRow);
    $ws->set_column($col,$col,14);
    $col++;
    $ws->write($row, $col, 'AVG ACW Time', $formatTitleRow);
    $ws->set_column($col,$col,14);
    $col++;
    $ws->write($row, $col, 'AVG Call Length', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Total Talk Time', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Total ACW Time', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Total Time', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    my $qryDesc = qq~select s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                        from TPS.Snowfly s
                        inner join inboundAgentDisposition i
                            on i.statusGroup = s.statusGroup
                            and i.statusCode = s.statusCode
                            and i.statusDetail = s.statusDetail
                        where i.callDate = ?
                          and i.reportID = ?
                        group by s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                        order by i.statusGroup asc, i.statusCode asc, i.statusDetail asc~;
    #print "$qryDesc\n";
    my $head = $dbMySQL1->prepare($qryDesc);
    unless ($head) {
        warn "Error preparing status description query (daily agent): $dbMySQL1->errstr\n";
    } else {
        my $head_result = $head->execute($qdate, $repID);
        unless ($head_result) {
            warn "Error executing status description query (daily agent): $head->errstr\n";
        } else {
            while (my ($desc,$group, $code, $detail) = $head->fetchrow()) {
                $ws->write($row, $col, $desc, $formatTitleRow);
                $ws->set_column($col,$col,10);
                $col++;
            }
        }
        $head->finish();
    }
    $ws->write($row, $col, 'PIA %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'EZ %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'SAVE %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'VAC %', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Emails Collected', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Emails Declined', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $col++;
    $ws->write($row, $col, 'Email on File', $formatTitleRow);
    $ws->set_column($col,$col,10);
    $row++;
    #Set up agent loop
    my $agent_query = "Select i.agentID, L_Name, F_Name from TPS.inboundAgentDisposition i left outer join `TPS`.`Emp_Table` e on i.agentid = e.ID_Employee where reportID = ? and calldate = ? group by agentid, L_Name, F_Name order by L_Name asc, F_Name asc";
    #print "$query\n";
    my $sth_agent = $dbMySQL1->prepare($agent_query);
    unless ($sth_agent) {
        warn "Error preparing agent list query (daily): $dbMySQL1->errstr\n";
    } else {
        my $agent_result = $sth_agent->execute($repID, $qdate);
        unless ($agent_result) {
            warn "Error executing agent list query (daily): $sth_agent->errstr\n";
        } else {
            while (my ($agent, $lname, $fname) = $sth_agent->fetchrow()) {
                $col = 0;
                my $fullname = "UNKNOWN - $agent";
                if (length($lname) > 0) {
                    $fullname = "$lname, $fname - $agent";
                }
                $ws->write($row,$col++,$fullname,$formattextleft);
                #get stats
                my $stats_query = qq~Select sum(`count`), sum(talkTime), sum(wrapTime), sum(waitTime), sum(emails), sum(declinedEmail), sum(emailonfile)
                                    from inboundAgentDisposition
                                    where agentid = ?
                                      and reportID = ?
                                      and calldate = ?~;
                my $sth_stats = $dbMySQL1->prepare($stats_query);
                my ($calls, $talk, $wrap, $wait, $email, $declined, $onfile) = (0) x 7;
                unless ($sth_stats) {
                    warn "Error preparing agent stats query (daily): $dbMySQL1->errstr\n";
                } else {
                    my $stats_result = $sth_stats->execute($agent, $repID, $qdate);
                    if ($stats_result) {
                        ($calls, $talk, $wrap, $wait, $email, $declined, $onfile) = $sth_stats->fetchrow();
                    } else {
                        warn "Error executing agent stats query (daily) for agent $agent: $sth_stats->errstr\n";
                    }
                    $sth_stats->finish();
                }
                #total calls
                $ws->write($row,$col++,$calls,$formatnum);
                my $avg_talk = checkDenom($talk,$calls);
                my $formula_talk = "=$avg_talk/86400";
                $ws->write($row,$col++,$formula_talk,$formatTime);
                my $avg_wrap = checkDenom($wrap,$calls);
                my $formula_wrap = "=$avg_wrap/86400";
                $ws->write($row,$col++,$formula_wrap,$formatTime);
                my $avg_handle = checkDenom(($talk+$wrap),$calls);
                my $formula_handle = "=$avg_handle/86400";
                $ws->write($row,$col++,$formula_handle,$formatTime);
                my $total_talk = $talk;
                my $formula_total_talk = "=$total_talk/86400";
                $ws->write($row,$col++,$formula_total_talk,$formatTimeH);
                my $total_wrap = $wrap;
                my $formula_total_wrap = "=$total_wrap/86400";
                $ws->write($row,$col++,$formula_total_wrap,$formatTimeH);
                my $total_time = $wrap+$talk;
                my $formula_total_time = "=$total_time/86400";
                $ws->write($row,$col++,$formula_total_time,$formatTimeH);
                my $desc_query = qq~select s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                                    from TPS.Snowfly s
                                    inner join inboundAgentDisposition i
                                        on i.statusGroup = s.statusGroup
                                        and i.statusCode = s.statusCode
                                        and i.statusDetail = s.statusDetail
                                    where i.callDate = ?
                                      and i.reportID = ?
                                    group by s.statusText, s.statusGroup, s.statusCode, s.statusDetail
                                    order by i.statusGroup asc, i.statusCode asc, i.statusDetail asc~;
                my $sth_desc = $dbMySQL1->prepare($desc_query);
                if ($sth_desc) {
                    $sth_desc->execute($qdate, $repID);
                    while (my ($text, $group, $code, $detail) = $sth_desc->fetchrow()) {
                        my $count = 0;
                        my $dispo_count_query = "Select sum(`count`) from inboundAgentDisposition where agentid = ? and reportID = ? and callDate = ? and statusGroup = ? and statusDetail = ? and statusCode = ? ";
                        my $sth_count = $dbMySQL1->prepare($dispo_count_query);
                        if ($sth_count) {
                            $sth_count->execute($agent, $repID, $qdate, $group, $detail, $code);
                            if ($sth_count->execute()) {
                                $count = $sth_count->fetchrow();
                                $count = 0 if (!defined $count);
                            } else {
                                warn "Error executing disposition count query (daily agent) for agent $agent, status $text: $sth_count->errstr\n";
                            }
                            $sth_count->finish();
                        } else {
                            warn "Error preparing disposition count query (daily agent) for agent $agent, status $text: $dbMySQL1->errstr\n";
                        }
                        $ws->write($row,$col++,$count,$formatnum);
                    }
                    $sth_desc->finish();
                } else {
                    warn "Error preparing status description query (inner loop daily agent): $dbMySQL1->errstr\n";
                }
                #Percents on the end and emails
                #set up base query
                my $basequery = qq~SELECT sum(`count`)
                                    FROM TPS.inboundAgentDisposition a
                                    inner join Snowfly b
                                        on a.statusgroup = b.statusgroup
                                        and a.statuscode = b.statuscode
                                        and a.statusdetail = b.statusdetail
                                    where reportID = ?
                                      and calldate = ?
                                      and agentid = ? ~;
                #add qualifiers for percentage
                #PIA
                my ($pia_nom, $pia_denom) = (0, 0);
                my $pia_nom_query = $basequery . "and b.paidInAdvance = 1";
                my $sth_pia_nom = $dbMySQL1->prepare($pia_nom_query);
                if ($sth_pia_nom) {
                    $sth_pia_nom->execute($repID, $qdate, $agent);
                    $pia_nom = $sth_pia_nom->fetchrow() || 0;
                    $sth_pia_nom->finish();
                } else {
                    warn "Error preparing PIA nom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $pia_denom_query = $basequery . "and b.paidInAdvance in (1,2)";
                my $sth_pia_denom = $dbMySQL1->prepare($pia_denom_query);
                if ($sth_pia_denom) {
                    $sth_pia_denom->execute($repID, $qdate, $agent);
                    $pia_denom = $sth_pia_denom->fetchrow() || 0;
                    $sth_pia_denom->finish();
                } else {
                    warn "Error preparing PIA denom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $pia_percent = checkDenom($pia_nom,$pia_denom);
                $ws->write($row,$col++,$pia_percent,$formatPercentTotals);
                #EZ
                my ($ez_nom, $ez_denom) = (0, 0);
                my $ez_nom_query = $basequery . "and b.ezPay = 1";
                my $sth_ez_nom = $dbMySQL1->prepare($ez_nom_query);
                if ($sth_ez_nom) {
                    $sth_ez_nom->execute($repID, $qdate, $agent);
                    $ez_nom = $sth_ez_nom->fetchrow() || 0;
                    $sth_ez_nom->finish();
                } else {
                    warn "Error preparing EZ nom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $ez_denom_query = $basequery . "and b.ezPay in (1,2)";
                my $sth_ez_denom = $dbMySQL1->prepare($ez_denom_query);
                if ($sth_ez_denom) {
                    $sth_ez_denom->execute($repID, $qdate, $agent);
                    $ez_denom = $sth_ez_denom->fetchrow() || 0;
                    $sth_ez_denom->finish();
                } else {
                    warn "Error preparing EZ denom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $ez_percent = checkDenom($ez_nom,$ez_denom);
                $ws->write($row,$col++,$ez_percent,$formatPercentTotals);
                #Stops
                my ($stop_nom, $stop_denom) = (0, 0);
                my $stop_nom_query = $basequery . "and b.stopSave = 1";
                my $sth_stop_nom = $dbMySQL1->prepare($stop_nom_query);
                if ($sth_stop_nom) {
                    $sth_stop_nom->execute($repID, $qdate, $agent);
                    $stop_nom = $sth_stop_nom->fetchrow() || 0;
                    $sth_stop_nom->finish();
                } else {
                    warn "Error preparing Stop nom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $stop_denom_query = $basequery . "and b.stopSave in (1,2)";
                my $sth_stop_denom = $dbMySQL1->prepare($stop_denom_query);
                if ($sth_stop_denom) {
                    $sth_stop_denom->execute($repID, $qdate, $agent);
                    $stop_denom = $sth_stop_denom->fetchrow() || 0;
                    $sth_stop_denom->finish();
                } else {
                    warn "Error preparing Stop denom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $stop_percent = checkDenom($stop_nom,$stop_denom);
                $ws->write($row,$col++,$stop_percent,$formatPercentTotals);
                #Vacation
                my ($vac_nom, $vac_denom) = (0, 0);
                my $vac_nom_query = $basequery . "and b.vacationSave = 1";
                my $sth_vac_nom = $dbMySQL1->prepare($vac_nom_query);
                if ($sth_vac_nom) {
                    $sth_vac_nom->execute($repID, $qdate, $agent);
                    $vac_nom = $sth_vac_nom->fetchrow() || 0;
                    $sth_vac_nom->finish();
                } else {
                    warn "Error preparing Vacation nom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $vac_denom_query = $basequery . "and b.vacationSave in (1,2)";
                my $sth_vac_denom = $dbMySQL1->prepare($vac_denom_query);
                if ($sth_vac_denom) {
                    $sth_vac_denom->execute($repID, $qdate, $agent);
                    $vac_denom = $sth_vac_denom->fetchrow() || 0;
                    $sth_vac_denom->finish();
                } else {
                    warn "Error preparing Vacation denom query (daily agent): $dbMySQL1->errstr\n";
                }
                my $vac_percent = checkDenom($vac_nom,$vac_denom);
                $ws->write($row,$col++,$vac_percent,$formatPercentTotals);
                #$email, $declined, $onfile$ws->write($row,$col++,$email,$formatnum);
                $ws->write($row,$col++,$declined,$formatnum);
                $ws->write($row,$col++,$onfile,$formatnum);
                $row++;

                #end emp loop
            }
        }
        $sth_agent->finish();
    }
}
sub inbMetricsDisposition{
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $monday = &getPrevMonday($date);
    my $sunday = &getNextSunday($date);
    my $bweek = &isodate($monday);
    my $eweek = &isodate($sunday);
    my @Days = ('Monday', 'Tuesday', 'Wednesday', 'Thursday','Friday','Saturday', 'Sunday');
    #make temp table for main grid
    my $tempTable = CreateTempDispoTable($dbMySQL1, $repID);
    my $insert_query = qq~Insert into $tempTable (reportID, statusGroup, statusCode, statusDetail)
                           select reportID, statusGroup, statusCode, statusDetail
                           from `TPS`.`inboundDisposition`
                           where reportID = ?
                             and callDate >= ?
                             and callDate <= ?
                           group by reportID, statusGroup, statusCode, statusDetail~;
    #print "$insert_query\n";
    my $sth_insert = $dbMySQL1->prepare($insert_query);
    unless ($sth_insert) {
        warn "Error preparing insert into temp table (inbMetricsDisposition): $dbMySQL1->errstr\n";
    } else {
        $sth_insert->execute($repID, $bweek, $eweek);
        $sth_insert->finish();
    }
    #my $query = qq~Insert into $tempTable (reportID, statusGroup, statusCode, statusDetail) select reportID, statusGroup, statusCode, statusDetail from  `TPS`.`inboundDispositionArchive` where reportID = $repID and callDate >= '$bweek' and callDate <='$eweek' group by reportID, statusGroup, statusCode, statusDetail~;
    #print "$query\n";
    #my $sth = $dbMySQL1->prepare($query);
    #$sth->execute();
    for(my $i = 0; $i <7; $i++)
    {
        my $mover = $i . "D";
        my $today = $monday + $mover;
        my $isoToday = isodate($today);
        my $update_day_query = qq~Update $tempTable a
                                  inner join `TPS`.`inboundDisposition` b
                                      on a.reportID = b.reportID
                                      and a.statusGroup = b.statusGroup
                                      and a.statusCode = b.statusCode
                                      and a.statusDetail = b.statusDetail
                                  set $Days[$i] = `count`
                                  where b.calldate = ?~;
        #print   "************\n$update_day_query\n**************\n";
        my $sth_update_day = $dbMySQL1->prepare($update_day_query);
        unless ($sth_update_day) {
            warn "Error preparing update day count query (inbMetricsDisposition): $dbMySQL1->errstr\n";
        } else {
            $sth_update_day->execute($isoToday);
            $sth_update_day->finish();
        }
    }
    my $ht_query = qq~Select statusGroup, statusCode, statusDetail, sum(talkTime + wrapTime) as HT
                       from `TPS`.`inboundDisposition`
                       where reportID = ?
                         and callDate >= ?
                         and callDate < ?
                       group by statusGroup, statusCode, statusDetail~;
    my $sth_ht = $dbMySQL1->prepare($ht_query);
    unless ($sth_ht) {
        warn "Error preparing handle time query (inbMetricsDisposition): $dbMySQL1->errstr\n";
    } else {
        $sth_ht->execute($repID, $bweek, $eweek);
        while(my($group, $code, $detail, $ht) = $sth_ht->fetchrow())
        {
            my $update_ht_query = qq~Update $tempTable
                                     set HandleTime = ?
                                     where statusGroup = ?
                                       and statusCode = ?
                                       and statusDetail = ?~;
            my $sth_update_ht = $dbMySQL1->prepare($update_ht_query);
            unless ($sth_update_ht) {
                warn "Error preparing update handle time query (inbMetricsDisposition): $dbMySQL1->errstr\n";
            } else {
                $sth_update_ht->execute($ht, $group, $code, $detail);
                $sth_update_ht->finish();
            }
        }
        $sth_ht->finish();
    }
    my $update_desc_query = "Update $tempTable a inner join Snowfly b on a.statusGroup = b.statusGroup and a.statusCode = b.statusCode and a.statusDetail = b.statusDetail set a.Description = b.statusText";
    my $sth_update_desc = $dbMySQL1->prepare($update_desc_query);
    unless ($sth_update_desc) {
        warn "Error preparing update description query (inbMetricsDisposition): $dbMySQL1->errstr\n";
    } else {
        $sth_update_desc->execute();
        $sth_update_desc->finish();
    }
    my $update_other_query = "Update $tempTable set Description = 'Other', statusGroup = 0, statusCode = 1, statusDetail = 2 where Description = '' or Description is null";
    my $sth_update_other = $dbMySQL1->prepare($update_other_query);
    unless ($sth_update_other) {
        warn "Error preparing update other description query (inbMetricsDisposition): $dbMySQL1->errstr\n";
    } else {
        $sth_update_other->execute();
        $sth_update_other->finish();
    }
    my $lstrow = inb_met_dispo($repID, $tempTable, $ws);
    $lstrow = inb_met_dispoTotals($repID, $ws, $monday, $lstrow);
    my $drop_table_query = "Drop table if exists TPS.$tempTable";
    my $sth_drop_table = $dbMySQL1->prepare($drop_table_query);
    unless ($sth_drop_table) {
        warn "Error preparing drop temp table query (inbMetricsDisposition): $dbMySQL1->errstr\n";
    } else {
        $sth_drop_table->execute();
        $sth_drop_table->finish();
    }
}
sub inb_met_dispoTotals{
    my $repID = $_[0];
    my $ws = $_[1];
    my $Mon = $_[2];
    my $startRow = $_[3];
    my $col = 0;
    my $row = $startRow;
    #titles
    $ws->write($row++,$col, 'Total', $formatTotRow);
    $ws->write($row++,$col, 'Total Calls', $formatTotRow);
    $ws->write($row++,$col, 'Total Handled', $formatTotRow);
    $row++;
    $ws->write($row++,$col, 'PIA %', $formatTotRow);
    $ws->write($row++,$col, 'EZ Pay %', $formatTotRow);
    $ws->write($row++,$col, 'Save %', $formatTotRow);
    $ws->write($row++,$col, 'Vacation %', $formatTotRow);
    $ws->write($row++,$col, 'Answer %', $formatTotRow);
    $ws->write($row++,$col, 'Avg Handle Time', $formatTotRow);
    #Insert Talk, Wrap and emails
    $ws->write($row++,$col, 'Avg Talk Time', $formatTotRow);
    $ws->write($row++,$col, 'Avg Wrap Time', $formatTotRow);
    $ws->write($row++,$col, 'Total Talk Time', $formatTotRow);
    $ws->write($row++,$col, 'Total Wrap Time', $formatTotRow);
    $ws->write($row++,$col, 'Emails Collected', $formatTotRow);
    $ws->write($row++,$col, 'Emails %', $formatTotRow);
    $ws->write($row++,$col, 'New Start Emails Collected', $formatTotRow);
    $ws->write($row++,$col, 'New Start Emails %', $formatTotRow);
    $ws->write($row++,$col, 'Emails Declined', $formatTotRow);
    $ws->write($row++,$col, 'Emails Already On File', $formatTotRow);
    #end insert
    $ws->write($row++,$col, 'ASA', $formatTotRow);
    $ws->write($row++,$col, '% Calls Answered In', $formatTotRow);
    $ws->write($row++,$col, '25 Seconds', $formatTotRow);
    $ws->write($row++,$col, '30 Seconds', $formatTotRow);
    $ws->write($row++,$col, '45 Seconds', $formatTotRow);
    $ws->write($row++,$col++, '60 Seconds', $formatTotRow);

    #days of week
    for($i=0;$i<7;$i++){
        my $days = $i . "D";
        my $wday = $Mon+$days;
        my $qdate = isodate($wday);
        $row = $startRow;
        #All calls
        my $calls_query = "Select sum(`count`) from `TPS`.`inboundDisposition` where callDate = ? and reportID = ?";
        my $sth_calls = $dbMySQL1->prepare($calls_query);
        my $totalcalls = 0;
        if ($sth_calls) {
            $sth_calls->execute($qdate, $repID);
            $totalcalls = $sth_calls->fetchrow() || 0;
            $sth_calls->finish();
        } else {
            warn "Error preparing total calls query (inb_met_dispoTotals) for date $qdate: $dbMySQL1->errstr\n";
        }
        $ws->write($row++,$col,$totalcalls,$formatnumTotals);#total Calls
        #print "\nTotalCalls:$totalcalls";
        my $base_query = qq~SELECT sum(`count`)
                             FROM TPS.inboundDisposition a
                             inner join Snowfly b
                                 on a.statusgroup = b.statusgroup
                                 and a.statuscode = b.statuscode
                                 and a.statusdetail = b.statusdetail
                             where reportID = ?
                               and calldate = ?~;
        my $offered_query = $base_query . " And agentOffered !=0";
        my $sth_offered = $dbMySQL1->prepare($offered_query);
        my $agentOffered = 0;
        if ($sth_offered) {
            $sth_offered->execute($repID, $qdate);
            $agentOffered = $sth_offered->fetchrow() || 0;
            $sth_offered->finish();
        } else {
            warn "Error preparing agent offered query (inb_met_dispoTotals) for date $qdate: $dbMySQL1->errstr\n";
        }
        #print " agentoffered:$agentOffered";
        $ws->write($row++,$col,$agentOffered,$formatnumTotals);#agent offerred
        my $handled_query = $base_query . " And agentOffered =1";
        my $sth_handled = $dbMySQL1->prepare($handled_query);
        my $agentHandled = 0;
        if ($sth_handled) {
            $sth_handled->execute($repID, $qdate);
            $agentHandled = $sth_handled->fetchrow() || 0;
            $sth_handled->finish();
        } else {
            warn "Error preparing agent handled query (inb_met_dispoTotals) for date $qdate: $dbMySQL1->errstr\n";
        }
        #print "$query\n";
        # print " agenthandled:$agentHandled\n";
        $ws->write($row++,$col,$agentHandled,$formatnumTotals);#agent answered
        $row++;
        my $pia_num_query = $base_query . " And paidInAdvance =1";
        my $pia_denom_query = $base_query . " And paidInAdvance !=0";
        my $piaNum = get_single_value($pia_num_query, $repID, $qdate);
        my $piaDenom = get_single_value($pia_denom_query, $repID, $qdate);
        my $tmp = checkDenom($piaNum,$piaDenom);
        #print "PIA $piaNum,$piaDenom, $tmp\n";
        $ws->write($row++,$col,$tmp,$formatPercentTotals);#pia %
        my $ez_denom_query = $base_query . " And ezPay !=0";
        my $ez_num_query = $base_query . " And ezPay =1";
        my $ezPayDenom = get_single_value($ez_denom_query, $repID, $qdate);
        my $ezPayNum = get_single_value($ez_num_query, $repID, $qdate);
        $tmp = checkDenom($ezPayNum,$ezPayDenom);
        $ws->write($row++,$col,$tmp,$formatPercentTotals);#EZ Pay %
        my $stop_num_query = $base_query . " And stopSave =1" ;
        my $stop_denom_query = $base_query . " And stopSave !=0";
        my $stopNum = get_single_value($stop_num_query, $repID, $qdate);
        my $stopDenom = get_single_value($stop_denom_query, $repID, $qdate);
        $tmp =  checkDenom($stopNum,$stopDenom);
        $ws->write($row++,$col,$tmp,$formatPercentTotals);#Stop SAve%
        my $vac_denom_query = $base_query . " And vacationSave !=0";
        my $vac_num_query = $base_query . " And vacationSave =1";
        my $vacDenom = get_single_value($vac_denom_query, $repID, $qdate);
        my $vacNum = get_single_value($vac_num_query, $repID, $qdate);
        $tmp =  checkDenom($vacNum,$vacDenom);
        $ws->write($row++,$col,$tmp,$formatPercentTotals);#VAc Pac%
        $tmp =  checkDenom($agentHandled,$agentOffered);
        $ws->write($row++,$col,$tmp,$formatPercentTotals);#Anser %
        my $ht_query = "Select sum(talkTime + wrapTime) from `TPS`.`inboundDisposition` where callDate = ? and reportID = ?";
        my $avgHT_val = get_single_value($ht_query, $qdate, $repID);
        my $avgHT = checkDenom($avgHT_val,$agentHandled);
        $tmp = qq~=($avgHT)/86400~;
       # print "\n*****$tmp****\n";
        $ws->write($row++,$col,$tmp,$formatTimeTotals);#Average Handle
        my $talk_query = "Select sum(talkTime) from `TPS`.`inboundDisposition` where callDate = ? and reportID = ?";
        #Add total talk
        my $totTalk = get_single_value($talk_query, $qdate, $repID);
        my $avgTK = checkDenom($totTalk,$agentHandled);
        $tmp = qq~=($avgTK)/86400~;
        $ws->write($row++,$col,$tmp,$formatTimeTotals);#Average Talk
        my $wrap_query = "Select sum(wrapTime) from `TPS`.`inboundDisposition` where callDate = ? and reportID = ?";
        #add total wrap
        my $totWrap = get_single_value($wrap_query, $qdate, $repID);
        my $avgWRAP = checkDenom($totWrap,$agentHandled);
        $tmp = qq~=($avgWRAP)/86400~;
        $ws->write($row++,$col,$tmp,$formatTimeTotals);#Average Wrap
##########################################################################
#todo Add in total times here
        $ws->write($row++,$col,($totTalk/60),$formatnum2dTotals);#total talk
        $ws->write($row++,$col,($totWrap/60),$formatnum2dTotals);#total talk
##########################################################################
        my $email_query = "Select sum(emails), sum(declinedEmail), sum(emailOnFile) from `TPS`.`inboundDisposition` where callDate = ? and reportID = ?";
        my $sth_email = $dbMySQL1->prepare($email_query);
        my ($email, $declinedEmail, $emailOnFile) = (0) x 3;
        if ($sth_email) {
            $sth_email->execute($qdate, $repID);
            ($email, $declinedEmail, $emailOnFile) = $sth_email->fetchrow() || (0) x 3;
            $sth_email->finish();
        } else {
            warn "Error preparing email stats query (inb_met_dispoTotals) for date $qdate: $dbMySQL1->errstr\n";
        }
        $ws->write($row++,$col,$email,$formatnumTotals);#emails collected
        $tmp =  checkDenom($email,$agentHandled);
        $ws->write($row++,$col,$tmp,$formatPercentTotals);
        my $sale_email_query = qq~SELECT sum(emails)
                                 FROM TPS.inboundDisposition a
                                 inner join Snowfly b
                                     on a.statusgroup = b.statusgroup
                                     and a.statuscode = b.statuscode
                                     and a.statusdetail = b.statusdetail
                                 where reportID = ?
                                   and calldate = ?
                                   And paidInAdvance !=0~;
        my $saleEmail = get_single_value($sale_email_query, $repID, $qdate);
        $ws->write($row++,$col,$saleEmail,$formatnumTotals);#emails on sales
        $tmp = checkDenom($saleEmail,$piaDenom);
        $ws->write($row++,$col,$tmp,$formatPercentTotals);
        $ws->write($row++,$col,$declinedEmail,$formatnumTotals);
        $ws->write($row++,$col,$emailOnFile,$formatnumTotals);
        my $wait_query = "Select sum(waitTime) from `TPS`.`inboundDisposition` where callDate = ? and reportID = ?";
        my $avgWAIT_val = get_single_value($wait_query, $qdate, $repID);
        my $avgWAIT = checkDenom($avgWAIT_val,$agentHandled);
        $tmp = qq~=($avgWAIT)/86400~;
        $ws->write($row++,$col,$tmp,$formatTimeTotals);#Average Wait
        my $sl_query = qq~select answerPercent25, answerPercent30, answerPercent45, answerPercent60
                           from TPS.inboundMetricsServiceLevel
                           where reportID = ?
                             and callDate = ?~;
        my $sth_sl = $dbMySQL1->prepare($sl_query);
        my ($ap25, $ap30, $ap45, $ap60) = (0) x 4;
        if ($sth_sl) {
            $sth_sl->execute($repID, $qdate);
            ($ap25, $ap30, $ap45, $ap60) = $sth_sl->fetchrow() || (0) x 4;
            $sth_sl->finish();
        } else {
            warn "Error preparing service level query (inb_met_dispoTotals) for date $qdate: $dbMySQL1->errstr\n";
        }
        $row++;
        $ws->write($row++,$col,$ap25,$formatPercentTotals);#Average Wait
        $ws->write($row++,$col,$ap30,$formatPercentTotals);#Average Wait
        $ws->write($row++,$col,$ap45,$formatPercentTotals);#Average Wait
        $ws->write($row++,$col,$ap60,$formatPercentTotals);#Average Wait
        $col++;
    }
    #totals column
    #add 6 to monday to come up with the end of the week
    my $Sun = $Mon+'6D';
    my $beginweek = isodate($Mon);
    my $endweek =isodate($Sun);
    #copy and paste from above
    $row = $startRow;
    $ws->set_column($col,$col,10);
    #All calls
    my $totalcalls_week_query = "Select sum(`count`) from `TPS`.`inboundDisposition` where callDate >= ? and callDate <= ? and reportID = ?";
    my $totalcalls_week = get_single_value($totalcalls_week_query, $beginweek, $endweek, $repID);
    $ws->write($row++,$col,$totalcalls_week,$formatnumTotals);#total Calls
    my $base_query_week = qq~SELECT sum(`count`)
                               FROM TPS.inboundDisposition a
                               inner join Snowfly b
                                   on a.statusgroup = b.statusgroup
                                   and a.statuscode = b.statuscode
                                   and a.statusdetail = b.statusdetail
                               where reportID = ?
                                 and callDate >= ?
                                 and callDate <= ?~;
    my $offered_week_query = $base_query_week . " And agentOffered !=0";
    my $agentOffered_week = get_single_value($offered_week_query, $repID, $beginweek, $endweek);
    $ws->write($row++,$col,$agentOffered_week,$formatnumTotals);#agent offerred
    my $handled_week_query = $base_query_week . " And agentOffered =1";
    my $agentHandled_week = get_single_value($handled_week_query, $repID, $beginweek, $endweek);
    $ws->write($row++,$col,$agentHandled_week,$formatnumTotals);#agent answered
    $row++;
    my $pia_num_week_query = $base_query_week . " And paidInAdvance =1";
    my $pia_denom_week_query = $base_query_week . " And paidInAdvance !=0";
    my $piaNum_week = get_single_value($pia_num_week_query, $repID, $beginweek, $endweek);
    my $piaDenom_week = get_single_value($pia_denom_week_query, $repID, $beginweek, $endweek);
    my $tmp_week_pia = checkDenom($piaNum_week,$piaDenom_week);
    $ws->write($row++,$col,$tmp_week_pia,$formatPercentTotals);#pia %
    my $ez_denom_week_query = $base_query_week . " And ezPay !=0";
    my $ez_num_week_query = $base_query_week . " And ezPay =1";
    my $ezPayDenom_week = get_single_value($ez_denom_week_query, $repID, $beginweek, $endweek);
    my $ezPayNum_week = get_single_value($ez_num_week_query, $repID, $beginweek, $endweek);
    my $tmp_week_ez = checkDenom($ezPayNum_week,$ezPayDenom_week);
    $ws->write($row++,$col,$tmp_week_ez,$formatPercentTotals);#EZ Pay %
    my $stop_num_week_query = $base_query_week . " And stopSave =1" ;
    my $stop_denom_week_query = $base_query_week . " And stopSave !=0";
    my $stopNum_week = get_single_value($stop_num_week_query, $repID, $beginweek, $endweek);
    my $stopDenom_week = get_single_value($stop_denom_week_query, $repID, $beginweek, $endweek);
    my $tmp_week_stop =  checkDenom($stopNum_week,$stopDenom_week);
    $ws->write($row++,$col,$tmp_week_stop,$formatPercentTotals);#Stop SAve%
    my $vac_denom_week_query = $base_query_week . " And vacationSave !=0";
    my $vac_num_week_query = $base_query_week . " And vacationSave =1";
    my $vacDenom_week = get_single_value($vac_denom_week_query, $repID, $beginweek, $endweek);
    my $vacNum_week = get_single_value($vac_num_week_query, $repID, $beginweek, $endweek);
    my $tmp_week_vac =  checkDenom($vacNum_week,$vacDenom_week);
    $ws->write($row++,$col,$tmp_week_vac,$formatPercentTotals);#VAc Pac%
    my $answer_week =  checkDenom($agentHandled_week,$agentOffered_week);
    $ws->write($row++,$col,$answer_week,$formatPercentTotals);#Anser %
    my $ht_week_query = "Select sum(talkTime + wrapTime) from `TPS`.`inboundDisposition` where callDate >= ? and callDate <= ? and reportID = ?";
    my $avgHT_week_val = get_single_value($ht_week_query, $beginweek, $endweek, $repID);
    my $avgHT_week = checkDenom($avgHT_week_val,$agentHandled_week);
    my $tmp_week_ht = qq~=($avgHT_week)/86400~;
   # print "\n*****$tmp****\n";
    $ws->write($row++,$col,$tmp_week_ht,$formatTimeTotals);#Average Handle
    my $talk_week_query = "Select sum(talkTime) from `TPS`.`inboundDisposition` where callDate >= ? and callDate <= ? and reportID = ?";
    my $totTalk_week = get_single_value($talk_week_query, $beginweek, $endweek, $repID);#Added Total
    my $avgTK_week = checkDenom($totTalk_week,$agentHandled_week);
    my $tmp_week_tk = qq~=($avgTK_week)/86400~;
    $ws->write($row++,$col,$tmp_week_tk,$formatTimeTotals);#Average Talk
    my $wrap_week_query = "Select sum(wrapTime) from `TPS`.`inboundDisposition` where callDate >= ? and callDate <= ? and reportID = ?";
    my $totWrap_week = get_single_value($wrap_week_query, $beginweek, $endweek, $repID);#Added Total wrap
    my $avgWRAP_week = checkDenom($totWrap_week,$agentHandled_week);
    my $tmp_week_wrap = qq~=($avgWRAP_week)/86400~;
    $ws->write($row++,$col,$tmp_week_wrap,$formatTimeTotals);#Average Wrap
########################################################################
#Added total talk and wrap
    $ws->write($row++,$col,($totTalk_week/60),$formatnum2dTotals);
    $ws->write($row++,$col,($totWrap_week/60),$formatnum2dTotals);
########################################################################
    my $email_week_query = "Select sum(emails), sum(declinedEmail), sum(emailOnFile) from `TPS`.`inboundDisposition` where callDate >= ? and callDate <= ? and reportID = ?";
    my $sth_email_week = $dbMySQL1->prepare($email_week_query);
    my ($email_week, $declinedEmail_week, $emailOnFile_week) = (0) x 3;
    if ($sth_email_week) {
        $sth_email_week->execute($beginweek, $endweek, $repID);
        ($email_week, $declinedEmail_week, $emailOnFile_week) = $sth_email_week->fetchrow() || (0) x 3;
        $sth_email_week->finish();
    } else {
        warn "Error preparing weekly email stats query (inb_met_dispoTotals): $dbMySQL1->errstr\n";
    }
    $ws->write($row++,$col,$email_week,$formatnumTotals);#emails collected
    my $email_percent_week =  checkDenom($email_week,$agentHandled_week);
    $ws->write($row++,$col,$email_percent_week,$formatPercentTotals);
    my $sale_email_week_query = qq~SELECT sum(emails)
                                     FROM TPS.inboundDisposition a
                                     inner join Snowfly b
                                         on a.statusgroup = b.statusgroup
                                         and a.statuscode = b.statuscode
                                         and a.statusdetail = b.statusdetail
                                     where reportID = ?
                                       and callDate >= ?
                                       and callDate <= ?
                                       And paidInAdvance !=0~;
    my $saleEmail_week = get_single_value($sale_email_week_query, $repID, $beginweek, $endweek);
    $ws->write($row++,$col,$saleEmail_week,$formatnumTotals);#emails on sales
    my $sale_email_percent_week = checkDenom($saleEmail_week,$piaDenom_week);
    $ws->write($row++,$col,$sale_email_percent_week,$formatPercentTotals);
    $ws->write($row++,$col,$declinedEmail_week,$formatnumTotals);
    $ws->write($row++,$col,$emailOnFile_week,$formatnumTotals);
    my $wait_week_query = "Select sum(waitTime) from `TPS`.`inboundDisposition` where callDate >= ? and callDate <= ? and reportID = ?";
    my $avgWAIT_week_val = get_single_value($wait_week_query, $beginweek, $endweek, $repID);
    my $avgWAIT_week = checkDenom($avgWAIT_week_val,$agentHandled_week);
    my $tmp_week_wait = qq~=($avgWAIT_week)/86400~;
    $ws->write($row++,$col,$tmp_week_wait,$formatTimeTotals);#Average Wait
    #service level changes drastically
    my $sl_week_query = qq~select sum(25n), sum(30n), sum(45n), sum(60n), sum(denominator)
                              from TPS.inboundMetricsServiceLevel
                              where reportID = ?
                                and callDate >= ?
                                and callDate <= ?~;
    my $sth_sl_week = $dbMySQL1->prepare($sl_week_query);
    my ($ap25_week, $ap30_week, $ap45_week, $ap60_week, $denom_week) = (0) x 5;
    if ($sth_sl_week) {
        $sth_sl_week->execute($repID, $beginweek, $endweek);
        ($ap25_week, $ap30_week, $ap45_week, $ap60_week, $denom_week)= $sth_sl_week->fetchrow() || (0) x 5;
        if($denom_week>0){
            $ap25_week = $ap25_week/$denom_week;
            $ap30_week=$ap30_week/$denom_week;
            $ap45_week = $ap45_week/$denom_week;
            $ap60_week = $ap60_week/$denom_week;
        }
        $sth_sl_week->finish();
    } else {
        warn "Error preparing weekly service level query (inb_met_dispoTotals): $dbMySQL1->errstr\n";
    }
    $row++;
    $ws->write($row++,$col,$ap25_week,$formatPercentTotals);#Average Wait
    $ws->write($row++,$col,$ap30_week,$formatPercentTotals);#Average Wait
    $ws->write($row++,$col,$ap45_week,$formatPercentTotals);#Average Wait
    $ws->write($row++,$col,$ap60_week,$formatPercentTotals);#Average Wait
}

sub get_single_value {
    my ($query, @params) = @_;
    my $sth = $dbMySQL1->prepare($query);
    if ($sth) {
        $sth->execute(@params);
        my $result = $sth->fetchrow();
        $sth->finish();
        return $result;
    } else {
        warn "Error preparing query: $dbMySQL1->errstr\n";
        return 0;
    }
}
sub checkDenom {
    my $num = $_[0];
    my $denom = $_[1];
    #print "check Denom $denom\n";
    if ($denom > 0) {
        my $tmp = $num / $denom;
        #print "$tmp =  $num / $denom\n";
        return $tmp;
    } else {
        return 0;
    }
}

sub getcount {
    my $query = $_[0];
    #print "$query\n";
    my $sth = $dbMySQL1->prepare($query);
    my $result = $sth->execute();
    #print "my Result = $result\n";
    if ($result != 0) {
        my $tmp = $sth->fetchrow();
        $tmp = 0 if (!defined($tmp)); 
        #print "Outcome: $tmp\n";
        $sth->finish(); # Finish the statement handle here
        return $tmp;
    } else {
        $sth->finish(); # Also finish the statement handle in the else block
        return 0;
    }
}
sub inb_met_dispo {
    my $repID = $_[0];
    my $tmpTable = $_[1];
    my $ws = $_[2];
    my $querydesc = qq~SELECT Description FROM $tmpTable ORDER BY statusGroup, statusCode, statusDetail~;
    #print "GetCRCs:\n$querydesc\n";
    my $sth_desc = $dbMySQL1->prepare($querydesc);
    unless ($sth_desc) {
        warn "Error preparing description query (inb_met_dispo): $dbMySQL1->errstr\n";
        return 3; # Return initial row in case of error
    }
    #get Other catagory
    my $query_other = qq~SELECT Description FROM $tmpTable ORDER BY statusGroup, statusCode, statusDetail~;
    #Write Headings
    #print "Write Headers\n";
    my $row = 3;
    my $col = 0;
    $ws->set_row($row, 40);
    $ws->write($row, $col, 'Disposition', $formatTitleRow);
    $ws->set_column($col, $col, 30);
    $row++;
    $sth_desc->execute();
    while (my $title = $sth_desc->fetchrow()) {
        $ws->write($row, $col, $title, $formatTotRow);
        $row++;
    }
    $sth_desc->finish();

    $col++;
    my @Days = ('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
    my $daylist;
    foreach my $day (@Days) {
        $row = 3;
        $ws->set_column($col, $col, 12);
        $ws->write($row, $col, $day, $formatTotRow);
        $row++;
        my $query_day = qq~SELECT $day FROM $tmpTable ORDER BY statusGroup, statusCode, statusDetail~;
        makeRows($row, $col, $query_day, $ws);
        if (!defined($daylist)) {
            $daylist = $day;
        } else {
            $daylist .= " + $day";
        }
        $col++;
    }

    #make Total Column
    my $query_total = qq~SELECT ($daylist) AS mySum, HandleTime FROM $tmpTable ORDER BY statusGroup, statusCode, statusDetail~;
    #print "$daylist - - $query_total\n";
    my $sth_total = $dbMySQL1->prepare($query_total);
    unless ($sth_total) {
        warn "Error preparing total/handle time query (inb_met_dispo): $dbMySQL1->errstr\n";
        return $row; # Return current row in case of error
    }
    $sth_total->execute();
    $row = 3;
    $ws->write($row, $col, 'Total', $formatTotRow);
    $ws->write($row++, ($col + 1), 'Handle Time', $formatTotRow);
    $ws->set_column($col, ($col + 1), 12);
    while (my ($total, $ht) = $sth_total->fetchrow()) {
        $ws->write($row, $col, $total, $formatTotRow);
        my $formula;
        if ($total > 0 && defined $ht) {
            $formula = "=" . ($ht / $total) . "/86400";
        } else {
            $formula = 0;
        }
        $ws->write($row, ($col + 1), $formula, $formatTimeTotals);
        $row++;
    }
    $sth_total->finish();
    return $row;
}

sub makeRows {
    my ($startRow, $col, $query, $ws) = @_;
    my $row = $startRow;
    my $rows_sth = $dbMySQL1->prepare($query);
    unless ($rows_sth) {
        warn "Error preparing data row query (makeRows): $dbMySQL1->errstr\n";
        return;
    }
    my $result = $rows_sth->execute();
    #print "my Result = $result\n";

    while (my ($title) = $rows_sth->fetchrow()) {
        #print "I am here: $title\n";
        $ws->write($row, $col, $title, $formatnumTotals); # Changed formattextright to formatnumTotals
        $row++;
    }
    $rows_sth->finish();
}
sub DropTempTable {
    my $db = $_[0];
    my $repID = $_[1];
    my $tempTable = $repID . "_inboundMetricsDispoTemp";
    my $query_show = "Show Tables like '$tempTable'";
    my $sth_show = $db->prepare($query_show);
    my $result_show = $sth_show->execute();
    if ($result_show != 0) {
        my $query_drop = "Drop table if exists TPS.$tempTable";
        my $sth_drop = $db->prepare($query_drop);
        $sth_drop->execute();
        $sth_drop->finish();
    }
    $sth_show->finish();
}
sub CreateTempDispoTable {
    #create Temp table for callstatus for comparison
    my $db = $_[0];
    my $repID = $_[1];
    my $tempTable = $repID . "_inboundMetricsDispoTemp";
    my $query_show = "Show Tables like '$tempTable'";
    my $sth_show = $db->prepare($query_show);
    my $result_show = $sth_show->execute();
    if ($result_show != 0) {
        my $query_drop = "Drop table if exists TPS.$tempTable";
        my $sth_drop = $db->prepare($query_drop);
        $sth_drop->execute();
        $sth_drop->finish();
    }
    my $query_create = qq~CREATE  TABLE `TPS`.`$tempTable` (
  `id` INT NOT NULL AUTO_INCREMENT ,
  `reportID` INT NOT NULL DEFAULT 0 ,
  `description` VARCHAR(100) NOT NULL ,
  `statusGroup` INT NOT NULL DEFAULT 0 ,
  `statusCode` INT NOT NULL DEFAULT 0 ,
  `statusDetail` INT NOT NULL DEFAULT 0 ,
  `Monday` INT NOT NULL DEFAULT 0 ,
  `Tuesday` INT NOT NULL DEFAULT 0 ,
  `Wednesday` INT NOT NULL DEFAULT 0 ,
  `Thursday` INT NOT NULL DEFAULT 0 ,
  `Friday` INT NOT NULL DEFAULT 0 ,
  `Saturday` INT NOT NULL DEFAULT 0 ,
  `Sunday` INT NOT NULL DEFAULT 0 ,
  `HandleTime` INT NOT NULL DEFAULT 0 ,
  PRIMARY KEY (`id`) );~;
    my $sth_create = $db->prepare($query_create);
    $sth_create->execute();
    $sth_create->finish();
    return $tempTable;
}
sub CreateTempDispoTableWeekly {
    #create Temp table for callstatus for comparison
    my $db = $_[0];
    my $repID = $_[1];
    my $tempTable = $repID . "_inboundMetricsDispoTempWeekly";
    my $query_show = "Show Tables like '$tempTable'";
    my $sth_show = $db->prepare($query_show);
    my $result_show = $sth_show->execute();
    if ($result_show != 0) {
        my $query_drop = "Drop table if exists TPS.$tempTable";
        my $sth_drop = $db->prepare($query_drop);
        $sth_drop->execute();
        $sth_drop->finish();
    }
    my $query_create = qq~CREATE  TABLE `TPS`.`$tempTable` (
  `id` INT NOT NULL AUTO_INCREMENT ,
  `reportID` INT NOT NULL DEFAULT 0 ,
  `description` VARCHAR(100) NOT NULL ,
  `statusGroup` INT NOT NULL DEFAULT 0 ,
  `statusCode` INT NOT NULL DEFAULT 0 ,
  `statusDetail` INT NOT NULL DEFAULT 0 ,
    `HandleTime` INT NOT NULL DEFAULT 0,~;
    for (my $i = 1; $i < 54; $i++) {
        $query_create .= "`w$i` INT NOT NULL DEFAULT 0 ,";
    }
    $query_create .= qq~ PRIMARY KEY (`id`) );~;
    my $sth_create = $db->prepare($query_create);
    $sth_create->execute();
    $sth_create->finish();
    return $tempTable;
}
sub inbound_metrics_worksheet {
    my $repname = $_[0];
    my $ws = $_[1];
    my $repid = $_[2];
    my $tz = $_[3];
    my $date = $_[4];
    my $per = 0;
    my $query;
    my $sth;
    my $sth2;
    my $totalsrow;
    my $calls;
    my $colStart;

    $totCalls = 0;
    $row = 3;
    $col = 0;
    # First We make the Title Row
    $ws->set_row($row, 40);
    $ws->write($row, $col, 'Time Period', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Avg ANS Time', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Avg Abandon Time', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Agent Handled Calls', $formatTitleRow);
    $ws->set_column($col, $col, 8);
    $col++;
    $ws->write($row, $col, 'Avg Talk Time', $formatTitleRow);
    $ws->set_column($col, $col, 8);
    $col++;
    $ws->write($row, $col, 'Avg ACW Time', $formatTitleRow);
    $ws->set_column($col, $col, 8);
    $col++;
    $ws->write($row, $col, 'Aban Calls', $formatTitleRow);
    $ws->set_column($col, $col, 5);
    $col++;
    $ws->write($row, $col, 'Max Wait for Agent', $formatTitleRow);
    $ws->set_column($col, $col, 9);
    $col++;
    $ws->write($row, $col, '% Ans Calls', $formatTitleRow);
    $ws->set_column($col, $col, 8);
    $col++;
    $ws->write($row, $col, '# of Agents', $formatTitleRow);
    $ws->set_column($col, $col, 7);
    $col++;
    $ws->write($row, $col, 'Calls Per Agent', $formatTitleRow);
    $ws->set_column($col, $col, 9);
    $col++;
    $ws->write($row, $col, 'Total Calls', $formatTitleRow);
    $ws->set_column($col, $col, 8);
    $col++;

    # This is to set the totals row
    $row++;
    $totalsrow = $row;

    # This is where we setup the loop for the hours
    $row++;
    $col = 0;
    $colStart = $col;

    # lets get the day of the week we are processing
    $dayName = &getdatename($date);
    # set up main stat loop
    my $tmpFday = isodate($date);
    my $tmpEday = isodate($date + '1D');
    $query = qq~Select * from TPS.inboundDistribution where reportID = $repid and dateTimeStart >= '$tmpFday' and dateTimeStart < '$tmpEday' order by dateTimeStart~;
    # print "*************\n$query\n****************\n";
    my $mainLoop = $dbMySQL1->prepare($query);
    $mainLoop->execute();
    my $mtOffSet = getMToffset($tz);
    while (my ($id, $datetimestart, $datetimeend, $reportid, $totalacw, $totaltalk, $maxwait, $totalwait, $totalwaitoptout, $countOptOuts, $abandons, $totalabandontime, $countagents, $agentcalls, $callbackrequested, $callbackattempts, $callbackcomplete) = $mainLoop->fetchrow()) {
        $col = $colStart;
        my $agentoffered = $abandons + $agentcalls;
        my $date1 = date $datetimestart;
        my $date2 = date $datetimeend;
        my $label = getTimeforLabel($date1->hour + $mtOffSet, $date1->min) . " - " . getTimeforLabel($date2->hour + $mtOffSet, $date2->min);
        $ws->write($row, $col++, $label, $formattextleft);
        # avg answer time
        if ($agentcalls > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totalwait / $agentcalls), $formatTime);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTime);
        }
        # avg abandon
        if ($abandons > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totalabandontime / $abandons), $formatTime);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTime);
        }
        # Total Agent Calls
        $ws->write($row, $col++, $agentcalls, $formatnum);
        # Avg Talk Time
        if ($agentcalls > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totaltalk / $agentcalls), $formatTime);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTime);
        }
        # Avg ACW
        if ($agentcalls > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totalacw / $agentcalls), $formatTime);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTime);
        }
        # Abandoned Calls
        $ws->write($row, $col++, $abandons, $formattextright);
        # Max Delay
        $ws->write_date_time($row, $col++, &gettime_4excel($maxwait), $formatTime);
        # % answered
        if (($agentoffered) > 0) {
            $ws->write($row, $col++, ($agentcalls) / ($agentoffered), $formatPercent);
        } else {
            $ws->write($row, $col++, 0, $formatPercent);
        }
        # Agents
        $ws->write($row, $col++, $countagents, $formattextright);
        # Calls per Agent
        if ($countagents) {
            $ws->write($row, $col++, ($agentcalls) / $countagents, $formatnum1d);
        } else {
            $ws->write($row, $col++, 0, $formatnum1d);
        }
        # total calls
        $ws->write($row, $col++, $agentoffered, $formattextright);
        $row++;
        # print "Row: $row, Col: $col\n";
    }
    $mainLoop->finish();
    # where statement for total row where reportID = $repid and dateTimeStart >= '$tmpFday' and dateTimeStart <= '$tmpEday'
    # $col = $colstart;
    $query = qq~Select sum(totalACW), sum(totalTalk), max(maxWait), sum(totalWait), sum(totalWaitOptOut), sum(countOptOuts), sum(abandons), sum(totalAbandonTime), max(countAgents), sum(agentCalls), sum(callBackRequested), sum(callBackAttempts), sum(callbackComplete)
          from TPS.inboundDistribution where reportID = $repid and dateTimeStart >= '$tmpFday' and dateTimeStart <= '$tmpEday'~;
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    $row = $totalsrow;
    $col = $colStart;
    # print "Row: $row, Col: $col\n";
    while (my ($totalacw, $totaltalk, $maxwait, $totalwait, $totalwaitoptout, $countOptOuts, $abandons, $totalabandontime, $countagents, $agentcalls, $callbackrequested, $callbackattempts, $callbackcomplete) = $sth->fetchrow()) {
        my $agentoffered = $abandons + $agentcalls;
        # First the totals header
        $ws->write($totalsrow, $col, 'Totals', $formatTotRow);
        $col++;
        # avg answer time
        if ($agentcalls > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totalwait / $agentcalls), $formatTimeTotals);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTimeTotals);
        }
        # avg abandon
        if ($abandons > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totalabandontime / $abandons), $formatTimeTotals);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTimeTotals);
        }
        # Total Agent Calls
        $ws->write($row, $col++, $agentcalls, $formatnumTotals);
        # Avg Talk Time
        if ($agentcalls > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totaltalk / $agentcalls), $formatTimeTotals);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTimeTotals);
        }
        # Avg ACW
        if ($agentcalls > 0) {
            $ws->write_date_time($row, $col++, &gettime_4excel($totalacw / $agentcalls), $formatTimeTotals);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTimeTotals);
        }
        # Abandoned Calls
        $ws->write($row, $col++, $abandons, $formatTotRow);
        # Max Delay
        $ws->write_date_time($row, $col++, &gettime_4excel($maxwait), $formatTimeTotals);
        # % answered
        if (($agentoffered) > 0) {
            $ws->write($row, $col++, ($agentcalls) / ($agentoffered), $formatPercentTotals);
        } else {
            $ws->write($row, $col++, 0, $formatPercentTotals);
        }
        # Agents
        $ws->write($row, $col++, $countagents, $formatTotRow);
        # Calls per Agent
        if ($countagents) {
            $ws->write($row, $col++, ($agentcalls) / $countagents, $formatnum1dTotals);
        } else {
            $ws->write($row, $col++, 0, $formatnum1dTotals);
        }
        # total calls
        $ws->write($row, $col++, $agentoffered, $formatTotRow);
        # print "Row: $row, Col: $col\n";
    }
    $sth->finish();
}
sub getMToffset {
    my $tzID = $_[0];
    my $query = "Select MToffSet from TPS.TimeZones where timeZoneID = $tzID";
    my $sth = $dbMySQL1->prepare($query);
    my $result = $sth->execute();
    my $offset = 0;
    if ($result != 0) {
        $offset = $sth->fetchrow() || 0;
    }
    $sth->finish();
    return $offset;
}

sub writeToLogTable {
    my $logid = $_[0];
    my $data = $_[1];
    my $done = $_[2];
    my $query = qq~Update TPS.inboundReportLog set Description = '$data', completed = $done, currentDateTime = now() where id = $logid~;
    #print "$query\n";
    my $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    $sth->finish();
}
sub gatherDistributionData {
    my $repid = $_[0];
    my $dids = $_[1];
    my $startTime = $_[2];
    my $endTime = $_[3];
    my $db = $_[4];
    my $date = $_[5];
    my $beginTime = buildDateTimewithHour($date, $startTime);
    my $lastTime = buildDateTimewithHour($date, $endTime + 1);
    # print "Gatherdistribution $date\n";
    # Clear out existing data
    my $nextday = $date + '1D';
    my $tmpFday = isodate($date);
    my $tmpEday = isodate($nextday);

    my $query = qq~Select count(*) from `TPS`.`inboundDistribution` where reportID = $repid and dateTimeStart >= '$tmpFday' and datetimestart < '$tmpEday'~;
    my $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    my $result = $sth->fetchrow();
    # print "Mylog Print $result \n*****\n";
    if ($result > 0) {
        # updateto zero
        $query = qq~Update inboundDistribution set totalACW = 0, totalTalk = 0, maxWait = 0, totalWaitOptOut = 0, countOptOuts = 0, abandons = 0, totalAbandonTime = 0, countAgents = 0, agentCalls = 0, callBackRequested = 0, callBackAttempts = 0, callbackComplete = 0
                      where reportID = $repid and dateTimeStart >= '$tmpFday' and datetimestart < '$tmpEday'~;
        # print "$query\n";
        $sth = $dbMySQL1->prepare($query);
        $sth->execute();
        $sth->finish();
    } else {
        # print "Making todays Distro\n";
        makeTodaysDistro($repid, $date, $startTime, $endTime);
    }
    # sleep 30;
    # one big query to grab most of the stats
    $query = qq~select  DATEPART(HOUR, CallLocalTime) as hour,  case
         When DATEPART(n, calllocaltime)<30 then '00'
         else '30'
         end as min,
         cast(datepart(yyyy,Calllocaltime) as varchar(4)) + '-' + cast(datepart(mm,calllocaltime) as varchar(2)) + '-' + cast(datepart(dd,calllocaltime) as varchar(4)) as date,
         SUM(ConvDuration+ ([TotalWaitDuration]-[WaitDuration])) as talk,
         SUM(WrapupDuration) as wrap,
         SUM(case when lastagent > 0 then WaitDuration else 0 end) as Wait,
         0 as maxwait,
         SUM(case when lastagent > 0 then 1 else 0 end) as agentcalls,
         SUM(case when abandon != 0 and lastagent = 0 and waitduration > 15 then 1 else 0 end) as abandons,
         sum(case when abandon != 0 and lastagent = 0 and waitduration > 15  then WaitDuration else 0 end) as abandontime,
         sum(case when calltype = 7 and lastagent >0 then 1 else 0 end) as completedcallbacks
    from HN_Ondata.dbo.ODCalls
    where LastCampaign in ($dids) and calllocaltime >= CAST('$beginTime' as datetime) and CallLocalTime < CAST('$lastTime' as datetime)
group by DATEPART(HOUR, CallLocalTime), case
    When DATEPART(n, calllocaltime)<30 then '00'
    else '30'
    end,cast(datepart(yyyy,Calllocaltime) as varchar(4)) + '-' + cast(datepart(mm,calllocaltime) as varchar(2)) + '-' + cast(datepart(dd,calllocaltime) as varchar(4))
order by hour asc, min asc~;
    print "$query\n";
    $sth = $db->prepare($query);
    $result = $sth->execute();
    # print "Query Result = $result\n";
    while (my ($hr, $min, $today, $talk, $wrap, $wait, $maxwait, $agentCalls, $abandon, $abandontime, $completedcallbacks) = $sth->fetchrow()) {
        # print "Inloop Vals: $hr, $min, $today, $talk, $wrap, $wait, $maxwait, $agentCalls, $abandon, $abandontime, $completedcallbacks\n";
        # need to get $optout $numAgents $cbattempts  $waitoptout
        # build date ranges for subsequent queries
        my $tmpSDate = isodatetime(GetTogetherDate($today, $hr, $min));

        # print "*****\nOriginal Vals = $today, $hr, $min\nStart Date $tmpSDate\n";
        my $tmp = "00";
        if ($min eq "00") {
            $tmp = "30";
        } else {
            $hr++;
        }
        $hr = '00' if ($hr == 24);
        my $tmpEdate = isodatetime(GetTogetherDate($today, $hr, $tmp));
        # print "$tmpEdate*****\n";
        # refind wait time
        # agent calls
        $query = qq~Select count(*) from HN_Ondata.dbo.ODCalls
                    where lastagent >0 and LastCampaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        print "###Agent Calls \n$query\n######\n";
        my $st2 = $db->prepare($query);
        if ($st2->execute()) {
            $agentCalls = $st2->fetchrow();
        } else {
            $agentCalls = 0;
        }
        $query = qq~Select top 1 WaitDuration from HN_Ondata.dbo.ODCalls
                    where lastagent >0 and LastCampaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime) order by WaitDuration desc~;
        print "###MaxWait\n$query\n######\n";
        my $st2 = $db->prepare($query);
        if ($st2->execute()) {
            $maxwait = $st2->fetchrow();
        } else {
            $maxwait = 0;
        }
        print "####MaxWait is $maxwait\n";
        $query = qq~Select sum(WaitDuration) as wait from HN_Ondata.dbo.ODCalls
                    where lastagent = 0 and WaitDuration > 15 and abandon = 1 and firstagent = 0 and LastCampaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $abandontime = $st2->fetchrow();

        $query = qq~Select count(*) from HN_Ondata.dbo.ODCalls
                    where lastagent =0 and LastCampaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime) and abandon = 1 and waitduration > 15~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $abandon = $st2->fetchrow();
        # Find Optouts/Overflow that actually entered into the callback table
        $query = qq~Select count(distinct([DatabaseIndice])) as optouts,
    sum(waitduration) as optoutwait,
    sum(case when (internaltarget != targethour) then 1 else 0 end) as attempted
    from ODCalls a inner join TPS.dbo.CallbackHistory b on a.indice = b.databaseindice
where  calltype = 1 and [Overflow] in (3,1) and Campaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        # print "$query\n";
        my $st2 = $db->prepare($query);
        $st2->execute();
        my ($optout, $waitoptout, $cbattempts) = $st2->fetchrow();
        $query = qq~select COUNT(*) as Count from
 (Select LastAgent from HN_Ondata.dbo.ODCalls where  LastCampaign in ($dids)
 and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)
  and LastAgent > 0 group by LastAgent)DERIVEDTBL~;

        $st2 = $db->prepare($query);
        $st2->execute();
        my $numAgents = $st2->fetchrow();
        $st2->finish();
        # replaces count of completed callbacks originally in main query
        $query = qq~Select count(*) from [TPS].[dbo].[CallbackHistory] a inner join ODCalls b on a.databaseindice = b.indice where campaign in ($dids) and callbacktype = 0 and calltype = 1 and internaltarget = '999999999999' and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $completedcallbacks = $st2->fetchrow();
        $st2->finish();
        # get total acutal inbound calls
        $query = qq~Select count(*) from HN_Ondata.dbo.ODCalls
                    where calltype=1 and LastCampaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)
                     and ([AcceptDuration]>0 or [WaitDuration]>0 or [ConvDuration]>0 or [OverflowDuration]>0 or [WrapupDuration]>0)~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $totInbound = $st2->fetchrow();
        $st2->finish();
        $query = qq~Select sum(duration)/100.0 from [HN_Ondata].[dbo].[ODActions]
                    where CallCampaign in ($dids) and ActionLocalTime >= CAST('$tmpSDate' as datetime) and ActionLocalTime < CAST('$tmpEdate' as datetime) and OriginatorType = 'A'  and State not in (100099,100100,100101)
                    ~;
        print "$query\n";
        $st2 = $db->prepare($query);
        $st2->execute();
        $agentTime = $st2->fetchrow();
        # Adding additional stats for callbacks  2017-08-30
        # callbacks scheduled
        $query = qq~select COUNT(*) from TPS.dbo.CallbackHistory where Campaign in ($dids)and Request >= CAST('$tmpSDate' as datetime) and Request <CAST('$tmpEdate' as datetime)~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $callBacksSched = $st2->fetchrow();
        # print "$query\r\n$callBacksSched\r\n";
        # callbacks made based on request time
        # $query = qq~select COUNT(*) from TPS.dbo.CallbackHistory a inner join HN_Ondata.dbo.ODCalls b on a.DatabaseIndice = b.indice where Campaign in ($dids)and Request >= CAST('$tmpSDate' as datetime) and Request <CAST('$tmpEdate' as datetime) and b.CallType !=1 and b.CallLocalTime >=  CAST('$tmpSDate' as datetime) and b.CallLocalTime <CAST('$tmpEdate' as datetime)~;
        # $st2=$db->prepare($query);
        # $st2->execute();
        # $callBacksMade= $st2->fetchrow();
        # callbacks made based on request time
        $query = qq~select COUNT(*) from TPS.dbo.CallbackHistory a inner join HN_Ondata.dbo.ODCalls b on a.DatabaseIndice = b.indice where Campaign in ($dids)and Request >= CAST('$tmpSDate' as datetime) and Request <CAST('$tmpEdate' as datetime) and b.CallType !=1~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $callBacksMade = $st2->fetchrow();
        print "$query\r\n$callBacksMade\r\n";
        # print "$query\r\n$callBacksMade\r\n";
        # callbacks made based on outbound call time
        $query = qq~select COUNT(*) from TPS.dbo.CallbackHistory a inner join HN_Ondata.dbo.ODCalls b on a.DatabaseIndice = b.indice where Campaign in ($dids)and b.CallLocalTime >=  CAST('$tmpSDate' as datetime) and b.CallLocalTime <CAST('$tmpEdate' as datetime) and b.CallType !=1~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $callBacksPlaced = $st2->fetchrow();
        # print "$query\r\n$callBacksPlaced\r\n";
        # numerator for avg time to first attempt
        $query = qq~select sum(DATEDIFF(SECOND,startTime, endTime)) from
(select a.Indice, min(b.CallLocalTime) as endTime, MIN(a.Request) as startTime from TPS.dbo.CallbackHistory a inner join HN_Ondata.dbo.ODCalls b on a.DatabaseIndice = b.indice
where a.Campaign in ($dids) and  a.Request >= CAST('$tmpSDate' as datetime) and a.Request <CAST('$tmpEdate' as datetime) and b.CallType !=1
group by a.Indice) y~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $numFirstAtt = $st2->fetchrow();
        # print "$query\r\n$numFirstAtt\r\n";
        # Denominator for avg time to first attempt
        $query = qq~select COUNT(*) from
(select b.Indice from TPS.dbo.CallbackHistory a inner join HN_Ondata.dbo.ODCalls b on a.DatabaseIndice = b.indice
where a.Campaign in ($dids) and a.Request >=  CAST('$tmpSDate' as datetime) and a.Request <CAST('$tmpEdate' as datetime) and b.calllocaltime >=  CAST('$tmpSDate' as datetime) and b.calllocaltime <CAST('$tmpEdate' as datetime)
group by b.Indice) x~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $denomFirstAtt = $st2->fetchrow();
        # print "$query\r\n$denomFirstAtt\r\n";
        $st2->finish();
        # check for nulls
        $wrap = 0 if ($wrap eq '');
        $talk = 0 if ($talk eq '');
        $maxwait = 0 if ($maxwait eq '');
        $waitoptout = 0 if (!defined($waitoptout));
        $optouts = 0 if (!defined($optouts));
        $abandon = 0 if (!defined($abandon));
        $abandontime = 0 if (!defined($abandontime));
        $numAgents = 0 if (!defined($numAgents));
        $agentCalls = 0 if (!defined($agentCalls));
        $cbattempts = 0 if (!defined($cbattempts));
        $completedcallbacks = 0 if (!defined($completedcallbacks));
        $totInbound = 0 if (!defined($totInbound));
        $agentTime = 0 if (!defined($agentTime));
        $callBacksSched = 0 if (!defined($callBacksSched));
        $callBacksMade = 0 if (!defined($callBacksMade));
        $numFirstAtt = 0 if (!defined($numFirstAtt));
        $denomFirstAtt = 0 if (!defined($denomFirstAtt));
        $callBacksPlaced = 0 if (!defined($callBacksPlaced));
        # append to mysql database
        $query = qq~Update inboundDistribution set callBackSched=$callBacksSched,callBackMade=$callBacksMade,callBackAttempted=$callBacksPlaced,callBackFirstAttNumerator=$numFirstAtt,callBackFirstAttDenominator=$denomFirstAtt, totalACW = $wrap, totalTalk = $talk, maxWait = $maxwait, totalWaitOptOut = $waitoptout, countOptOuts = $optouts, abandons = $abandon, totalAbandonTime = $abandontime, countAgents = $numAgents, agentCalls = $agentCalls, callBackRequested = $optout, callBackAttempts = $cbattempts, callbackComplete = $completedcallbacks, totalWait = $wait, `totalInbound` = $totInbound, agentTime = $agentTime
                      where reportID = $repid and dateTimeStart = '$tmpSDate'~;
        #print "$query\n";
		$st2 = $dbMySQL1->prepare($query);
        $st2->execute();
        $st2->finish();
    }
    $sth->finish();
}
sub gatherDistributionDataBackUp {
    my $repid = $_[0];
    my $dids = $_[1];
    my $startTime = $_[2];
    my $endTime = $_[3];
    my $db = $_[4];
    my $date = $_[5];
    my $beginTime = buildDateTimewithHour($date, $startTime);
    my $lastTime = buildDateTimewithHour($date, $endTime + 1);
    # print "Gatherdistribution $date\n";
    # Clear out existing data
    my $nextday = $date + '1D';
    my $tmpFday = isodate($date);
    my $tmpEday = isodate($nextday);

    my $query = qq~Select count(*) from `TPS`.`inboundDistribution` where reportID = $repid and dateTimeStart >= '$tmpFday' and datetimestart < '$tmpEday'~;
    my $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    my $result = $sth->fetchrow();
    # print "Mylog Print $result \n*****\n";
    if ($result > 0) {
        # updateto zero
        # $query = qq~Update inboundDistribution set totalACW = 0, totalTalk = 0, maxWait = 0, totalWaitOptOut = 0, countOptOuts = 0, abandons = 0, totalAbandonTime = 0, countAgents = 0, agentCalls = 0, callBackRequested = 0, callBackAttempts = 0, callbackComplete = 0
        #                 where reportID = $repid and dateTimeStart >= '$tmpFday' and datetimestart < '$tmpEday'~;
        # print "$query\n";
        # $sth = $dbMySQL1->prepare($query);
        # $sth->execute();
        # $sth->finish();
    } else {
        # print "Making todays Distro\n";
        makeTodaysDistro($repid, $date, $startTime, $endTime);
    }
    # sleep 30;
    # one big query to grab most of the stats
    $query = qq~select  DATEPART(HOUR, CallLocalTime) as hour,  case
         When DATEPART(n, calllocaltime)<30 then '00'
         else '30'
         end as min,
         cast(datepart(yyyy,Calllocaltime) as varchar(4)) + '-' + cast(datepart(mm,calllocaltime) as varchar(2)) + '-' + cast(datepart(dd,calllocaltime) as varchar(4)) as date,
         SUM(ConvDuration+ ([TotalWaitDuration]-[WaitDuration])) as talk,
         SUM(WrapupDuration) as wrap,
         SUM(case when lastagent > 0 then WaitDuration else 0 end) as Wait,
         MAX(case when lastagent > 0 then WaitDuration else 0 end) as maxwait,
         SUM(case when lastagent > 0 then 1 else 0 end) as agentcalls,
         SUM(case when abandon != 0 and lastagent = 0 and waitduration > 15 then 1 else 0 end) as abandons,
         sum(case when abandon != 0 and lastagent = 0 and waitduration > 15  then WaitDuration else 0 end) as abandontime,
         sum(case when calltype = 7 and lastagent >0 then 1 else 0 end) as completedcallbacks
    from HN_Ondata.dbo.ODCalls
    where LastCampaign in ($dids) and calllocaltime >= CAST('$beginTime' as datetime) and CallLocalTime < CAST('$lastTime' as datetime)
group by DATEPART(HOUR, CallLocalTime), case
    When DATEPART(n, calllocaltime)<30 then '00'
    else '30'
    end,cast(datepart(yyyy,Calllocaltime) as varchar(4)) + '-' + cast(datepart(mm,calllocaltime) as varchar(2)) + '-' + cast(datepart(dd,calllocaltime) as varchar(4))
order by hour asc, min asc~;
    # print "$query\n";
    $sth = $db->prepare($query);
    $result = $sth->execute();
    # print "Query Result = $result\n";
    while (my ($hr, $min, $today, $talk, $wrap, $wait, $maxwait, $agentCalls, $abandon, $abandontime, $completedcallbacks) = $sth->fetchrow()) {
        # print "Inloop Vals: $hr, $min, $today, $talk, $wrap, $wait, $maxwait, $agentCalls, $abandon, $abandontime, $completedcallbacks\n";
        # need to get $optout $numAgents $cbattempts  $waitoptout
        # build date ranges for subsequent queries
        my $tmpSDate = isodatetime(GetTogetherDate($today, $hr, $min));
        # print "*****\nOriginal Vals = $today, $hr, $min\nStart Date $tmpSDate\n";
        my $tmp = "00";
        if ($min eq "00") {
            $tmp = "30";
        } else {
            $hr++;
        }
        $hr = '00' if ($hr == 24);
        my $tmpEdate = isodatetime(GetTogetherDate($today, $hr, $tmp));
        # print "$tmpEdate*****\n";
        # Find Optouts/Overflow that actually entered into the callback table
        $query = qq~Select count(*) as optouts,
    sum(waitduration) as optoutwait,
    sum(case when (internaltarget != targethour) then 1 else 0 end) as attempted
    from ODCalls a inner join TPS.dbo.CallbackHistory b on a.indice = b.databaseindice
where  calltype = 1 and overflowduration >0 and Campaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        # print "$query\n";
        my $st2 = $db->prepare($query);
        $st2->execute();
        my ($optout, $waitoptout, $cbattempts) = $st2->fetchrow();
        $query = qq~select COUNT(*) as Count from
 (Select LastAgent from HN_Ondata.dbo.ODCalls where  LastCampaign in ($dids)
 and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)
  and LastAgent > 0 group by LastAgent)DERIVEDTBL~;

        $st2 = $db->prepare($query);
        $st2->execute();
        my $numAgents = $st2->fetchrow();
        $st2->finish();
        # replaces count of completed callbacks originally in main query
        $query = qq~Select count(*) from [TPS].[dbo].[CallbackHistory] a inner join ODCalls b on a.databaseindice = b.indice where campaign in ($dids) and callbacktype = 0 and calltype = 1 and internaltarget = '999999999999' and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        $st2 = $db->prepare($query);
        $st2->execute();
        $completedcallbacks = $st2->fetchrow();
        $st2->finish();
        # get total acutal inbound calls
        $query = qq~Select count(*) from HN_Ondata.dbo.ODCalls
                    where calltype=1 and LastCampaign in ($dids) and calllocaltime >= CAST('$tmpSDate' as datetime) and CallLocalTime < CAST('$tmpEdate' as datetime)~;
        print "$query\n";
        $st2 = $db->prepare($query);
        $st2->execute();
        $totInbound = $st2->fetchrow();
        $st2->finish();

        # check for nulls
        $wrap = 0 if ($wrap eq '');
        $talk = 0 if ($talk eq '');
        $maxwait = 0 if ($maxwait eq '');
        $waitoptout = 0 if (!defined($waitoptout));
        $optouts = 0 if (!defined($optouts));
        $abandon = 0 if (!defined($abandon));
        $abandontime = 0 if (!defined($abandontime));
        $numAgents = 0 if (!defined($numAgents));
        $agentCalls = 0 if (!defined($agentCalls));
        $cbattempts = 0 if (!defined($cbattempts));
        $completedcallbacks = 0 if (!defined($completedcallbacks));
        $totInbound = 0 if (!defined($totInbound));
        $query = qq~Update inboundDistribution set totalACW = $wrap, totalTalk = $talk, maxWait = $maxwait, totalWaitOptOut = $waitoptout, countOptOuts = $optout, abandons = $abandon, totalAbandonTime = $abandontime, countAgents = $numAgents, agentCalls = $agentCalls, callBackRequested = $optout, callBackAttempts = $cbattempts, callbackComplete = $completedcallbacks, totalWait = $wait, `totalInbound` = $totInbound
                      where reportID = $repid and dateTimeStart = '$tmpSDate'~;
        # print "$query\n";
        $st2 = $dbMySQL1->prepare($query);
        $st2->execute();
        $st2->finish();
    }
    $sth->finish();
}
sub makeTodaysDistro {
    my $repid = $_[0];
    my $day = $_[1];
    my $startTime = $_[2];
    my $endTime = $_[3];
    my $timeDiff = $endTime - $startTime;
    for (my $i = $startTime; $i < $endTime; $i++) {
        my $min = "00";
        my $min2 = "30";
        my $bTime = GetTogetherDate($day->ymd, $i, $min);
        my $eTime = GetTogetherDate($day->ymd, $i, $min2);
        my $query = qq~Insert into TPS.inboundDistribution (dateTimeStart, dateTimeEnd, reportID, totalACW, totalTalk, maxWait, totalWaitOptOut, countOptOuts, abandons, totalAbandonTime, countAgents, agentCalls, callBackRequested, callBackAttempts, callbackComplete)
                                            Values('$bTime', '$eTime', $repid, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)~;
        # print "$query\n";
        my $sth = $dbMySQL1->prepare($query);
        $sth->execute();

        $min = "30";
        $min2 = "00";
        my $nextHour = $i + 1;
        my $bTime = GetTogetherDate($day->ymd, $i, $min);
        my $eTime = GetTogetherDate($day->ymd, $nextHour, $min2);
        $query = qq~Insert into TPS.inboundDistribution (dateTimeStart, dateTimeEnd, reportID, totalACW, totalTalk, maxWait, totalWaitOptOut, countOptOuts, abandons, totalAbandonTime, countAgents, agentCalls, callBackRequested, callBackAttempts, callbackComplete)
                                            Values('$bTime', '$eTime', $repid, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)~;
        $sth = $dbMySQL1->prepare($query);
        $sth->execute();
        $sth->finish();
        # print "$query\n";
    }
}
sub GetTogetherDate {
    my $day = $_[0];
    my $hr = $_[1];
    my $min = $_[2];
    # print "$day $hr:$min\n";
    if (length($hr) == 1) {
        $hr = "0$hr";
    }
    if (length($min) == 1) {
        $min = "0$min";
    }
    return "$day $hr:$min:00";
}

sub writeheader {
    my $ws = $_[0];
    my $title = $_[1];
    my $date = $_[2];

    $ws->set_row(0, 102);
    $ws->set_row(1, 15);
    $ws->set_row(2, 15);
    $ws->insert_image(0, 3, '/home/public/gfx/Press-One_Walllogo_sm.jpg', 5, 0, .63, .63);

    $ws->write(1, 0, 'Date:', $formatTitleBorder);
    $ws->write(1, 1, &plaindate($date), $formatHDate);
    $ws->write(2, 0, 'Report:', $formatTitleBorder);
    $ws->write(2, 1, $title, $formatTitle);
}
sub inbMetricsDispositionbyMonth {
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $monday = &firstdayofyear($date);
    my $sunday = &lastdayofyear($date);
    my $bweek = &isodate($monday);
    my $eweek = &isodate($sunday);
    my $year = $date->year;
    my @Months = ('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December');
    # make temp table for main grid
    my $tempTable = CreateTempDispoTableMonthly($dbMySQL1, $repID);
    # print "****\nMy Temp table is $tempTable\n*****\n";
    # my $query = qq~Insert into $tempTable (reportID, statusGroup, statusCode, statusDetail, description) select i.reportID, i.statusGroup, i.statusCode, i.statusDetail, s.statusText from  `TPS`.`inboundDispositionArchive` i inner join Snowfly s on i.statusGroup = s.statusGroup and i.statusCode = s.statusCode and i.statusDetail = s.statusDetail where i.reportID = $repID and year(i.callDate) = $year group by i.reportID, i.statusGroup, i.statusCode, i.statusDetail~;
    my $query = qq~Insert into $tempTable (reportID, statusGroup, statusCode, statusDetail) select i.reportID, i.statusGroup, i.statusCode, i.statusDetail from  `TPS`.`inboundDispositionArchive` i where i.reportID = $repID and year(i.callDate) = $year group by i.reportID, i.statusGroup, i.statusCode, i.statusDetail~;

    # print "***MonthyQuery\n$query\n";
    my $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    for (my $i = 1; $i < 13; $i++) {
        $query = qq~Select sum(`count`) as calls, sum(talkTime + wrapTime), statusGroup, statusCode, statusDetail as HT from `TPS`.`inboundDispositionArchive` where year(callDate) = $year and month(callDate) = $i and reportID = $repID group by statusGroup, statusCode, statusDetail~;
        $sth = $dbMySQL1->prepare($query);
        $sth->execute();
        while (my ($count, $ht, $group, $code, $detail) = $sth->fetchrow()) {
            my $month = getMonthName($i);
            $query = qq~Update $tempTable set $month = $count, HandleTime = (HandleTime + $ht) where statusGroup = $group and statusCode = $code and statusDetail = $detail~;
            # print("*** q=$query\n");
            my $st2 = $dbMySQL1->prepare($query);
            $st2->execute();
            $st2->finish();
        }
    }

    $query = "Update $tempTable a inner join Snowfly b on a.statusGroup = b.statusGroup and a.statusCode = b.statusCode and a.statusDetail = b.statusDetail set a.Description = b.statusText";
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    $query = "Update $tempTable set Description = 'Other', statusGroup = 50, statusCode =1, statusDetail =2 where Description = '' or Description is null";
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    $query = "Update $tempTable set statusGroup = 0 where statusGroup = 49";
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    my $lstrow = inb_met_dispoMonthly($repID, $tempTable, $ws);

    $lstrow = inb_met_dispoTotalsMonthly($repID, $ws, $monday, $lstrow);
    $query = "Drop table if exists TPS.$tempTable";
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    $sth->finish();
}
sub inb_met_dispoMonthly {
    my $repID = $_[0];
    my $tmpTable = $_[1];
    my $ws = $_[2];
    my $querydesc = qq~SELECT Description FROM $tmpTable  order by statusGroup, statusCode, statusDetail~;
    # print "GetCRCs:\n$querydesc\n";
    my $sth = $dbMySQL1->prepare($querydesc);
    # get Other catagory
    my $query = qq~SELECT Description FROM $tmpTable  order by statusGroup, statusCode, statusDetail~;
    # Write Headings
    # print "Write Headers\n";
    my $row = 3;
    my $col = 0;
    $ws->set_row($row, 40);
    $ws->write($row, $col, 'Disposition', $formatTitleRow);
    $ws->set_column($col, $col, 30);
    $row++;
    $sth->execute();
    while (my $title = $sth->fetchrow()) {
        $ws->write($row, $col, $title, $formatTotRow);
        $row++;
    }

    $col++;
    my @Months = ('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December');

    my $daylist;
    foreach (@Months) {
        $row = 3;
        $ws->set_column($col, $col, 10);
        $ws->write($row, $col, $_, $formatTotRow);
        $row++;
        $query = qq~select $_ from $tmpTable order by statusGroup, statusCode, statusDetail~;
        if (!defined($daylist)) {
            $daylist = $_;
        } else {
            $daylist .= " + $_";
        }
        makeRows($row, $col, $query, $ws);
        $col++;
    }
    # make Total Column
    $query = qq~Select ($daylist) as mySum, HandleTime from $tmpTable order by statusGroup, statusCode, statusDetail~;
    # print "$daylist - - $query\n";
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    $row = 3;
    $ws->write($row, $col, 'Total', $formatTotRow);
    $ws->write($row++, ($col + 1), 'Avg Handle Time', $formatTotRow);
    $ws->set_column($col, ($col + 1), 12);
    while (my ($total, $ht) = $sth->fetchrow()) {
        $ws->write($row, $col, $total, $formatTotRow);
        my $formula;
        if ($total > 0) {
            $formula = "=($ht/$total)/86400";
        } else {
            $formula = 0;
        }
        $ws->write($row, ($col + 1), $formula, $formatTimeTotals);
        $row++;
    }
    $sth->finish();
    return $row;
}
sub CreateTempDispoTableMonthly {
    # create Temp table for callstatus for comparison
    my $db = $_[0];
    my $repID = $_[1];
    my $tempTable = $repID . "_inboundMetricsDispoTempMonthly";
    my $query = "Show Tables like '$tempTable'";
    my $sth = $db->prepare($query);
    my $result = $sth->execute();
    if ($result != 0) {
        $query = "Drop table if exists TPS.$tempTable";
        $sth = $db->prepare($query);
        $sth->execute();
    }
    $query = qq~CREATE  TABLE `TPS`.`$tempTable` (
  `id` INT NOT NULL AUTO_INCREMENT ,
  `reportID` INT NOT NULL DEFAULT 0 ,
  `description` VARCHAR(100) NOT NULL ,
  `statusGroup` INT NOT NULL DEFAULT 0 ,
  `statusCode` INT NOT NULL DEFAULT 0 ,
  `statusDetail` INT NOT NULL DEFAULT 0 ,
    `January` INT NOT NULL DEFAULT 0 ,
    `February` INT NOT NULL DEFAULT 0 ,
    `March` INT NOT NULL DEFAULT 0 ,
    `April` INT NOT NULL DEFAULT 0 ,
    `May` INT NOT NULL DEFAULT 0 ,
    `June` INT NOT NULL DEFAULT 0 ,
    `July` INT NOT NULL DEFAULT 0 ,
    `August` INT NOT NULL DEFAULT 0 ,
    `September` INT NOT NULL DEFAULT 0 ,
    `October` INT NOT NULL DEFAULT 0 ,
    `November` INT NOT NULL DEFAULT 0 ,
    `December` INT NOT NULL DEFAULT 0 ,
  `HandleTime` INT NOT NULL DEFAULT 0 ,
  PRIMARY KEY (`id`) );~;
    $sth = $db->prepare($query);
    $sth->execute();
    $sth->finish();
    return $tempTable;
}
sub inb_met_dispoTotalsMonthly {
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = date $_[2];
    my $startRow = $_[3];
    my $col = 0;
    my $row = $startRow;
    # titles
    $ws->write($row++, $col, 'Total', $formatTotRow);
    $ws->write($row++, $col, 'Total Calls', $formatTotRow);
    $ws->write($row++, $col, 'Total Handled', $formatTotRow);
    $row++;
    $ws->write($row++, $col, 'PIA %', $formatTotRow);
    $ws->write($row++, $col, 'EZ Pay %', $formatTotRow);
    $ws->write($row++, $col, 'Save %', $formatTotRow);
    $ws->write($row++, $col, 'Vacation %', $formatTotRow);
    $ws->write($row++, $col, 'Answer %', $formatTotRow);
    $ws->write($row++, $col, 'Avg Handle Time', $formatTotRow);
    # Insert Talk, Wrap and emails
    $ws->write($row++, $col, 'Avg Talk Time', $formatTotRow);
    $ws->write($row++, $col, 'Avg Wrap Time', $formatTotRow);
    $ws->write($row++, $col, 'Emails Collected', $formatTotRow);
    $ws->write($row++, $col, 'Emails %', $formatTotRow);
    $ws->write($row++, $col, 'New Start Emails Collected', $formatTotRow);
    $ws->write($row++, $col, 'New Start Emails %', $formatTotRow);
    $ws->write($row++, $col, 'Emails Declined', $formatTotRow);
    $ws->write($row++, $col, 'Emails Already On File', $formatTotRow);
    # end insert
    $ws->write($row++, $col, 'ASA', $formatTotRow);
    $ws->write($row++, $col, '% Calls Answered In', $formatTotRow);
    $ws->write($row++, $col, '25 Seconds', $formatTotRow);
    $ws->write($row++, $col, '30 Seconds', $formatTotRow);
    $ws->write($row++, $col, '45 Seconds', $formatTotRow);
    $ws->write($row++, $col++, '60 Seconds', $formatTotRow);
    my $year = $date->year;
    # days of week
    for ($i = 1; $i < 13; $i++) {
        $row = $startRow;
        # All calls
        $query = "Select sum(`count`) from `TPS`.`inboundDispositionArchive` where month(callDate) = $i and year(callDate) = $year and reportID = $repID";
        # print "$query\n";
        my $totalcalls = getcount($query);
        $ws->set_column($col, $col, 10);
        $ws->write($row++, $col, $totalcalls, $formatnumTotals); # total Calls
        # print "\nTotalCalls:$totalcalls";
        my $basequery = qq~SELECT sum(`count`) FROM TPS.`inboundDispositionArchive` a inner join Snowfly b on a.statusgroup = b.statusgroup and a.statuscode = b.statuscode and a.statusdetail = b.statusdetail
                      where reportID = $repID and month(callDate) = $i and year(callDate) = $year~;
        $query = $basequery . " And agentOffered !=0";
        # print "$query\n";
        my $agentOffered = getcount($query);
        # print " agentoffered:$agentOffered";
        $ws->write($row++, $col, $agentOffered, $formatnumTotals); # agent offerred
        $query = $basequery . " And agentOffered =1";
        my $agentHandled = getcount($query);
        # print "$query\n";
        # print " agenthandled:$agentHandled\n";
        $ws->write($row++, $col, $agentHandled, $formatnumTotals); # agent answered
        $row++;
        $query = $basequery . " And paidInAdvance =1";
        my $piaNum = getcount($query);
        $query = $basequery . " And paidInAdvance !=0";
        my $piaDenom = getcount($query);
        my $tmp = checkDenom($piaNum, $piaDenom);
        # print "PIA $piaNum,$piaDenom, $tmp\n";
        $ws->write($row++, $col, $tmp, $formatPercentTotals); # pia %
        $query = $basequery . " And ezPay !=0";
        my $ezPayDenom = getcount($query);
        $query = $basequery . " And ezPay =1";
        my $ezPayNum = getcount($query);
        $tmp = checkDenom($ezPayNum, $ezPayDenom);
        $ws->write($row++, $col, $tmp, $formatPercentTotals); # EZ Pay %
        $query = $basequery . " And stopSave =1";
        my $stopNum = getcount($query);
        $query = $basequery . " And stopSave !=0";
        my $stopDenom = getcount($query);
        $tmp = checkDenom($stopNum, $stopDenom);
        $ws->write($row++, $col, $tmp, $formatPercentTotals); # Stop SAve%
        $query = $basequery . " And vacationSave !=0";
        my $vacDenom = getcount($query);
        $query = $basequery . " And vacationSave =1";
        my $vacNum = getcount($query);
        $tmp = checkDenom($vacNum, $vacDenom);
        $ws->write($row++, $col, $tmp, $formatPercentTotals); # VAc Pac%
        $tmp = checkDenom($agentHandled, $agentOffered);
        $ws->write($row++, $col, $tmp, $formatPercentTotals); # Anser %
        $query = "Select sum(talkTime + wrapTime) from `TPS`.`inboundDispositionArchive` where month(callDate) = $i and year(callDate) = $year and reportID = $repID";
        my $avgHT = checkDenom(getcount($query), $agentHandled);
        $tmp = qq~=($avgHT)/86400~;
        # print "\n*****$tmp****\n";
        $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Handle
        $query = "Select sum(talkTime) from `TPS`.`inboundDispositionArchive` where month(callDate) = $i and year(callDate) = $year and reportID = $repID";
        my $avgTK = checkDenom(getcount($query), $agentHandled);
        $tmp = qq~=($avgTK)/86400~;
        $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Talk
        $query = "Select sum(wrapTime) from `TPS`.`inboundDispositionArchive` where month(callDate) = $i and year(callDate) = $year and reportID = $repID";
        my $avgWRAP = checkDenom(getcount($query), $agentHandled);
        $tmp = qq~=($avgWRAP)/86400~;
        $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Wrap
        $query = "Select sum(emails), sum(declinedEmail), sum(emailOnFile)from `TPS`.`inboundDispositionArchive` where month(callDate) = $i and year(callDate) = $year and reportID = $repID";
        my $sth = $dbMySQL1->prepare($query);
        my $result = $sth->execute();
        my ($email, $declinedEmail, $emailOnFile) = 0;
        if ($result != 0) {
            ($email, $declinedEmail, $emailOnFile) = $sth->fetchrow();
        }
        $ws->write($row++, $col, $email, $formatnumTotals); # emails collected
        $tmp = checkDenom($email, $agentHandled);
        $ws->write($row++, $col, $tmp, $formatPercentTotals);
        $query = qq~SELECT sum(emails) FROM TPS.`inboundDispositionArchive` a inner join Snowfly b on a.statusgroup = b.statusgroup and a.statuscode = b.statuscode and a.statusdetail = b.statusdetail
                      where reportID = $repID and month(callDate) = $i and year(callDate) = $year  And paidInAdvance !=0~;
        my $saleEmail = getcount($query);
        $ws->write($row++, $col, $saleEmail, $formatnumTotals); # emails on sales
        $tmp = checkDenom($saleEmail, $piaDenom);
        $ws->write($row++, $col, $tmp, $formatPercentTotals);
        $ws->write($row++, $col, $declinedEmail, $formatnumTotals);
        $ws->write($row++, $col, $emailOnFile, $formatnumTotals);
        $query = "Select sum(waitTime) from `TPS`.`inboundDispositionArchive` where month(callDate) = $i and year(callDate) = $year and reportID = $repID";
        my $avgWAIT = checkDenom(getcount($query), $agentHandled);
        $tmp = qq~=($avgWAIT)/86400~;
        $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Wait
        $query = qq~select sum(25n), sum(30n), sum(45n), sum(60n), sum(denominator) from  TPS.inboundMetricsServiceLevel where reportID = $repID and month(callDate) = $i and year(callDate) = $year~;
        my ($ap25, $ap30, $ap45, $ap60, $denom) = 0;
        $sth = $dbMySQL1->prepare($query);
        $result = $sth->execute();
        if ($result != 0) {
            ($ap25, $ap30, $ap45, $ap60, $denom) = $sth->fetchrow();
            if ($denom > 0) {
                $ap25 = $ap25 / $denom;
                $ap30 = $ap30 / $denom;
                $ap45 = $ap45 / $denom;
                $ap60 = $ap60 / $denom;
            }
        }
        $row++;
        $ws->write($row++, $col, $ap25, $formatPercentTotals); # Average Wait
        $ws->write($row++, $col, $ap30, $formatPercentTotals); # Average Wait
        $ws->write($row++, $col, $ap45, $formatPercentTotals); # Average Wait
        $ws->write($row++, $col, $ap60, $formatPercentTotals); # Average Wait
        $col++;
    }
    # totals column
    # add 6 to monday to come up with the end of the week
    # my $Sun = $Mon+'6D';
    my $beginweek = firstdayofyear($date);
    my $endweek = lastdayofyear($date);
    # copy and paste from above
    $row = $startRow;
    # add full week range to all queries
    # All calls
    $query = "Select sum(`count`) from `TPS`.`inboundDispositionArchive` where callDate >= '$beginweek' and callDate <= '$endweek' and reportID = $repID";
    # print "$query\n";
    my $totalcalls = getcount($query);
    $ws->write($row++, $col, $totalcalls, $formatnumTotals); # total Calls
    # print "\nTotalCalls:$totalcalls";
    my $basequery = qq~SELECT sum(`count`) FROM TPS.`inboundDispositionArchive` a inner join Snowfly b on a.statusgroup = b.statusgroup and a.statuscode = b.statuscode and a.statusdetail = b.statusdetail
                  where reportID = $repID and callDate >= '$beginweek' and callDate <= '$endweek'~;
    $query = $basequery . " And agentOffered !=0";
    # print "$query\n";
    my $agentOffered = getcount($query);
    # print " agentoffered:$agentOffered\n";
    $ws->write($row++, $col, $agentOffered, $formatnumTotals); # agent offerred
    $query = $basequery . " And agentOffered =1";
    my $agentHandled = getcount($query);
    # print "$query\n";
    # print " agenthandled:$agentHandled\n";
    $ws->write($row++, $col, $agentHandled, $formatnumTotals); # agent answered
    $row++;
    $query = $basequery . " And paidInAdvance =1";
    my $piaNum = getcount($query);
    $query = $basequery . " And paidInAdvance !=0";
    my $piaDenom = getcount($query);
    my $tmp = checkDenom($piaNum, $piaDenom);
    # print "PIA $piaNum,$piaDenom, $tmp\n";
    $ws->write($row++, $col, $tmp, $formatPercentTotals); # pia %
    $query = $basequery . " And ezPay !=0";
    my $ezPayDenom = getcount($query);
    $query = $basequery . " And ezPay =1";
    my $ezPayNum = getcount($query);
    $tmp = checkDenom($ezPayNum, $ezPayDenom);
    $ws->write($row++, $col, $tmp, $formatPercentTotals); # EZ Pay %
    $query = $basequery . " And stopSave =1";
    my $stopNum = getcount($query);
    $query = $basequery . " And stopSave !=0";
    my $stopDenom = getcount($query);
    $tmp = checkDenom($stopNum, $stopDenom);
    $ws->write($row++, $col, $tmp, $formatPercentTotals); # Stop SAve%
    $query = $basequery . " And vacationSave !=0";
    my $vacDenom = getcount($query);
    $query = $basequery . " And vacationSave =1";
    my $vacNum = getcount($query);
    $tmp = checkDenom($vacNum, $vacDenom);
    $ws->write($row++, $col, $tmp, $formatPercentTotals); # VAc Pac%
    $tmp = checkDenom($agentHandled, $agentOffered);
    $ws->write($row++, $col, $tmp, $formatPercentTotals); # Anser %
    $query = "Select sum(talkTime + wrapTime) from `TPS`.`inboundDispositionArchive` where callDate >= '$beginweek' and callDate <= '$endweek' and reportID = $repID";
    my $avgHT = checkDenom(getcount($query), $agentHandled);
    $tmp = qq~=($avgHT)/86400~;
    # print "\n*****$tmp****\n";
    $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Handle
    $query = "Select sum(talkTime) from `TPS`.`inboundDispositionArchive` where callDate >= '$beginweek' and callDate <= '$endweek' and reportID = $repID";
    my $avgTK = checkDenom(getcount($query), $agentHandled);
    $tmp = qq~=($avgTK)/86400~;
    $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Talk
    $query = "Select sum(wrapTime) from `TPS`.`inboundDispositionArchive` where callDate >= '$beginweek' and callDate <= '$endweek' and reportID = $repID";
    my $avgWRAP = checkDenom(getcount($query), $agentHandled);
    $tmp = qq~=($avgWRAP)/86400~;
    $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Wrap
    $query = "Select sum(emails), sum(declinedEmail), sum(emailOnFile)from `TPS`.`inboundDispositionArchive` where callDate >= '$beginweek' and callDate <= '$endweek' and reportID = $repID";
    my $sth = $dbMySQL1->prepare($query);
    my $result = $sth->execute();
    my ($email, $declinedEmail, $emailOnFile) = 0;
    if ($result != 0) {
        ($email, $declinedEmail, $emailOnFile) = $sth->fetchrow();
    }
    $ws->write($row++, $col, $email, $formatnumTotals); # emails collected
    $tmp = checkDenom($email, $agentHandled);
    $ws->write($row++, $col, $tmp, $formatPercentTotals);
    $query = qq~SELECT sum(emails) FROM TPS.`inboundDispositionArchive` a inner join Snowfly b on a.statusgroup = b.statusgroup and a.statuscode = b.statuscode and a.statusdetail = b.statusdetail
                  where reportID = $repID and callDate >= '$beginweek' and callDate <= '$endweek'  And paidInAdvance !=0~;
    my $saleEmail = getcount($query);
    $ws->write($row++, $col, $saleEmail, $formatnumTotals); # emails on sales
    $tmp = checkDenom($saleEmail, $piaDenom);
    $ws->write($row++, $col, $tmp, $formatPercentTotals);
    $ws->write($row++, $col, $declinedEmail, $formatnumTotals);
    $ws->write($row++, $col, $emailOnFile, $formatnumTotals);
    $query = "Select sum(waitTime) from `TPS`.`inboundDispositionArchive` where callDate >= '$beginweek' and callDate <= '$endweek' and reportID = $repID";
    my $avgWAIT = checkDenom(getcount($query), $agentHandled);
    $tmp = qq~=($avgWAIT)/86400~;
    $ws->write($row++, $col, $tmp, $formatTimeTotals); # Average Wait
    # service level changes drastically
    $query = qq~select sum(25n), sum(30n), sum(45n), sum(60n), sum(denominator) from  TPS.inboundMetricsServiceLevel where reportID = $repID and callDate >= '$beginweek' and callDate <= '$endweek'~;
    my ($ap25, $ap30, $ap45, $ap60, $denom) = 0;
    $sth = $dbMySQL1->prepare($query);
    $result = $sth->execute();
    if ($result != 0) {
        ($ap25, $ap30, $ap45, $ap60, $denom) = $sth->fetchrow();
        if ($denom > 0) {
            $ap25 = $ap25 / $denom;
            $ap30 = $ap30 / $denom;
            $ap45 = $ap45 / $denom;
            $ap60 = $ap60 / $denom;
        }
    }
    $row++;
    $ws->write($row++, $col, $ap25, $formatPercentTotals); # Average Wait
    $ws->write($row++, $col, $ap30, $formatPercentTotals); # Average Wait
    $ws->write($row++, $col, $ap45, $formatPercentTotals); # Average Wait
    $ws->write($row++, $col, $ap60, $formatPercentTotals); # Average Wait
}
sub callbackMetrics {
    my $repID = $_[0];
    my $ws = $_[1];
    my $date = $_[2];
    my $tz = $_[3];
    my $mtOffSet = getMToffset($tz);
    $row = 3;
    $col = 0;
    # First We make the Title Row
    $ws->set_row($row, 40);
    $ws->write($row, $col, 'Time Period', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Callbacks Scheduled', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Callbacks Made', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Avg Time to 1st Attempt', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, 'Callback Attempts', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;
    $ws->write($row, $col, '% Callback Attempted', $formatTitleRow);
    $ws->set_column($col, $col, 13);
    $col++;


    my $tmpFday = isodate($date);
    my $tmpEday = isodate($date . '1D');
    my $query = qq~SELECT `dateTimeStart`,`dateTimeEnd`,`reportID`,`callBackSched`,`callBackMade`,`callBackAttempted`,`callBackFirstAttNumerator`,`callBackFirstAttDenominator` FROM TPS.inboundDistribution where reportID = $repID and dateTimeStart >= '$tmpFday' and dateTimeStart < '$tmpEday' order by dateTimeStart~;
    my $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    my $tSched, $tMade, $tAtt, $tNum, $tDen;
    while (my ($dateStart, $dateEnd, $repId, $cbSched, $cbMade, $cbAtt, $numerator, $denomenator) = $sth->fetchrow()) {
        $col = 0;
        $row++;
        my $date1 = date($dateStart);
        my $date2 = date($dateEnd);
        my $label = getTimeforLabel($date1->hour + $mtOffSet, $date1->min) . " - " . getTimeforLabel($date2->hour + $mtOffSet, $date2->min);
        $ws->write($row, $col++, $label, $formattextleft);
        $ws->write($row, $col++, $cbSched, $formatnum);
        $ws->write($row, $col++, $cbMade, $formatnum);
        if ($denomenator > 0) {
            my $avgTime = $numerator / $denomenator;
            $ws->write_date_time($row, $col++, &gettime_4excel($avgTime), $formatTime);
        } else {
            $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTime);
        }
        $ws->write($row, $col++, $cbAtt, $formatnum);
        # if($cbSched>0){
        $ws->write($row, $col++, checkDenom($cbAtt, $cbSched), $formatPercent);

        $tSched += $cbSched;
        $tMade += $cbMade;
        $tAtt += $cbAtt;
        $tNum += $numerator;
        $tDen += $denomenator;
    }
    # totals
    $row++;
    $col = 0;
    $ws->write($row, $col++, 'Totals', $formatTotRow);
    $ws->write($row, $col++, $tSched, $formatnumTotals);
    $ws->write($row, $col++, $tMade, $formatnumTotals);
    if ($tDen > 0) {
        my $avgTime = $tNum / $tDen;
        $ws->write_date_time($row, $col++, &gettime_4excel($avgTime), $formatTimeTotals);
    } else {
        $ws->write_date_time($row, $col++, &gettime_4excel(0), $formatTimeTotals);
    }
    $ws->write($row, $col++, $tAtt, $formatnumTotals);
    $ws->write($row, $col++, checkDenom($tAtt, $tSched), $formatPercentTotals);
    $row = 2;
    $col = 7;
    $ws->merge_range($row, $col, $row, ($col + 1), 'Unreachable Callbacks', $formatTitleRowGrayMerged);
    # $ws->write($row, $col, 'Unreachable Callbacks', $formatTitleRow);
    # $ws->set_column($col,$col,13);
    $row++;
    $ws->write($row, $col, 'Phone Number', $formatTitleRow);
    $ws->set_column($col, $col++, 13);
    $ws->write($row, $col, 'Last Attempt', $formatTitleRow);
    $ws->set_column($col, $col++, 13);
    $ws->write($row, $col, 'Status Text', $formatTitleRow);
    $ws->set_column($col, $col++, 26);
    $query = qq~Select * from TPS.inbCallbacks where reportID = $repID and reportDate >= '$tmpFday' and reportDate < '$tmpEday' order by callLocalTime~;
    $sth = $dbMySQL1->prepare($query);
    $sth->execute();
    while (my ($id, $tel, $repid, $callLocalTime, $reportDate, $statusText) = $sth->fetchrow()) {
        $row++;
        $col = 7;
        my $date1 = date($callLocalTime);
        $ws->write($row, $col++, $tel, $formattextleft);
        $ws->write($row, $col++, getTimeforLabel($date1->hour + $mtOffSet, $date1->min), $formatTimeHM);
        $ws->write($row, $col++, $statusText, $formattextleft);
    }
    $sth->finish();
}
</pre>
</body>
</html>